<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Subscription – HomeProHub</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="components/navigation.css" />
  <!-- Supabase Auth -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/services/auth.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f9fafb;
      color: #111827;
      line-height: 1.6;
    }

    .page-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 24px 80px;
    }

    .page-header {
      text-align: center;
      margin-bottom: 48px;
    }

    .page-header h1 {
      font-size: 40px;
      font-weight: 800;
      margin-bottom: 12px;
      color: #111827;
    }

    .page-header p {
      font-size: 18px;
      color: #6b7280;
    }

    .current-plan-banner {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      padding: 20px 32px;
      border-radius: 12px;
      margin-bottom: 48px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
    }

    .current-plan-info h3 {
      font-size: 16px;
      font-weight: 600;
      opacity: 0.9;
      margin-bottom: 4px;
    }

    .current-plan-name {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .current-plan-price {
      font-size: 16px;
      opacity: 0.9;
    }

    .manage-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s;
    }

    .manage-link:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }

    /* Pricing Grid - Reusing Landing Page Style */
    .pricing-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 32px;
      margin-bottom: 48px;
    }

    .pricing-card {
      background: white;
      border-radius: 16px;
      padding: 40px 32px;
      border: 2px solid #e5e7eb;
      position: relative;
      transition: all 0.3s;
    }

    .pricing-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(59, 130, 246, 0.2);
      border-color: #3b82f6;
    }

    .pricing-card.current-tier {
      border: 3px solid #3b82f6;
      background: linear-gradient(to bottom, #eff6ff, white);
    }

    .pricing-card.current-tier::before {
      content: 'CURRENT PLAN';
      position: absolute;
      top: -16px;
      left: 50%;
      transform: translateX(-50%);
      background: #3b82f6;
      color: white;
      padding: 6px 20px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    .pricing-card.featured {
      border: 3px solid #10b981;
      transform: scale(1.05);
    }

    .pricing-card.featured:not(.current-tier)::before {
      content: 'MOST POPULAR';
      position: absolute;
      top: -16px;
      left: 50%;
      transform: translateX(-50%);
      background: #10b981;
      color: white;
      padding: 6px 20px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    .pricing-tier {
      font-size: 14px;
      color: #6b7280;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 12px;
    }

    .pricing-price {
      font-size: 48px;
      font-weight: 800;
      color: #111827;
      margin-bottom: 8px;
    }

    .pricing-price span {
      font-size: 18px;
      color: #6b7280;
      font-weight: 500;
    }

    .pricing-roi {
      background: #ecfdf5;
      color: #065f46;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 700;
      margin: 20px 0;
      text-align: center;
    }

    .pricing-features {
      list-style: none;
      margin: 28px 0;
    }

    .pricing-features li {
      padding: 10px 0;
      color: #374151;
      font-size: 15px;
      padding-left: 28px;
      position: relative;
      line-height: 1.5;
    }

    .pricing-features li::before {
      content: '✓';
      position: absolute;
      left: 0;
      color: #10b981;
      font-weight: 700;
      font-size: 18px;
    }

    .pricing-cta {
      width: 100%;
      padding: 14px 24px;
      background: #3b82f6;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 24px;
    }

    .pricing-cta:hover:not(:disabled) {
      background: #2563eb;
    }

    .pricing-cta:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .pricing-cta.downgrade {
      background: #6b7280;
    }

    .pricing-cta.downgrade:hover {
      background: #4b5563;
    }

    .pricing-cta.cancel {
      background: transparent;
      color: #ef4444;
      border: 2px solid #ef4444;
    }

    .pricing-cta.cancel:hover {
      background: #fef2f2;
    }

    .pricing-card.featured .pricing-cta {
      background: #10b981;
    }

    .pricing-card.featured .pricing-cta:hover:not(:disabled) {
      background: #059669;
    }

    .pay-per-lead-callout {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      border: 3px solid #d97706;
      border-radius: 12px;
      padding: 32px;
      text-align: center;
      color: white;
    }

    .pay-per-lead-callout h3 {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 12px;
    }

    .pay-per-lead-callout p {
      font-size: 16px;
      color: #78350f;
      margin-bottom: 20px;
    }

    .pay-per-lead-callout .pricing-cta {
      background: #1f2937;
      color: white;
      max-width: 300px;
      margin: 20px auto 0;
    }

    .pay-per-lead-callout .pricing-cta:hover {
      background: #111827;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .pricing-grid {
        grid-template-columns: 1fr;
        gap: 24px;
      }

      .pricing-card.featured {
        transform: scale(1);
      }

      .current-plan-banner {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }

      .page-header h1 {
        font-size: 32px;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation component will be injected here by navigation.js -->

  <div class="page-container">
    <div class="page-header">
      <h1>Manage Subscription</h1>
      <p>Upgrade, downgrade, or cancel your plan anytime. No long-term commitments.</p>
    </div>

    <!-- Current Plan Banner -->
    <div class="current-plan-banner" id="currentPlanBanner">
      <div class="current-plan-info">
        <h3>Your Current Plan</h3>
        <div class="current-plan-name" id="currentPlanName">Pro</div>
        <div class="current-plan-price" id="currentPlanPrice">$49/month</div>
      </div>
      <a href="contractor-profile.html#billing" class="manage-link">
        <span>⚙️</span>
        <span>Billing Settings</span>
      </a>
    </div>

    <!-- Pricing Grid -->
    <div class="pricing-grid">
      <!-- Starter Tier -->
      <div class="pricing-card" id="starterCard">
        <div class="pricing-tier">Starter</div>
        <div class="pricing-price">FREE</div>
        <p style="color: #6b7280; margin-bottom: 20px;">Get started with basic access</p>

        <ul class="pricing-features">
          <li>View job postings in your area</li>
          <li>2 bids per month</li>
          <li>See homeowner grades</li>
          <li>Basic profile listing</li>
          <li>Community forum access</li>
        </ul>

        <button class="pricing-cta downgrade" id="starterBtn" onclick="changePlan('starter')">
          Downgrade to Starter
        </button>
      </div>

      <!-- Pro Tier (Featured) -->
      <div class="pricing-card featured" id="proCard">
        <div class="pricing-tier">Pro</div>
        <div class="pricing-price">$49<span>/month</span></div>
        <div class="pricing-roi">Avg member wins $15k/mo in projects</div>

        <ul class="pricing-features">
          <li><strong>Unlimited bids</strong></li>
          <li>AI Estimate Tool access</li>
          <li>Priority support</li>
          <li>Advanced analytics dashboard</li>
          <li>Download estimates as PDF</li>
          <li>Verified Badge for licensed pros</li>
          <li>Email & SMS notifications</li>
        </ul>

        <button class="pricing-cta" id="proBtn" disabled>
          Current Plan
        </button>
      </div>

      <!-- Premium Tier -->
      <div class="pricing-card" id="premiumCard">
        <div class="pricing-tier">Premium</div>
        <div class="pricing-price">$149<span>/month</span></div>
        <div class="pricing-roi">Avg member wins $40k/mo in projects</div>

        <ul class="pricing-features">
          <li><strong>Everything in Pro, plus:</strong></li>
          <li>Priority ranking in search results</li>
          <li>Owner's Advocate referrals</li>
          <li>Project management tools</li>
          <li>Branded estimate templates</li>
          <li>Client communication hub</li>
          <li>Dedicated account manager</li>
          <li>Early access to new features</li>
        </ul>

        <button class="pricing-cta" id="premiumBtn" onclick="changePlan('premium')">
          Upgrade to Premium
        </button>
      </div>
    </div>

    <!-- Pay-Per-Lead Option -->
    <div class="pay-per-lead-callout">
      <h3>Pay-Per-Lead Option</h3>
      <p>No monthly fees. Only pay when you access a qualified lead.</p>
      <p style="font-size: 18px; font-weight: 700; color: white; margin-bottom: 20px;">
        $15–$30 per lead (varies by market and trade)
      </p>
      <button class="pricing-cta" onclick="switchToPayPerLead()">Switch to Pay-Per-Lead</button>
    </div>
  </div>

  <script src="components/navigation.js"></script>
  <script>
    let currentTier = 'pro'; // Default to pro, will be fetched from API

    // Load current subscription from profile
    async function loadCurrentSubscription() {
      try {
        // Wait for auth service
        if (!window.authService || !window.authService.initialized) {
          await new Promise(resolve => {
            const checkAuth = setInterval(() => {
              if (window.authService && window.authService.initialized) {
                clearInterval(checkAuth);
                resolve();
              }
            }, 100);
          });
        }

        const user = await window.authService.getCurrentUser();
        if (!user) {
          window.location.href = 'index.html';
          return;
        }

        const profile = await window.authService.getUserProfile();
        if (!profile || profile.role !== 'contractor') {
          window.location.href = 'index.html';
          return;
        }

        // Get subscription tier from profile (default to 'starter' if not set)
        currentTier = (profile.subscription_tier || 'starter').toLowerCase();

        // Update UI based on current tier
        updateUIForCurrentTier(currentTier);

      } catch (error) {
        console.error('Error loading subscription:', error);
        // Default to starter if error
        currentTier = 'starter';
        updateUIForCurrentTier('starter');
      }
    }

    function updateUIForCurrentTier(tier) {
      // Remove all current-tier classes
      document.querySelectorAll('.pricing-card').forEach(card => {
        card.classList.remove('current-tier');
      });

      // Update current plan banner
      const planNames = {
        'starter': 'Starter',
        'pro': 'Pro',
        'premium': 'Premium'
      };

      const planPrices = {
        'starter': 'Free',
        'pro': '$49/month',
        'premium': '$149/month'
      };

      document.getElementById('currentPlanName').textContent = planNames[tier] || 'Starter';
      document.getElementById('currentPlanPrice').textContent = planPrices[tier] || 'Free';

      // Add current-tier class to the right card
      const cardMap = {
        'starter': 'starterCard',
        'pro': 'proCard',
        'premium': 'premiumCard'
      };

      const currentCard = document.getElementById(cardMap[tier]);
      if (currentCard) {
        currentCard.classList.add('current-tier');
      }

      // Update all buttons
      const starterBtn = document.getElementById('starterBtn');
      const proBtn = document.getElementById('proBtn');
      const premiumBtn = document.getElementById('premiumBtn');

      // Reset all buttons
      starterBtn.disabled = false;
      proBtn.disabled = false;
      premiumBtn.disabled = false;

      starterBtn.className = 'pricing-cta downgrade';
      proBtn.className = 'pricing-cta';
      premiumBtn.className = 'pricing-cta';

      starterBtn.textContent = 'Downgrade to Starter';
      proBtn.textContent = 'Upgrade to Pro';
      premiumBtn.textContent = 'Upgrade to Premium';

      // Set current plan button
      if (tier === 'starter') {
        starterBtn.disabled = true;
        starterBtn.textContent = 'Current Plan';
        starterBtn.className = 'pricing-cta';
        proBtn.textContent = 'Upgrade to Pro';
        premiumBtn.textContent = 'Upgrade to Premium';
      } else if (tier === 'pro') {
        proBtn.disabled = true;
        proBtn.textContent = 'Current Plan';
        starterBtn.textContent = 'Downgrade to Starter';
        starterBtn.className = 'pricing-cta downgrade';
        premiumBtn.textContent = 'Upgrade to Premium';
      } else if (tier === 'premium') {
        premiumBtn.disabled = true;
        premiumBtn.textContent = 'Current Plan';
        starterBtn.textContent = 'Downgrade to Starter';
        starterBtn.className = 'pricing-cta downgrade';
        proBtn.textContent = 'Downgrade to Pro';
        proBtn.className = 'pricing-cta downgrade';
      }
    }

    async function changePlan(newTier) {
      // Confirm change
      const tierNames = {
        'starter': 'Starter (Free)',
        'pro': 'Pro ($49/month)',
        'premium': 'Premium ($149/month)'
      };

      const confirmMessage = newTier > currentTier
        ? `Upgrade to ${tierNames[newTier]}?`
        : `Downgrade to ${tierNames[newTier]}? You'll lose access to premium features.`;

      if (!confirm(confirmMessage)) {
        return;
      }

      try {
        const response = await window.authService.authenticatedFetch(
          '/api/contractor/update-subscription',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tier: newTier })
          }
        );

        if (!response.ok) {
          throw new Error('Failed to update subscription');
        }

        alert('Subscription updated successfully!');
        currentTier = newTier;
        updateUIForCurrentTier(newTier);

      } catch (error) {
        console.error('Error updating subscription:', error);
        alert('Failed to update subscription. Please try again or contact support.');
      }
    }

    function switchToPayPerLead() {
      alert('Pay-per-lead option coming soon! Contact support@homeprohub.com for early access.');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadCurrentSubscription();
    });
  </script>
</body>
</html>
