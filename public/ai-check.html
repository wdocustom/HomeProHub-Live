<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Free AI Check ‚Äì HomeProHub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="components/navigation.css" />

  <!-- Supabase Auth -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/services/auth.js"></script>

  <style>
    body {
      background: #f8fafc;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }

    .page-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Image Upload Grid */
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .image-preview {
      position: relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #e5e7eb;
      background: #f9fafb;
    }

    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      line-height: 1;
    }

    .image-add {
      aspect-ratio: 1;
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      background: #f9fafb;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: #6b7280;
      transition: all 0.2s;
    }

    .image-add:hover {
      border-color: #3b82f6;
      background: #eff6ff;
      color: #3b82f6;
    }

    .image-add-icon {
      font-size: 32px;
    }

    .image-add-text {
      font-size: 13px;
      font-weight: 600;
    }

    /* Results Section */
    .results-container {
      display: none;
      margin-top: 32px;
    }

    .results-container.show {
      display: block;
    }

    .result-card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      margin-bottom: 24px;
    }

    .safety-banner {
      padding: 20px 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .safety-banner.urgent {
      background: #fef2f2;
      border: 2px solid #fca5a5;
      color: #991b1b;
    }

    .safety-banner.warning {
      background: #fef3c7;
      border: 2px solid #fde047;
      color: #92400e;
    }

    .safety-banner.safe {
      background: #f0fdf4;
      border: 2px solid #86efac;
      color: #166534;
    }

    .result-section {
      margin-bottom: 32px;
    }

    .result-section h3 {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e5e7eb;
    }

    .result-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .result-list li {
      padding: 12px 16px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      align-items: start;
      gap: 12px;
    }

    .result-list li::before {
      content: '‚Ä¢';
      font-size: 20px;
      font-weight: 700;
      color: #3b82f6;
      flex-shrink: 0;
    }

    .dont-list li::before {
      content: '‚úó';
      color: #ef4444;
    }

    .cta-section {
      margin-top: 32px;
      padding: 24px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-radius: 16px;
      text-align: center;
      color: white;
    }

    .cta-section h3 {
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 12px 0;
    }

    .cta-section p {
      font-size: 15px;
      margin: 0 0 20px 0;
      opacity: 0.95;
    }

    .cta-button {
      padding: 16px 32px;
      background: white;
      color: #2563eb;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .cta-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    /* Loading State */
    .loading-container {
      display: none;
      text-align: center;
      padding: 48px 24px;
    }

    .loading-container.show {
      display: block;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .confidence-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .confidence-badge.high {
      background: #d1fae5;
      color: #065f46;
    }

    .confidence-badge.medium {
      background: #fef3c7;
      color: #92400e;
    }

    .confidence-badge.low {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <div id="nav-container"></div>

  <div class="page-container">
    <!-- Header -->
    <div class="text-center mb-10">
      <h1 class="text-4xl font-extrabold text-slate-900 mb-4">Free AI Check</h1>
      <p class="text-lg text-slate-600">Upload photos or describe your issue for instant expert analysis</p>
    </div>

    <!-- Input Form -->
    <div class="result-card" id="inputForm">
      <h2 class="text-2xl font-bold text-slate-900 mb-6">What's the issue?</h2>

      <!-- Text Description -->
      <div class="mb-6">
        <label class="block text-sm font-semibold text-slate-700 mb-2">
          Describe the issue (optional)
        </label>
        <textarea
          id="descriptionInput"
          class="w-full p-4 border-2 border-slate-200 rounded-lg focus:border-blue-500 focus:outline-none resize-vertical"
          rows="3"
          placeholder="Example: Water stain on ceiling near bathroom, brown discoloration spreading..."
        ></textarea>
      </div>

      <!-- Photo Upload -->
      <div class="mb-6">
        <label class="block text-sm font-semibold text-slate-700 mb-2">
          Upload photos (up to 5)
        </label>
        <div class="image-grid" id="imageGrid">
          <!-- Images will be added here dynamically -->
          <div class="image-add" onclick="document.getElementById('fileInput').click()">
            <div class="image-add-icon">üì∏</div>
            <div class="image-add-text">Add Photo</div>
          </div>
        </div>
        <input type="file" id="fileInput" class="hidden" accept="image/*" multiple />
      </div>

      <!-- Submit Button -->
      <button
        id="submitBtn"
        class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-all duration-200 shadow-lg hover:shadow-xl"
      >
        Get Instant Analysis
      </button>

      <p class="text-sm text-slate-500 mt-4 text-center">
        Free ‚Ä¢ No account required ‚Ä¢ Results in ~30 seconds
      </p>
    </div>

    <!-- Loading State -->
    <div class="loading-container" id="loadingContainer">
      <div class="loading-spinner"></div>
      <p class="text-lg font-semibold text-slate-700">Analyzing your issue...</p>
      <p class="text-sm text-slate-500 mt-2">This may take 20-30 seconds</p>
    </div>

    <!-- Results Section -->
    <div class="results-container" id="resultsContainer">
      <!-- Dynamic results will be inserted here -->
    </div>
  </div>

  <script src="components/navigation.js"></script>

  <script>
    (function() {
      'use strict';

      const fileInput = document.getElementById('fileInput');
      const imageGrid = document.getElementById('imageGrid');
      const descriptionInput = document.getElementById('descriptionInput');
      const submitBtn = document.getElementById('submitBtn');
      const inputForm = document.getElementById('inputForm');
      const loadingContainer = document.getElementById('loadingContainer');
      const resultsContainer = document.getElementById('resultsContainer');

      let selectedImages = [];

      // Check for pre-populated data from Smart Composer (index.html)
      const prePopulatedDescription = sessionStorage.getItem('ai_check_description');
      const prePopulatedImages = sessionStorage.getItem('ai_check_images');

      if (prePopulatedDescription) {
        descriptionInput.value = prePopulatedDescription;
        sessionStorage.removeItem('ai_check_description');
      }

      if (prePopulatedImages) {
        try {
          selectedImages = JSON.parse(prePopulatedImages);
          renderImageGrid();
          sessionStorage.removeItem('ai_check_images');

          // Auto-submit if we have pre-populated data
          setTimeout(() => {
            submitBtn.click();
          }, 500);
        } catch (e) {
          console.error('Error parsing pre-populated images:', e);
        }
      }

      // Handle file selection
      fileInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);

        files.forEach(file => {
          if (selectedImages.length >= 5) {
            alert('Maximum 5 images allowed');
            return;
          }

          if (!file.type.startsWith('image/')) {
            alert('Please select only image files');
            return;
          }

          const reader = new FileReader();
          reader.onload = function(event) {
            selectedImages.push({
              data: event.target.result.split(',')[1], // Base64 without prefix
              type: file.type,
              url: event.target.result // For preview
            });
            renderImageGrid();
          };
          reader.readAsDataURL(file);
        });

        // Reset input
        fileInput.value = '';
      });

      // Render image grid
      function renderImageGrid() {
        // Clear existing previews (keep the add button)
        imageGrid.innerHTML = '';

        // Add image previews
        selectedImages.forEach((img, index) => {
          const preview = document.createElement('div');
          preview.className = 'image-preview';
          preview.innerHTML = `
            <img src="${img.url}" alt="Preview ${index + 1}" />
            <button class="image-remove" onclick="removeImage(${index})">√ó</button>
          `;
          imageGrid.appendChild(preview);
        });

        // Add the "Add Photo" button if less than 5 images
        if (selectedImages.length < 5) {
          const addBtn = document.createElement('div');
          addBtn.className = 'image-add';
          addBtn.onclick = () => fileInput.click();
          addBtn.innerHTML = `
            <div class="image-add-icon">üì∏</div>
            <div class="image-add-text">Add Photo</div>
          `;
          imageGrid.appendChild(addBtn);
        }
      }

      // Remove image (exposed globally for inline onclick)
      window.removeImage = function(index) {
        selectedImages.splice(index, 1);
        renderImageGrid();
      };

      // Submit handler
      submitBtn.addEventListener('click', async function() {
        const description = descriptionInput.value.trim();

        // Validation
        if (!description && selectedImages.length === 0) {
          alert('Please provide either a description or upload at least one photo');
          return;
        }

        // Show loading
        inputForm.style.display = 'none';
        loadingContainer.classList.add('show');
        resultsContainer.classList.remove('show');

        try {
          // Call API
          const response = await fetch('/api/ai-check', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              description,
              images: selectedImages.map(img => ({ data: img.data, type: img.type }))
            })
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'API request failed');
          }

          const result = await response.json();
          console.log('AI Check result:', result);

          // Display results
          displayResults(result.output);

        } catch (error) {
          console.error('Error:', error);
          alert(`Error: ${error.message}`);
          inputForm.style.display = 'block';
          loadingContainer.classList.remove('show');
        }
      });

      // Display results
      function displayResults(output) {
        loadingContainer.classList.remove('show');
        resultsContainer.classList.add('show');

        // Determine safety banner
        let bannerClass = 'safe';
        let bannerIcon = '‚úì';
        let bannerText = 'Safe to Proceed';

        if (output.diy_level === 'urgent' || output.safety_flags.some(f => f !== 'none')) {
          bannerClass = 'urgent';
          bannerIcon = '‚ö†Ô∏è';
          bannerText = 'Immediate Attention Required';
        } else if (output.diy_level === 'pro_recommended') {
          bannerClass = 'warning';
          bannerIcon = '‚ö†';
          bannerText = 'Professional Recommended';
        }

        let html = `
          <!-- Safety Banner -->
          <div class="safety-banner ${bannerClass}">
            <span style="font-size: 24px;">${bannerIcon}</span>
            <div>
              <div>${bannerText}</div>
              <div style="font-size: 13px; font-weight: 400; margin-top: 4px;">
                Confidence: <span class="confidence-badge ${output.confidence}">${output.confidence}</span>
              </div>
            </div>
          </div>

          <div class="result-card">
            <!-- Summary -->
            <div class="result-section">
              <h3>Summary</h3>
              <p class="text-slate-700 text-lg leading-relaxed">${escapeHtml(output.summary)}</p>
            </div>

            <!-- Likely Causes -->
            <div class="result-section">
              <h3>Likely Causes</h3>
              <ul class="result-list">
                ${output.likely_causes.map(cause => `
                  <li>
                    <div>
                      <div class="font-semibold text-slate-900">${escapeHtml(cause.cause)}</div>
                      <div class="text-sm text-slate-500 mt-1">Confidence: ${cause.confidence}</div>
                    </div>
                  </li>
                `).join('')}
              </ul>
            </div>

            <!-- Do Now -->
            <div class="result-section">
              <h3>Do Now</h3>
              <ul class="result-list">
                ${output.do_now.map(item => `<li>${escapeHtml(item)}</li>`).join('')}
              </ul>
            </div>

            <!-- Don't Do -->
            <div class="result-section">
              <h3>Don't Do</h3>
              <ul class="result-list dont-list">
                ${output.dont_do.map(item => `<li>${escapeHtml(item)}</li>`).join('')}
              </ul>
            </div>

            <!-- Who to Call -->
            <div class="result-section">
              <h3>Who to Call</h3>
              <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                <div class="font-semibold text-blue-900 mb-2">
                  Primary: ${formatTrade(output.who_to_call.primary_trade)}
                </div>
                ${output.who_to_call.secondary_trades && output.who_to_call.secondary_trades.length > 0 ? `
                  <div class="text-sm text-blue-700">
                    Also consider: ${output.who_to_call.secondary_trades.join(', ')}
                  </div>
                ` : ''}
              </div>
            </div>

            <!-- Cost Estimate -->
            <div class="result-section">
              <h3>Cost Estimate</h3>
              <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4">
                <div class="font-bold text-green-900 text-xl mb-2">
                  ${formatCostTier(output.cost_tier.tier)}
                </div>
                <div class="text-sm text-green-700">
                  ${escapeHtml(output.cost_tier.disclaimer)}
                </div>
              </div>
            </div>

            <!-- Safety Flags -->
            ${output.safety_flags.some(f => f !== 'none') ? `
              <div class="result-section">
                <h3>Safety Warnings</h3>
                <ul class="result-list">
                  ${output.safety_flags.filter(f => f !== 'none').map(flag => `
                    <li class="bg-red-50 text-red-900 font-semibold">${formatSafetyFlag(flag)}</li>
                  `).join('')}
                </ul>
              </div>
            ` : ''}

            <!-- Follow-up Question -->
            ${output.one_question ? `
              <div class="result-section">
                <h3>Follow-up Question</h3>
                <p class="text-slate-700 italic">${escapeHtml(output.one_question)}</p>
              </div>
            ` : ''}
          </div>

          <!-- CTA Section -->
          <div class="cta-section">
            <h3>${escapeHtml(output.cta.button_text)}</h3>
            <p>${escapeHtml(output.pro_message)}</p>
            <button class="cta-button" onclick="handleCTA('${output.cta.primary_action}', '${output.cta.route}')">
              ${escapeHtml(output.cta.button_text)}
            </button>
          </div>

          <!-- Start Over -->
          <div class="text-center mt-6">
            <button class="text-blue-600 hover:text-blue-700 font-semibold" onclick="resetForm()">
              ‚Üê Start Over
            </button>
          </div>
        `;

        resultsContainer.innerHTML = html;
      }

      // Handle CTA
      window.handleCTA = async function(action, route) {
        // Check if user is logged in
        const user = await window.authService?.getCurrentUser();

        if (action === 'browse_contractors') {
          window.location.href = route || 'browse-contractors.html';
        } else if (action === 'post_project') {
          if (user) {
            window.location.href = 'post-project.html';
          } else {
            sessionStorage.setItem('signup_role', 'homeowner');
            window.location.href = 'signup.html?intent=post_project';
          }
        } else if (action === 'schedule_inspection') {
          window.location.href = route || 'browse-contractors.html';
        } else {
          window.location.href = route || 'home.html';
        }
      };

      // Reset form
      window.resetForm = function() {
        selectedImages = [];
        descriptionInput.value = '';
        renderImageGrid();
        inputForm.style.display = 'block';
        loadingContainer.classList.remove('show');
        resultsContainer.classList.remove('show');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      // Helper functions
      function escapeHtml(text) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
      }

      function formatTrade(trade) {
        return trade.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      }

      function formatCostTier(tier) {
        const tiers = {
          'under_500': 'Under $500',
          '500_2k': '$500 - $2,000',
          '2k_10k': '$2,000 - $10,000',
          '10k_plus': '$10,000+',
          'unknown': 'Requires Inspection'
        };
        return tiers[tier] || tier;
      }

      function formatSafetyFlag(flag) {
        return flag.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      }

    })();
  </script>

  <script src="components/footer.js"></script>
</body>
</html>
