<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HomeProHub ‚Äì Contractor Profile</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="components/navigation.css">
  <!-- Supabase Auth -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/services/auth.js"></script>
  <style>
    .profile-container { max-width: 900px; margin: 40px auto; padding: 0 24px; }
    .profile-header { background: white; padding: 24px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e5e7eb; }
    .tab { padding: 12px 24px; cursor: pointer; border: none; background: none; font-size: 15px; color: #6b7280; transition: all 0.2s; }
    .tab.active { color: #2563eb; border-bottom: 2px solid #2563eb; margin-bottom: -2px; font-weight: 600; }
    .tab:hover { color: #2563eb; }
    .tab-content { display: none; background: white; padding: 32px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .tab-content.active { display: block; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .form-group-full { grid-column: 1 / -1; }
    @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <!-- Navigation component will be injected here by navigation.js -->

<div class="profile-container">
  <div class="profile-header">
    <h1 style="margin: 0 0 8px 0; font-size: 28px;">Contractor Profile</h1>
    <p style="margin: 0; color: #6b7280;">Manage your business information and settings</p>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('basic')">Basic Info</button>
    <button class="tab" onclick="switchTab('licensing')">Licensing & Verification</button>
    <button class="tab" onclick="switchTab('social')">Social Media</button>
  </div>

  <div id="basicTab" class="tab-content active">
    <h2 style="margin-top: 0;">Business Information</h2>
    <form id="profileForm" novalidate>
      <div class="form-grid">
        <div class="form-group">
          <label for="firstName">First Name</label>
          <input id="firstName" type="text" placeholder="John" maxlength="50" />
        </div>
        <div class="form-group">
          <label for="lastName">Last Name</label>
          <input id="lastName" type="text" placeholder="Doe" maxlength="50" />
        </div>
        <div class="form-group">
          <label for="businessName">Business Name</label>
          <input id="businessName" type="text" placeholder="ABC Construction Inc." maxlength="100" />
        </div>
        <div class="form-group">
          <label for="yearsInBusiness">Years in Business</label>
          <input id="yearsInBusiness" type="number" placeholder="5" min="0" max="100" />
        </div>
        <div class="form-group">
          <label for="licenseNumber">License Number</label>
          <input id="licenseNumber" type="text" placeholder="ABC-123456" maxlength="50" />
        </div>
        <div class="form-group">
          <label for="trade">Primary Trade</label>
          <select id="trade">
            <option value="">Select trade...</option>
            <option value="General Contractor">General Contractor</option>
            <option value="Mechanical Contractor">Mechanical Contractor</option>
            <option value="Plumber">Plumber</option>
            <option value="Electrician">Electrician</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group form-group-full">
          <label for="street">Street Address</label>
          <input id="street" type="text" placeholder="123 Main St" maxlength="200" />
        </div>
        <div class="form-group">
          <label for="city">City</label>
          <input id="city" type="text" placeholder="Springfield" maxlength="100" />
        </div>
        <div class="form-group">
          <label for="state">State</label>
          <input id="state" type="text" placeholder="IL" maxlength="2" />
        </div>
        <div class="form-group">
          <label for="zipCode">ZIP Code</label>
          <input id="zipCode" type="text" placeholder="62701" pattern="[0-9]{5}" maxlength="5" />
        </div>
      </div>
      <button type="submit" class="btn-primary" id="saveButton">Save Profile</button>
      <p id="statusMessage" style="margin-top: 12px; font-size: 14px;"></p>
    </form>
  </div>

  <div id="licensingTab" class="tab-content">
    <h2 style="margin-top: 0;">Professional Licensing & Verification</h2>

    <!-- License Status Banner -->
    <div id="licenseStatusBanner" style="margin-bottom: 24px; padding: 20px; border-radius: 8px; display: none;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <span id="licenseStatusIcon" style="font-size: 28px;"></span>
        <div style="flex: 1;">
          <div id="licenseStatusTitle" style="font-weight: 600; font-size: 16px; margin-bottom: 4px;"></div>
          <div id="licenseStatusMessage" style="font-size: 14px;"></div>
        </div>
      </div>
    </div>

    <!-- Get Licensed Prompt (for unlicensed contractors) -->
    <div id="getLicensedPrompt" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 24px; border-radius: 12px; margin-bottom: 24px; border: 2px solid #fbbf24; display: none;">
      <div style="display: flex; align-items: start; gap: 16px;">
        <span style="font-size: 48px;">üìú</span>
        <div style="flex: 1;">
          <h3 style="margin: 0 0 8px 0; color: #92400e; font-size: 20px;">Get Your Contractor License</h3>
          <p style="margin: 0 0 16px 0; color: #78350f; line-height: 1.6;">
            Want to bid on more jobs and build trust with homeowners? Getting licensed is easier than you think.
            We've partnered with <strong>ContractorTrainingCenter.com</strong> to help you get licensed fast.
          </p>
          <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <h4 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">‚úÖ Why Get Licensed?</h4>
            <ul style="margin: 0; padding-left: 20px; color: #374151; line-height: 1.8;">
              <li><strong>Win More Bids</strong> - Homeowners prefer licensed contractors</li>
              <li><strong>Higher Pay</strong> - Licensed contractors can charge premium rates</li>
              <li><strong>Legal Protection</strong> - Work legally in your jurisdiction</li>
              <li><strong>Verified Badge</strong> - Stand out with our ‚úì Verified badge on your profile</li>
              <li><strong>Priority Placement</strong> - Licensed contractors appear first in job matches</li>
            </ul>
          </div>
          <a href="https://www.contractortrainingcenter.com/?ref=homeprohub" target="_blank" rel="noopener"
             style="display: inline-block; background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white; padding: 14px 28px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 16px; transition: transform 0.2s;"
             onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            üéì Start Your Licensing Journey ‚Üí
          </a>
          <p style="margin: 12px 0 0 0; font-size: 13px; color: #9ca3af;">
            Special HomeProHub discount available through our partner link
          </p>
        </div>
      </div>
    </div>

    <!-- License Upload Form -->
    <form id="licenseForm" novalidate>
      <div style="background: #f9fafb; padding: 24px; border-radius: 8px; margin-bottom: 24px;">
        <h3 style="margin: 0 0 16px 0; font-size: 18px;">License Information</h3>

        <div class="form-grid">
          <div class="form-group">
            <label for="licState">License State *</label>
            <input id="licState" type="text" placeholder="e.g., CA, TX, FL" maxlength="2" style="text-transform: uppercase;" required />
          </div>
          <div class="form-group">
            <label for="licNumber">License Number *</label>
            <input id="licNumber" type="text" placeholder="ABC-123456" maxlength="50" required />
          </div>
          <div class="form-group">
            <label for="licType">License Type *</label>
            <select id="licType" required>
              <option value="">Select license type...</option>
              <option value="General Contractor">General Contractor (Class A/B)</option>
              <option value="Specialty Contractor">Specialty Contractor (Class C)</option>
              <option value="Electrical">Electrical Contractor</option>
              <option value="Plumbing">Plumbing Contractor</option>
              <option value="HVAC">HVAC Contractor</option>
              <option value="Roofing">Roofing Contractor</option>
              <option value="Other">Other Specialty</option>
            </select>
          </div>
          <div class="form-group">
            <label for="licExpiration">Expiration Date</label>
            <input id="licExpiration" type="date" />
          </div>
        </div>

        <div class="form-group form-group-full" style="margin-top: 20px;">
          <label for="licenseUpload" style="display: block; margin-bottom: 8px; font-weight: 600;">Upload License Document</label>
          <p style="margin: 0 0 12px 0; font-size: 14px; color: #6b7280;">
            Upload a clear photo or PDF of your contractor license. Accepted formats: JPG, PNG, PDF (max 5MB)
          </p>
          <div style="position: relative;">
            <input type="file" id="licenseUpload" accept="image/*,.pdf" style="display: none;" />
            <button type="button" onclick="document.getElementById('licenseUpload').click()"
                    style="background: white; border: 2px dashed #d1d5db; padding: 40px 20px; width: 100%; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 8px;"
                    onmouseover="this.style.borderColor='#2563eb'; this.style.background='#eff6ff'"
                    onmouseout="this.style.borderColor='#d1d5db'; this.style.background='white'">
              <span style="font-size: 48px;">üìÑ</span>
              <span style="font-weight: 600; color: #2563eb;">Click to Upload License Document</span>
              <span style="font-size: 14px; color: #6b7280;">or drag and drop file here</span>
            </button>
          </div>
          <div id="licensePreview" style="margin-top: 16px; display: none;">
            <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 32px;" id="licenseFileIcon">üìÑ</span>
              <div style="flex: 1;">
                <div style="font-weight: 600; color: #1f2937;" id="licenseFileName">filename.pdf</div>
                <div style="font-size: 14px; color: #6b7280;" id="licenseFileSize">1.2 MB</div>
              </div>
              <button type="button" onclick="clearLicenseUpload()"
                      style="background: #fee2e2; color: #991b1b; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Remove
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Insurance Information -->
      <div style="background: #f9fafb; padding: 24px; border-radius: 8px; margin-bottom: 24px;">
        <h3 style="margin: 0 0 16px 0; font-size: 18px;">Insurance Verification</h3>

        <div class="form-grid">
          <div class="form-group">
            <label for="insuranceProvider">Insurance Provider</label>
            <input id="insuranceProvider" type="text" placeholder="e.g., State Farm, Nationwide" maxlength="100" />
          </div>
          <div class="form-group">
            <label for="insurancePolicyNumber">Policy Number</label>
            <input id="insurancePolicyNumber" type="text" placeholder="POL-123456789" maxlength="50" />
          </div>
          <div class="form-group">
            <label for="insuranceExpiration">Expiration Date</label>
            <input id="insuranceExpiration" type="date" />
          </div>
          <div class="form-group">
            <label for="insuranceCoverage">Coverage Amount</label>
            <select id="insuranceCoverage">
              <option value="">Select coverage...</option>
              <option value="500000">$500,000</option>
              <option value="1000000">$1,000,000</option>
              <option value="2000000">$2,000,000</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

        <div class="form-group form-group-full" style="margin-top: 20px;">
          <label for="insuranceUpload" style="display: block; margin-bottom: 8px; font-weight: 600;">Upload Insurance Certificate</label>
          <p style="margin: 0 0 12px 0; font-size: 14px; color: #6b7280;">
            Upload your Certificate of Insurance (COI). Accepted formats: JPG, PNG, PDF (max 5MB)
          </p>
          <div style="position: relative;">
            <input type="file" id="insuranceUpload" accept="image/*,.pdf" style="display: none;" />
            <button type="button" onclick="document.getElementById('insuranceUpload').click()"
                    style="background: white; border: 2px dashed #d1d5db; padding: 40px 20px; width: 100%; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 8px;"
                    onmouseover="this.style.borderColor='#2563eb'; this.style.background='#eff6ff'"
                    onmouseout="this.style.borderColor='#d1d5db'; this.style.background='white'">
              <span style="font-size: 48px;">üõ°Ô∏è</span>
              <span style="font-weight: 600; color: #2563eb;">Click to Upload Insurance Certificate</span>
              <span style="font-size: 14px; color: #6b7280;">or drag and drop file here</span>
            </button>
          </div>
          <div id="insurancePreview" style="margin-top: 16px; display: none;">
            <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 32px;">üõ°Ô∏è</span>
              <div style="flex: 1;">
                <div style="font-weight: 600; color: #1f2937;" id="insuranceFileName">filename.pdf</div>
                <div style="font-size: 14px; color: #6b7280;" id="insuranceFileSize">1.2 MB</div>
              </div>
              <button type="button" onclick="clearInsuranceUpload()"
                      style="background: #fee2e2; color: #991b1b; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Remove
              </button>
            </div>
          </div>
        </div>
      </div>

      <button type="submit" class="btn-primary" id="saveLicenseButton">Save & Submit for Verification</button>
      <p id="licenseStatusMessage" style="margin-top: 12px; font-size: 14px;"></p>
    </form>

    <!-- Verification Info -->
    <div style="background: #eff6ff; border-left: 4px solid #2563eb; padding: 20px; border-radius: 8px; margin-top: 24px;">
      <h4 style="margin: 0 0 12px 0; color: #1e40af; font-size: 16px;">üìã Verification Process</h4>
      <p style="margin: 0 0 12px 0; color: #1e3a8a; font-size: 14px; line-height: 1.6;">
        Once you submit your license information, our team will verify it against state licensing boards.
        This typically takes 1-3 business days. You'll receive an email when verification is complete.
      </p>
      <p style="margin: 0; color: #1e3a8a; font-size: 14px; line-height: 1.6;">
        <strong>Verified contractors get:</strong> ‚úì Verified badge, priority job placement, and higher homeowner trust.
      </p>
    </div>
  </div>

  <div id="socialTab" class="tab-content">
    <h2 style="margin-top: 0;">Social Media Links</h2>
    <form id="socialForm" novalidate>
      <div class="form-grid">
        <div class="form-group form-group-full">
          <label for="instagram">Instagram</label>
          <input id="instagram" type="url" placeholder="https://instagram.com/yourprofile" maxlength="200" />
        </div>
        <div class="form-group form-group-full">
          <label for="facebook">Facebook</label>
          <input id="facebook" type="url" placeholder="https://facebook.com/yourpage" maxlength="200" />
        </div>
        <div class="form-group form-group-full">
          <label for="tiktok">TikTok</label>
          <input id="tiktok" type="url" placeholder="https://tiktok.com/@yourprofile" maxlength="200" />
        </div>
        <div class="form-group form-group-full">
          <label for="youtube">YouTube</label>
          <input id="youtube" type="url" placeholder="https://youtube.com/c/yourchannel" maxlength="200" />
        </div>
        <div class="form-group form-group-full">
          <label for="reddit">Reddit</label>
          <input id="reddit" type="url" placeholder="https://reddit.com/u/yourusername" maxlength="200" />
        </div>
      </div>
      <button type="submit" class="btn-primary" id="saveSocialButton">Save Social Links</button>
      <p id="socialStatusMessage" style="margin-top: 12px; font-size: 14px;"></p>
    </form>
  </div>
</div>

<script>
const STORAGE_KEYS = {
  USER_PROFILE: 'homeprohub_user',
  USER_ROLE: 'homeprohub_user_role',
  AUTH_TOKEN: 'homeprohub_auth_token',
  USERNAME: 'homeprohub_username',
  PROFILE_COMPLETE: 'homeprohub_profile_complete',
  CONTRACTOR_PROFILE: 'homeprohub_contractor_profile'
};

function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

  if (tabName === 'basic') {
    document.querySelector('.tab:nth-child(1)').classList.add('active');
    document.getElementById('basicTab').classList.add('active');
  } else if (tabName === 'licensing') {
    document.querySelector('.tab:nth-child(2)').classList.add('active');
    document.getElementById('licensingTab').classList.add('active');
    checkLicenseStatus();
  } else if (tabName === 'social') {
    document.querySelector('.tab:nth-child(3)').classList.add('active');
    document.getElementById('socialTab').classList.add('active');
  }
}

let licenseFile = null;
let insuranceFile = null;

function clearLicenseUpload() {
  licenseFile = null;
  document.getElementById('licenseUpload').value = '';
  document.getElementById('licensePreview').style.display = 'none';
}

function clearInsuranceUpload() {
  insuranceFile = null;
  document.getElementById('insuranceUpload').value = '';
  document.getElementById('insurancePreview').style.display = 'none';
}

async function checkLicenseStatus() {
  const statusBanner = document.getElementById('licenseStatusBanner');
  const getLicensedPrompt = document.getElementById('getLicensedPrompt');

  // Get user email
  const userEmail = localStorage.getItem(STORAGE_KEYS.USERNAME);
  if (!userEmail) return;

  try {
    // Fetch fresh status from API
    const response = await fetch(`/api/license/status?email=${encodeURIComponent(userEmail)}`);
    if (response.ok) {
      const data = await response.json();

      // Update localStorage with fresh data
      const profile = JSON.parse(localStorage.getItem(STORAGE_KEYS.CONTRACTOR_PROFILE) || '{}');
      profile.licenseVerified = data.license_verified;
      profile.license_verified = data.license_verified; // Both formats for compatibility
      profile.licState = data.license_state;
      profile.licNumber = data.license_number;
      profile.licenseNumber = data.license_number;
      profile.licType = data.license_type;
      profile.licExpiration = data.license_expiration;
      profile.verificationId = data.verification_id;
      profile.verifiedAt = data.verified_at;
      localStorage.setItem(STORAGE_KEYS.CONTRACTOR_PROFILE, JSON.stringify(profile));

      // Display status based on API response
      displayLicenseStatus(data.license_verified, data.license_number, data.license_state);
    } else {
      // Fallback to localStorage if API fails
      const profile = JSON.parse(localStorage.getItem(STORAGE_KEYS.CONTRACTOR_PROFILE) || '{}');
      displayLicenseStatus(profile.licenseVerified || profile.license_verified, profile.licNumber || profile.license_number, profile.licState || profile.license_state);
    }
  } catch (err) {
    console.error('Error fetching license status:', err);
    // Fallback to localStorage
    const profile = JSON.parse(localStorage.getItem(STORAGE_KEYS.CONTRACTOR_PROFILE) || '{}');
    displayLicenseStatus(profile.licenseVerified || profile.license_verified, profile.licNumber || profile.license_number, profile.licState || profile.license_state);
  }
}

function displayLicenseStatus(status, licenseNumber, licenseState) {
  const statusBanner = document.getElementById('licenseStatusBanner');
  const getLicensedPrompt = document.getElementById('getLicensedPrompt');

  if (!licenseNumber || !licenseState) {
    // No license info - show Get Licensed prompt
    getLicensedPrompt.style.display = 'block';
    statusBanner.style.display = 'none';
  } else if (status === 'verified') {
    // Verified license - CELEBRATION MODE! üéâ
    statusBanner.style.display = 'block';
    statusBanner.style.background = 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)';
    statusBanner.style.border = '2px solid #10b981';
    statusBanner.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.2)';
    document.getElementById('licenseStatusIcon').textContent = 'üéâ';
    document.getElementById('licenseStatusTitle').textContent = 'Congratulations! License Verified!';
    document.getElementById('licenseStatusTitle').style.color = '#065f46';
    document.getElementById('licenseStatusMessage').innerHTML = '<strong>‚úì Verified Badge Activated!</strong> You now have priority placement in job matches and increased homeowner trust. Start bidding on premium jobs!';
    document.getElementById('licenseStatusMessage').style.color = '#047857';
    getLicensedPrompt.style.display = 'none';
  } else if (status === 'pending') {
    // Pending verification
    statusBanner.style.display = 'block';
    statusBanner.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
    statusBanner.style.border = '2px solid #f59e0b';
    document.getElementById('licenseStatusIcon').textContent = '‚è≥';
    document.getElementById('licenseStatusTitle').textContent = 'Verification Pending';
    document.getElementById('licenseStatusTitle').style.color = '#92400e';
    document.getElementById('licenseStatusMessage').textContent = 'We\'re verifying your license information. This typically takes 1-2 business days. We\'ll email you when it\'s complete!';
    document.getElementById('licenseStatusMessage').style.color = '#78350f';
    getLicensedPrompt.style.display = 'none';
  } else if (status === 'rejected') {
    // Rejected verification
    statusBanner.style.display = 'block';
    statusBanner.style.background = 'linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)';
    statusBanner.style.border = '2px solid #ef4444';
    document.getElementById('licenseStatusIcon').textContent = '‚ö†Ô∏è';
    document.getElementById('licenseStatusTitle').textContent = 'Verification Update Needed';
    document.getElementById('licenseStatusTitle').style.color = '#991b1b';
    document.getElementById('licenseStatusMessage').textContent = 'We couldn\'t verify your license information. Please check your email for details and resubmit with corrected information.';
    document.getElementById('licenseStatusMessage').style.color = '#7f1d1d';
    getLicensedPrompt.style.display = 'none';
  } else {
    // License info provided but not verified
    statusBanner.style.display = 'block';
    statusBanner.style.background = 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)';
    statusBanner.style.border = '2px solid #3b82f6';
    document.getElementById('licenseStatusIcon').textContent = 'üìã';
    document.getElementById('licenseStatusTitle').textContent = 'License Info Saved';
    document.getElementById('licenseStatusTitle').style.color = '#1e40af';
    document.getElementById('licenseStatusMessage').textContent = 'Upload your license document to submit for verification and get your verified badge!';
    document.getElementById('licenseStatusMessage').style.color = '#1e3a8a';
    getLicensedPrompt.style.display = 'none';
  }
}

(function() {
    'use strict';

    const profileForm = document.getElementById('profileForm');
    const socialForm = document.getElementById('socialForm');
    const saveButton = document.getElementById('saveButton');
    const saveSocialButton = document.getElementById('saveSocialButton');
    const statusMessage = document.getElementById('statusMessage');
    const socialStatusMessage = document.getElementById('socialStatusMessage');

    async function checkAuth() {
        try {
            // Wait for authService to be ready
            if (!window.authService || !window.authService.initialized) {
                await new Promise(resolve => {
                    const checkInterval = setInterval(() => {
                        if (window.authService && window.authService.initialized) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                });
            }

            const user = await window.authService.getCurrentUser();
            if (!user) {
                window.location.href = "index.html";
                return false;
            }

            const userProfile = await window.authService.getUserProfile();
            if (!userProfile || userProfile.role !== 'contractor') {
                window.location.href = "index.html";
                return false;
            }

            return true;
        } catch (error) {
            console.error('Auth check failed:', error);
            window.location.href = "index.html";
            return false;
        }
    }

    async function loadProfile() {
        try {
            const profile = await window.authService.getUserProfile();
            if (profile) {
                if (profile.firstName) document.getElementById('firstName').value = profile.firstName;
                if (profile.lastName) document.getElementById('lastName').value = profile.lastName;
                if (profile.businessName) document.getElementById('businessName').value = profile.businessName;
                if (profile.yearsInBusiness) document.getElementById('yearsInBusiness').value = profile.yearsInBusiness;
                if (profile.licenseNumber) document.getElementById('licenseNumber').value = profile.licenseNumber;
                if (profile.trade) document.getElementById('trade').value = profile.trade;
                if (profile.street) document.getElementById('street').value = profile.street;
                if (profile.city) document.getElementById('city').value = profile.city;
                if (profile.state) document.getElementById('state').value = profile.state;
                if (profile.zipCode) document.getElementById('zipCode').value = profile.zipCode;
                if (profile.instagram) document.getElementById('instagram').value = profile.instagram;
                if (profile.facebook) document.getElementById('facebook').value = profile.facebook;
                if (profile.tiktok) document.getElementById('tiktok').value = profile.tiktok;
                if (profile.youtube) document.getElementById('youtube').value = profile.youtube;
                if (profile.reddit) document.getElementById('reddit').value = profile.reddit;
            }
        } catch (err) {
            console.error('Error loading profile:', err);
        }
    }

    profileForm.addEventListener('submit', function(e) {
        e.preventDefault();
        saveButton.disabled = true;
        saveButton.textContent = 'Saving...';

        try {
            const existing = localStorage.getItem(STORAGE_KEYS.CONTRACTOR_PROFILE);
            const profile = existing ? JSON.parse(existing) : {};

            profile.firstName = document.getElementById('firstName').value.trim();
            profile.lastName = document.getElementById('lastName').value.trim();
            profile.businessName = document.getElementById('businessName').value.trim();
            profile.companyName = document.getElementById('businessName').value.trim();
            profile.yearsInBusiness = document.getElementById('yearsInBusiness').value.trim();
            profile.licenseNumber = document.getElementById('licenseNumber').value.trim();
            profile.license = profile.licenseNumber;
            profile.trade = document.getElementById('trade').value;
            profile.street = document.getElementById('street').value.trim();
            profile.city = document.getElementById('city').value.trim();
            profile.state = document.getElementById('state').value.trim();
            profile.zipCode = document.getElementById('zipCode').value.trim();
            profile.profileComplete = true;

            localStorage.setItem(STORAGE_KEYS.CONTRACTOR_PROFILE, JSON.stringify(profile));
            localStorage.setItem(STORAGE_KEYS.PROFILE_COMPLETE, 'true');

            statusMessage.textContent = 'Profile saved successfully!';
            statusMessage.style.color = '#10b981';
        } catch (err) {
            statusMessage.textContent = 'Error saving profile';
            statusMessage.style.color = '#ef4444';
        } finally {
            saveButton.disabled = false;
            saveButton.textContent = 'Save Profile';
        }
    });

    socialForm.addEventListener('submit', function(e) {
        e.preventDefault();
        saveSocialButton.disabled = true;
        saveSocialButton.textContent = 'Saving...';

        try {
            const existing = localStorage.getItem(STORAGE_KEYS.CONTRACTOR_PROFILE);
            const profile = existing ? JSON.parse(existing) : {};

            profile.instagram = document.getElementById('instagram').value.trim();
            profile.facebook = document.getElementById('facebook').value.trim();
            profile.tiktok = document.getElementById('tiktok').value.trim();
            profile.youtube = document.getElementById('youtube').value.trim();
            profile.reddit = document.getElementById('reddit').value.trim();

            localStorage.setItem(STORAGE_KEYS.CONTRACTOR_PROFILE, JSON.stringify(profile));

            socialStatusMessage.textContent = 'Social links saved successfully!';
            socialStatusMessage.style.color = '#10b981';
        } catch (err) {
            socialStatusMessage.textContent = 'Error saving social links';
            socialStatusMessage.style.color = '#ef4444';
        } finally {
            saveSocialButton.disabled = false;
            saveSocialButton.textContent = 'Save Social Links';
        }
    });

    // License file upload handler
    document.getElementById('licenseUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            return;
        }

        licenseFile = file;
        document.getElementById('licenseFileName').textContent = file.name;
        document.getElementById('licenseFileSize').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
        document.getElementById('licenseFileIcon').textContent = file.type.includes('pdf') ? 'üìÑ' : 'üñºÔ∏è';
        document.getElementById('licensePreview').style.display = 'block';
    });

    // Insurance file upload handler
    document.getElementById('insuranceUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            return;
        }

        insuranceFile = file;
        document.getElementById('insuranceFileName').textContent = file.name;
        document.getElementById('insuranceFileSize').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
        document.getElementById('insurancePreview').style.display = 'block';
    });

    // License form submission
    const licenseForm = document.getElementById('licenseForm');
    const saveLicenseButton = document.getElementById('saveLicenseButton');
    const licenseStatusMsg = document.getElementById('licenseStatusMessage');

    licenseForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        saveLicenseButton.disabled = true;
        saveLicenseButton.textContent = 'Submitting...';

        try {
            const contractorEmail = localStorage.getItem(STORAGE_KEYS.USERNAME);
            if (!contractorEmail) {
                throw new Error('Not logged in');
            }

            // Gather form data
            const licState = document.getElementById('licState').value.trim().toUpperCase();
            const licNumber = document.getElementById('licNumber').value.trim();
            const licType = document.getElementById('licType').value;
            const licExpiration = document.getElementById('licExpiration').value;
            const insuranceProvider = document.getElementById('insuranceProvider').value.trim();
            const insurancePolicyNumber = document.getElementById('insurancePolicyNumber').value.trim();
            const insuranceExpiration = document.getElementById('insuranceExpiration').value;
            const insuranceCoverage = document.getElementById('insuranceCoverage').value;

            // Convert files to base64 if present
            let licenseDocument = null;
            let insuranceDocument = null;

            if (licenseFile) {
                licenseDocument = await fileToBase64(licenseFile);
            }
            if (insuranceFile) {
                insuranceDocument = await fileToBase64(insuranceFile);
            }

            // Submit to API
            const response = await fetch('/api/license/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contractorEmail,
                    licState,
                    licNumber,
                    licType,
                    licExpiration,
                    licenseDocument,
                    insuranceProvider,
                    insurancePolicyNumber,
                    insuranceExpiration,
                    insuranceCoverage,
                    insuranceDocument
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to submit license');
            }

            // Also save to localStorage for quick access
            const existing = localStorage.getItem(STORAGE_KEYS.CONTRACTOR_PROFILE);
            const profile = existing ? JSON.parse(existing) : {};
            profile.licState = licState;
            profile.licNumber = licNumber;
            profile.licenseNumber = licNumber;
            profile.license = licNumber;
            profile.licType = licType;
            profile.licExpiration = licExpiration;
            profile.insuranceProvider = insuranceProvider;
            profile.insurancePolicyNumber = insurancePolicyNumber;
            profile.insuranceExpiration = insuranceExpiration;
            profile.insuranceCoverage = insuranceCoverage;
            profile.licenseVerified = 'pending';
            profile.verificationId = data.verificationId;
            profile.licenseSubmittedDate = new Date().toISOString();
            localStorage.setItem(STORAGE_KEYS.CONTRACTOR_PROFILE, JSON.stringify(profile));

            licenseStatusMsg.textContent = '‚úÖ License submitted for verification! We\'ll email you within 1-2 business days with the results.';
            licenseStatusMsg.style.color = '#10b981';

            // Update status banner
            checkLicenseStatus();

            // Clear file uploads after successful submission
            clearLicenseUpload();
            clearInsuranceUpload();

        } catch (err) {
            console.error('License submission error:', err);
            licenseStatusMsg.textContent = `‚ùå Error: ${err.message}`;
            licenseStatusMsg.style.color = '#ef4444';
        } finally {
            saveLicenseButton.disabled = false;
            saveLicenseButton.textContent = 'Save & Submit for Verification';
        }
    });

    // Helper function to convert file to base64
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
    }

    // Load license info into form
    function loadLicenseInfo() {
        try {
            const profileData = localStorage.getItem(STORAGE_KEYS.CONTRACTOR_PROFILE);
            if (profileData) {
                const profile = JSON.parse(profileData);
                if (profile.licState) document.getElementById('licState').value = profile.licState;
                if (profile.licNumber) document.getElementById('licNumber').value = profile.licNumber;
                if (profile.licType) document.getElementById('licType').value = profile.licType;
                if (profile.licExpiration) document.getElementById('licExpiration').value = profile.licExpiration;
                if (profile.insuranceProvider) document.getElementById('insuranceProvider').value = profile.insuranceProvider;
                if (profile.insurancePolicyNumber) document.getElementById('insurancePolicyNumber').value = profile.insurancePolicyNumber;
                if (profile.insuranceExpiration) document.getElementById('insuranceExpiration').value = profile.insuranceExpiration;
                if (profile.insuranceCoverage) document.getElementById('insuranceCoverage').value = profile.insuranceCoverage;
            }
        } catch (err) {
            console.error('Error loading license info:', err);
        }
    }

    // Initialize with async auth check
    checkAuth().then(isAuthenticated => {
        if (isAuthenticated) {
            loadProfile();
            loadLicenseInfo();
        }
    });
})();
</script>

<!-- Unified Navigation Component -->
<script src="components/navigation.js"></script>
</body>
</html>