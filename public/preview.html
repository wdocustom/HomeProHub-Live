<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Project Blueprint ‚Äì HomeProHub</title>

  <!-- Supabase Auth -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/services/auth.js"></script>

  <style>
    body {
      background: #f9fafb;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    }

    .page-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px 24px 120px;
    }

    /* ============================================
       THE BLUEPRINT - Premium Card Design
       ============================================ */
    .blueprint-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 8px 24px rgba(0, 0, 0, 0.06);
      overflow: hidden;
      margin-bottom: 32px;
      border: 1px solid #e5e7eb;
    }

    .blueprint-header {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
      padding: 40px 48px;
      position: relative;
      overflow: hidden;
    }

    .blueprint-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      border-radius: 50%;
    }

    .blueprint-badge {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: white;
      margin-bottom: 16px;
    }

    .blueprint-title {
      font-size: 36px;
      font-weight: 800;
      color: white;
      margin: 0;
      letter-spacing: -0.03em;
      position: relative;
      z-index: 1;
    }

    .blueprint-body {
      padding: 48px;
    }

    /* Hero Vision Statement */
    .vision-section {
      margin-bottom: 40px;
      padding-bottom: 32px;
      border-bottom: 2px solid #e5e7eb;
    }

    .vision-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #6b7280;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .vision-text {
      font-size: 22px;
      line-height: 1.6;
      color: #111827;
      font-family: Georgia, 'Times New Roman', serif;
      font-weight: 400;
    }

    /* Data Grid - Budget + Timeline */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s;
    }

    .stat-card:hover {
      border-color: #3b82f6;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }

    .stat-icon {
      font-size: 32px;
      margin-bottom: 12px;
      display: block;
    }

    .stat-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7280;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 800;
      color: #111827;
      letter-spacing: -0.02em;
    }

    .stat-value.budget {
      color: #10b981;
    }

    /* Scope Checklist */
    .scope-section {
      margin-bottom: 40px;
    }

    .scope-label {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7280;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .scope-checklist {
      display: grid;
      gap: 12px;
    }

    .scope-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: #f0fdf4;
      border: 2px solid #d1fae5;
      border-radius: 10px;
      font-size: 15px;
      color: #065f46;
      font-weight: 500;
      transition: all 0.2s;
    }

    .scope-item:hover {
      background: #d1fae5;
      transform: translateX(4px);
    }

    .scope-check {
      font-size: 20px;
      color: #10b981;
      flex-shrink: 0;
    }

    /* Sticky Action Bar */
    .action-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 2px solid #e5e7eb;
      padding: 20px 24px;
      box-shadow: 0 -8px 24px rgba(0,0,0,0.08);
      z-index: 100;
    }

    .action-bar-content {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .action-hint {
      font-size: 14px;
      color: #6b7280;
      flex: 1;
    }

    .approve-button {
      padding: 16px 48px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
      transition: all 0.3s;
      white-space: nowrap;
    }

    .approve-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
    }

    .approve-button:active {
      transform: translateY(0);
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 60px 24px;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 18px;
      color: #6b7280;
      font-weight: 500;
    }

    /* Error State */
    .error {
      background: #fef2f2;
      border: 2px solid #fca5a5;
      color: #991b1b;
      padding: 32px;
      border-radius: 12px;
      text-align: center;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .blueprint-header {
        padding: 32px 24px;
      }

      .blueprint-title {
        font-size: 28px;
      }

      .blueprint-body {
        padding: 32px 24px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .action-bar-content {
        flex-direction: column;
        align-items: stretch;
      }

      .approve-button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="page-container">
    <!-- Loading State -->
    <div id="loadingSection" class="loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">Analyzing your home issue...</div>
    </div>

    <!-- Error State -->
    <div id="errorSection" class="error" style="display: none;">
      <h3>Oops! Something went wrong.</h3>
      <p id="errorMessage">Please try again or contact support.</p>
    </div>

    <!-- Blueprint Card -->
    <div id="blueprintSection" style="display: none;">
      <div class="blueprint-card">
        <div class="blueprint-header">
          <div class="blueprint-badge">AI-Powered Analysis</div>
          <h1 class="blueprint-title">Your Project Blueprint</h1>
        </div>

        <div class="blueprint-body">
          <!-- Vision Statement -->
          <div class="vision-section">
            <div class="vision-label">Your Vision</div>
            <div class="vision-text" id="visionText">
              <!-- Extracted project summary -->
            </div>
          </div>

          <!-- Data Grid: Budget + Timeline -->
          <div class="stats-grid">
            <div class="stat-card">
              <span class="stat-icon">üí∞</span>
              <div class="stat-label">Estimated Fair Value</div>
              <div class="stat-value budget" id="budgetValue">$XX - $YY</div>
            </div>
            <div class="stat-card">
              <span class="stat-icon">‚è±Ô∏è</span>
              <div class="stat-label">Typical Duration</div>
              <div class="stat-value" id="timelineValue">X weeks</div>
            </div>
          </div>

          <!-- Scope Checklist -->
          <div class="scope-section">
            <div class="scope-label">What's Included</div>
            <div class="scope-checklist" id="scopeChecklist">
              <!-- Dynamically populated -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sticky Action Bar -->
  <div class="action-bar" id="actionBar" style="display: none;">
    <div class="action-bar-content">
      <div class="action-hint">
        Ready to connect with licensed contractors?
      </div>
      <button class="approve-button" id="approveButton" onclick="approveAndPost()">
        Approve This Plan & Get Bids
      </button>
    </div>
  </div>

  <script>
    // Global state
    window.blueprintData = {
      question: '',
      answer: '',
      parsed: {},
      budgetLow: 0,
      budgetHigh: 0
    };

    // Get question from sessionStorage or URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const question = sessionStorage.getItem('pendingQuestion') || urlParams.get('q') || '';

    if (!question || question.length < 10) {
      showError('No question provided. Please go back to the homepage and describe your issue.');
    } else {
      analyzeQuestion();
    }

    async function analyzeQuestion() {
      try {
        // Call unauthenticated AI preview endpoint
        const response = await fetch('/api/ai/preview', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ question })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to analyze question');
        }

        const data = await response.json();

        // Store globally
        window.blueprintData.question = question;
        window.blueprintData.answer = data.answer;

        // Parse AI response
        const parsed = parseAIResponse(data.answer);
        window.blueprintData.parsed = parsed;

        // Store budget values
        window.blueprintData.budgetLow = parsed.budgetLow || 5000;
        window.blueprintData.budgetHigh = parsed.budgetHigh || 15000;

        // Render Blueprint UI
        renderBlueprint(parsed);

        // Hide loading, show results
        document.getElementById('loadingSection').style.display = 'none';
        document.getElementById('blueprintSection').style.display = 'block';
        document.getElementById('actionBar').style.display = 'block';

        // Clear pending question
        sessionStorage.removeItem('pendingQuestion');

      } catch (error) {
        console.error('Analysis error:', error);
        showError(error.message || 'Failed to analyze your question. Please try again.');
      }
    }

    /**
     * Clean AI artifacts from text (INTENT TYPE, etc.)
     */
    function cleanAIArtifacts(text) {
      if (!text) return '';

      // Remove INTENT TYPE lines
      let cleaned = text.replace(/^[\s]*INTENT\s*TYPE\s*:\s*(PROJECT|ISSUE)[\s]*$/gim, '').trim();

      // Remove AI ANALYSIS prefix
      cleaned = cleaned.replace(/^[\s]*AI ANALYSIS:[\s]*/gim, '').trim();

      // Remove markdown bold
      cleaned = cleaned.replace(/\*\*/g, '');

      return cleaned;
    }

    /**
     * Parse AI response for structured data (Budget, Timeline, Scope, Designer Note)
     */
    function parseAIResponse(text) {
      const parsed = {
        summary: '',
        budgetLow: 0,
        budgetHigh: 0,
        timeline: '',
        scopeItems: [],
        designerNote: ''
      };

      // Clean text first
      const cleanedText = cleanAIArtifacts(text);

      // Extract Designer Note (from Local Design Insights feature)
      const designerNoteMatch = cleanedText.match(/Design(?:er)?\s*Note:\s*(.+?)(?:\n\n|\n(?=[A-Z])|$)/is);
      if (designerNoteMatch) {
        parsed.designerNote = designerNoteMatch[1].trim();
      }

      // Extract first paragraph as summary (skip if it's INTENT TYPE)
      const paragraphs = cleanedText.split('\n\n').filter(p => p.trim().length > 0);
      if (paragraphs.length > 0) {
        const firstPara = paragraphs[0].trim();
        if (!firstPara.toLowerCase().includes('intent type')) {
          parsed.summary = firstPara;
        } else if (paragraphs.length > 1) {
          // Use second paragraph if first is INTENT TYPE
          parsed.summary = paragraphs[1].trim();
        }
      }

      // Extract budget with regex
      const budgetPattern = /\$?([\d,]+)\s*[-‚Äìto]+\s*\$?([\d,]+)/i;
      const budgetMatch = cleanedText.match(budgetPattern);
      if (budgetMatch) {
        parsed.budgetLow = parseInt(budgetMatch[1].replace(/,/g, ''));
        parsed.budgetHigh = parseInt(budgetMatch[2].replace(/,/g, ''));
      }

      // Extract timeline
      const timelinePattern = /(\d+[-‚Äìto]+\d+)\s*(days?|weeks?|months?)/i;
      const timelineMatch = cleanedText.match(timelinePattern);
      if (timelineMatch) {
        parsed.timeline = timelineMatch[0];
      }

      // Extract scope items - ONLY work statements, NOT questions
      const lines = cleanedText.split('\n');
      let inScopeSection = false;

      lines.forEach((line, index) => {
        // Detect scope sections
        if (line.match(/scope\s+considerations|materials?\s+(&|and)\s+tools?|work\s+includes?/i)) {
          inScopeSection = true;
          return;
        }

        // Stop at question sections
        if (line.match(/questions?\s+for|ask\s+about|verify|confirm\s+with/i)) {
          inScopeSection = false;
          return;
        }

        // Match bullets or numbers
        const bulletMatch = line.match(/^[\s]*[-‚Ä¢*]\s*(.+)/);
        const numberMatch = line.match(/^[\s]*\d+\.\s*(.+)/);

        let item = null;
        if (bulletMatch) item = bulletMatch[1].trim();
        if (numberMatch) item = numberMatch[1].trim();

        // Filter: Only add if it's a work statement (not a question)
        if (item && item.length < 120) {
          // Skip questions (starts with Do, Can, Will, Should, etc.)
          if (item.match(/^(do|does|can|will|should|would|is|are|have|has|verify|confirm|ask)/i)) {
            return; // Skip questions
          }

          // Skip if contains question mark
          if (item.includes('?')) {
            return;
          }

          // Prefer items from scope sections
          if (inScopeSection || parsed.scopeItems.length < 3) {
            parsed.scopeItems.push(item);
          }
        }
      });

      // Limit scope items
      parsed.scopeItems = parsed.scopeItems.slice(0, 8);

      return parsed;
    }

    /**
     * Render Blueprint UI from parsed data
     */
    function renderBlueprint(parsed) {
      // Vision statement
      document.getElementById('visionText').textContent =
        parsed.summary || 'Your home improvement project is ready for professional bids.';

      // Budget
      const budgetLow = parsed.budgetLow || 5000;
      const budgetHigh = parsed.budgetHigh || 15000;
      document.getElementById('budgetValue').textContent =
        `$${budgetLow.toLocaleString()} - $${budgetHigh.toLocaleString()}`;

      // Timeline
      document.getElementById('timelineValue').textContent =
        parsed.timeline || '2-4 weeks';

      // Scope checklist
      const scopeContainer = document.getElementById('scopeChecklist');
      if (parsed.scopeItems.length > 0) {
        scopeContainer.innerHTML = parsed.scopeItems.map(item => `
          <div class="scope-item">
            <span class="scope-check">‚úì</span>
            <span>${escapeHtml(item)}</span>
          </div>
        `).join('');
      } else {
        // Fallback if no scope items found
        scopeContainer.innerHTML = `
          <div class="scope-item">
            <span class="scope-check">‚úì</span>
            <span>Professional assessment and quote</span>
          </div>
          <div class="scope-item">
            <span class="scope-check">‚úì</span>
            <span>Licensed and vetted contractors</span>
          </div>
          <div class="scope-item">
            <span class="scope-check">‚úì</span>
            <span>Competitive pricing comparison</span>
          </div>
        `;
      }
    }

    /**
     * Approve and Post - NEW "Click-Click-Boom" Flow
     * Saves hot_lead_draft to localStorage and redirects with intent
     */
    async function approveAndPost() {
      // STEP 1: Extract structured data from Blueprint
      const parsed = window.blueprintData.parsed;

      // Clean the title - remove AI artifacts
      let projectTitle = 'Home Renovation Project';
      if (parsed.summary) {
        // Clean any remaining artifacts
        let cleanSummary = cleanAIArtifacts(parsed.summary);

        // Extract first sentence
        const firstSentence = cleanSummary.split('.')[0].trim();

        // Validate it's not empty or garbage
        if (firstSentence && firstSentence.length > 5 && !firstSentence.toLowerCase().includes('intent')) {
          projectTitle = firstSentence.length > 60
            ? firstSentence.substring(0, 57) + '...'
            : firstSentence;
        } else {
          // Fallback: Use user's original question as title
          const userQuestion = window.blueprintData.question || '';
          const questionFirstPart = userQuestion.split('.')[0].trim();
          if (questionFirstPart.length > 10) {
            projectTitle = questionFirstPart.length > 60
              ? questionFirstPart.substring(0, 57) + '...'
              : questionFirstPart;
          }
        }
      }

      const tradeType = extractTradeType(window.blueprintData.answer);

      // STEP 2: Create "hot_lead_draft" with all extracted data
      const hotLeadDraft = {
        title: projectTitle,
        description: window.blueprintData.question,
        aiAnalysis: window.blueprintData.answer,
        budgetMin: parsed.budgetLow || window.blueprintData.budgetLow || 5000,
        budgetMax: parsed.budgetHigh || window.blueprintData.budgetHigh || 15000,
        timeline: parsed.timeline || '2-4 weeks',
        tradeType: tradeType,
        category: tradeType || 'general',
        urgency: 'flexible',
        scopeItems: parsed.scopeItems || [],
        designerNote: parsed.designerNote || '', // Include designer note
        fromBlueprint: true,
        timestamp: new Date().toISOString()
      };

      localStorage.setItem('hot_lead_draft', JSON.stringify(hotLeadDraft));
      console.log('‚úì Saved hot_lead_draft:', hotLeadDraft);

      // STEP 3: Check authentication and route accordingly
      if (window.authService && window.authService.initialized) {
        const user = await window.authService.getCurrentUser();

        if (user) {
          // Logged in - go directly to Review & Post page
          window.location.href = 'post-project.html';
          return;
        }
      }

      // NOT logged in - redirect to signup WITH INTENT
      sessionStorage.setItem('signup_role', 'homeowner');
      window.location.href = 'signup.html?intent=post_project';
    }

    /**
     * Extract trade type with COMPLEXITY DETECTION
     * Multi-trade projects ‚Üí General Contractor
     * Simple single-system jobs ‚Üí Specific Trade
     */
    function extractTradeType(aiText) {
      const text = aiText.toLowerCase();

      // Trade keywords map
      const tradeMap = {
        'plumbing': ['plumber', 'plumbing', 'pipe', 'leak', 'faucet', 'water heater', 'drain'],
        'electrical': ['electrician', 'electrical', 'wiring', 'outlet', 'circuit', 'breaker'],
        'hvac': ['hvac', 'heating', 'cooling', 'furnace', 'ac', 'air conditioning'],
        'roofing': ['roof', 'roofing', 'shingles', 'gutter'],
        'painting': ['paint', 'painting', 'painter'],
        'flooring': ['floor', 'flooring', 'carpet', 'hardwood', 'tile', 'vinyl'],
        'carpentry': ['carpenter', 'carpentry', 'wood', 'deck', 'fence', 'framing'],
        'landscaping': ['landscape', 'landscaping', 'yard', 'lawn', 'garden']
      };

      // Complexity indicators (if present ‚Üí General Contractor)
      const complexityKeywords = [
        'remodel', 'renovation', 'addition', 'extension', 'demolition', 'demo',
        'bathroom remodel', 'kitchen remodel', 'basement finish', 'gut',
        'multiple', 'several', 'various', 'complete overhaul'
      ];

      // Check for complexity indicators
      if (complexityKeywords.some(keyword => text.includes(keyword))) {
        return 'general';
      }

      // Count how many different trades are mentioned
      let tradesMatched = [];
      for (const [trade, keywords] of Object.entries(tradeMap)) {
        if (keywords.some(keyword => text.includes(keyword))) {
          tradesMatched.push(trade);
        }
      }

      // If 3+ trades mentioned ‚Üí General Contractor
      if (tradesMatched.length >= 3) {
        return 'general';
      }

      // Small repair indicators ‚Üí Handyman
      const handymanKeywords = ['minor', 'small', 'quick fix', 'patch', 'touch up'];
      const hasHandymanIndicators = handymanKeywords.some(k => text.includes(k));

      // Check for budget (if < $500 and minor ‚Üí handyman)
      const budgetMatch = text.match(/\$?([\d,]+)/);
      const estimatedBudget = budgetMatch ? parseInt(budgetMatch[1].replace(/,/g, '')) : 0;

      if (hasHandymanIndicators && estimatedBudget < 500) {
        return 'handyman';
      }

      // Single trade detected ‚Üí return that trade
      if (tradesMatched.length === 1) {
        return tradesMatched[0];
      }

      // If 2 trades but one is clearly dominant
      if (tradesMatched.length === 2) {
        // If one of the trades appears much more frequently, use it
        const tradeCounts = {};
        tradesMatched.forEach(trade => {
          tradeCounts[trade] = tradeMap[trade].filter(k => text.includes(k)).length;
        });

        const dominant = Object.keys(tradeCounts).reduce((a, b) =>
          tradeCounts[a] > tradeCounts[b] * 2 ? a : null
        );

        if (dominant) {
          return dominant;
        }

        // Otherwise, it's multi-trade ‚Üí general
        return 'general';
      }

      // Default fallback
      return 'general';
    }

    function showError(message) {
      document.getElementById('loadingSection').style.display = 'none';
      document.getElementById('errorSection').style.display = 'block';
      document.getElementById('errorMessage').textContent = message;
    }

    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return unsafe
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
