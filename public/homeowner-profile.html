<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HomeProHub ‚Äì My Profile</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="components/navigation.css">
  <!-- Supabase Auth -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/services/auth.js"></script>
  <style>
    .profile-container { max-width: 900px; margin: 40px auto; padding: 0 24px; }
    .profile-header { background: white; padding: 24px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e5e7eb; flex-wrap: wrap; }
    .tab { padding: 12px 24px; cursor: pointer; border: none; background: none; font-size: 15px; color: #6b7280; transition: all 0.2s; }
    .tab.active { color: #2563eb; border-bottom: 2px solid #2563eb; margin-bottom: -2px; font-weight: 600; }
    .tab:hover { color: #2563eb; }
    .tab-content { display: none; background: white; padding: 32px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .tab-content.active { display: block; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .form-group-full { grid-column: 1 / -1; }
    @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }

    /* Toggle Switch Styling */
    .toggle-switch { position: relative; display: inline-block; width: 56px; height: 30px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #d1d5db;
      transition: .3s;
      border-radius: 30px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    .toggle-switch input:checked + .toggle-slider {
      background-color: #10b981;
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    .toggle-switch input:disabled + .toggle-slider {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .info-card {
      background: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #2563eb;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 14px;
      color: #6b7280;
    }

    /* Danger Zone Styles */
    .danger-zone {
      background: #fef2f2;
      padding: 24px;
      border-radius: 12px;
      border: 2px solid #ef4444;
      margin-top: 32px;
    }

    .danger-zone-title {
      font-size: 18px;
      font-weight: 700;
      color: #991b1b;
      margin: 0 0 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .danger-zone-warning {
      font-size: 14px;
      color: #7f1d1d;
      line-height: 1.6;
      margin-bottom: 16px;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-danger:active {
      transform: translateY(0);
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 32px;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .modal-icon {
      font-size: 40px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: #991b1b;
      margin: 0;
    }

    .modal-body {
      color: #1f2937;
      line-height: 1.6;
      margin-bottom: 24px;
    }

    .modal-warning {
      background: #fef3c7;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #f59e0b;
      margin: 20px 0;
      font-size: 14px;
      color: #78350f;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #1f2937;
      border: 1px solid #d1d5db;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      flex: 1;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }
  </style>
</head>
<body>
  <!-- Navigation component will be injected here by navigation.js -->

<div class="profile-container">
  <div class="profile-header">
    <h1 style="margin: 0 0 8px 0; font-size: 28px;">My Profile</h1>
    <p style="margin: 0; color: #6b7280;">Manage your personal information and preferences</p>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('basic')">Basic Info</button>
    <button class="tab" onclick="switchTab('notifications')">Notifications</button>
    <button class="tab" onclick="switchTab('activity')">Activity</button>
  </div>

  <!-- Basic Info Tab -->
  <div id="basicTab" class="tab-content active">
    <h2 style="margin-top: 0;">Personal Information</h2>
    <form id="profileForm" novalidate>
      <div class="form-grid">
        <div class="form-group">
          <label for="firstName">First Name</label>
          <input id="firstName" type="text" placeholder="John" maxlength="50" />
        </div>
        <div class="form-group">
          <label for="lastName">Last Name</label>
          <input id="lastName" type="text" placeholder="Doe" maxlength="50" />
        </div>
        <div class="form-group">
          <label for="phone">Phone Number</label>
          <input id="phone" type="tel" placeholder="(555) 123-4567" maxlength="14" />
        </div>
        <div class="form-group">
          <label for="email">Email Address</label>
          <input id="email" type="email" placeholder="john@example.com" readonly style="background: #f3f4f6; cursor: not-allowed;" />
          <p style="margin: 4px 0 0 0; font-size: 12px; color: #6b7280;">Email cannot be changed</p>
        </div>
        <div class="form-group form-group-full">
          <label for="street">Street Address</label>
          <input id="street" type="text" placeholder="123 Main St" maxlength="200" />
        </div>
        <div class="form-group">
          <label for="city">City</label>
          <input id="city" type="text" placeholder="Springfield" maxlength="100" />
        </div>
        <div class="form-group">
          <label for="state">State</label>
          <input id="state" type="text" placeholder="IL" maxlength="2" />
        </div>
        <div class="form-group">
          <label for="zipCode">ZIP Code</label>
          <input id="zipCode" type="text" placeholder="62701" pattern="[0-9]{5}" maxlength="5" />
        </div>
      </div>
      <button type="submit" class="btn-primary" id="saveButton">Save Profile</button>
      <p id="statusMessage" style="margin-top: 12px; font-size: 14px;"></p>
    </form>
  </div>

  <!-- Notifications Tab -->
  <div id="notificationsTab" class="tab-content">
    <h2 style="margin-top: 0;">Notification Preferences</h2>
    <p style="margin: 0 0 24px 0; color: #6b7280; line-height: 1.6;">
      Get instant notifications about your projects, bids, and messages.
    </p>

    <!-- Phone Verification -->
    <div style="background: #f9fafb; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
      <h3 style="margin: 0 0 16px 0; font-size: 18px; display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 24px;">üì±</span>
        Phone Number Verification
      </h3>
      <p style="margin: 0 0 20px 0; color: #6b7280; font-size: 14px; line-height: 1.6;">
        Verify your phone number to receive SMS notifications about bid updates and project milestones.
      </p>

      <div id="phoneVerifiedBanner" style="display: none; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #10b981;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <span style="font-size: 28px;">‚úÖ</span>
          <div>
            <div style="font-weight: 600; color: #065f46;">Phone Number Verified</div>
            <div style="font-size: 14px; color: #047857;" id="verifiedPhoneDisplay"></div>
          </div>
        </div>
      </div>

      <div id="phoneVerificationForm">
        <div class="form-group" style="margin-bottom: 16px;">
          <label for="phoneNumber">Phone Number</label>
          <input
            id="phoneNumber"
            type="tel"
            placeholder="(555) 123-4567"
            maxlength="14"
            style="font-size: 16px;"
            readonly
          />
          <p style="margin: 8px 0 0 0; font-size: 13px; color: #6b7280;">
            This is the phone number from your profile. Update it in the Basic Info tab if needed.
          </p>
        </div>
        <button
          type="button"
          id="verifyPhoneButton"
          class="btn-primary"
          onclick="sendVerificationCode()"
          style="width: 100%;"
        >
          Send Verification Code
        </button>
      </div>

      <div id="codeVerificationForm" style="display: none; margin-top: 20px;">
        <div style="background: #fffbeb; padding: 16px; border-radius: 8px; border: 2px solid #fbbf24; margin-bottom: 16px;">
          <p style="margin: 0; font-size: 14px; color: #78350f; line-height: 1.6;">
            üì≤ We've sent a 6-digit verification code to your phone. Enter it below:
          </p>
        </div>
        <div class="form-group">
          <label for="verificationCode">Verification Code</label>
          <input
            id="verificationCode"
            type="text"
            placeholder="123456"
            maxlength="6"
            style="font-size: 24px; letter-spacing: 8px; text-align: center; font-weight: 700;"
          />
        </div>
        <div style="display: flex; gap: 12px;">
          <button
            type="button"
            id="confirmCodeButton"
            class="btn-primary"
            onclick="confirmVerificationCode()"
            style="flex: 1;"
          >
            Verify Code
          </button>
          <button
            type="button"
            onclick="cancelVerification()"
            style="flex: 1; background: #f3f4f6; color: #1f2937; border: 1px solid #d1d5db; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;"
            onmouseover="this.style.background='#e5e7eb'"
            onmouseout="this.style.background='#f3f4f6'"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Notification Preferences -->
    <div style="background: #f9fafb; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
      <h3 style="margin: 0 0 16px 0; font-size: 18px; display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 24px;">üîî</span>
        Notification Preferences
      </h3>
      <p style="margin: 0 0 20px 0; color: #6b7280; font-size: 14px; line-height: 1.6;">
        Choose how you want to receive notifications about your projects.
      </p>

      <!-- SMS Notifications Toggle -->
      <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 16px; border: 2px solid #e5e7eb;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <div style="flex: 1;">
            <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 20px;">üí¨</span>
              SMS Text Notifications
            </div>
            <div style="font-size: 14px; color: #6b7280; line-height: 1.5;">
              Get instant text alerts when contractors bid on your jobs or send messages
            </div>
            <div id="smsDisabledWarning" style="display: none; margin-top: 8px; padding: 8px 12px; background: #fef3c7; border-radius: 6px; font-size: 13px; color: #92400e;">
              ‚ö†Ô∏è Please verify your phone number first to enable SMS notifications
            </div>
          </div>
          <label class="toggle-switch" style="margin-left: 16px;">
            <input type="checkbox" id="smsNotifications" onchange="updateNotificationPreferences()">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <!-- Email Notifications Toggle -->
      <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 16px; border: 2px solid #e5e7eb;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <div style="flex: 1;">
            <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 20px;">üìß</span>
              Email Notifications
            </div>
            <div style="font-size: 14px; color: #6b7280; line-height: 1.5;">
              Receive detailed updates about bids, messages, and project progress via email
            </div>
          </div>
          <label class="toggle-switch" style="margin-left: 16px;">
            <input type="checkbox" id="emailNotifications" onchange="updateNotificationPreferences()">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <div style="background: #ecfdf5; padding: 16px; border-radius: 8px; border-left: 4px solid #10b981;">
        <p style="margin: 0; font-size: 14px; color: #065f46; line-height: 1.6;">
          ‚ú® <strong>Pro Tip:</strong> Enable both SMS and email for best results. SMS gives you instant alerts, while email provides complete details.
        </p>
      </div>
    </div>

    <p id="notificationsStatusMessage" style="margin-top: 12px; font-size: 14px;"></p>
  </div>

  <!-- Activity Tab -->
  <div id="activityTab" class="tab-content">
    <h2 style="margin-top: 0;">Account Activity</h2>
    <p style="margin: 0 0 24px 0; color: #6b7280; line-height: 1.6;">
      View your HomeProHub activity and project statistics.
    </p>

    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalJobs">0</div>
        <div class="stat-label">Total Jobs Posted</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="activeJobs">0</div>
        <div class="stat-label">Active Jobs</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalBids">0</div>
        <div class="stat-label">Total Bids Received</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="completedJobs">0</div>
        <div class="stat-label">Completed Projects</div>
      </div>
    </div>

    <div class="info-card" style="margin-top: 32px;">
      <h3 style="margin: 0 0 12px 0; font-size: 18px; display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 24px;">üìä</span>
        Account Information
      </h3>
      <div style="display: grid; gap: 12px;">
        <div style="display: flex; justify-content: space-between; padding: 12px; background: white; border-radius: 6px;">
          <span style="color: #6b7280;">Member Since</span>
          <span style="font-weight: 600;" id="memberSince">Loading...</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 12px; background: white; border-radius: 6px;">
          <span style="color: #6b7280;">Account Status</span>
          <span style="font-weight: 600; color: #10b981;">‚úì Active</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 12px; background: white; border-radius: 6px;">
          <span style="color: #6b7280;">Email</span>
          <span style="font-weight: 600;" id="activityEmail">Loading...</span>
        </div>
      </div>
    </div>

    <!-- Danger Zone -->
    <div class="danger-zone">
      <h3 class="danger-zone-title">
        <span style="font-size: 24px;">‚ö†Ô∏è</span>
        Danger Zone
      </h3>
      <p class="danger-zone-warning">
        Once you delete your account, there is no going back. All your projects, messages, and data will be permanently removed from HomeProHub.
      </p>
      <button type="button" class="btn-danger" onclick="openDeleteAccountModal()">
        Delete My Account
      </button>
    </div>
  </div>
</div>

<!-- Delete Account Confirmation Modal -->
<div id="deleteAccountModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <span class="modal-icon">üóëÔ∏è</span>
      <h2 class="modal-title">Delete Account</h2>
    </div>
    <div class="modal-body">
      <p style="font-size: 16px; margin-bottom: 16px;">
        This action <strong>cannot be undone</strong>. This will permanently delete your account and remove all your data from our servers.
      </p>
      <div class="modal-warning">
        <strong>‚ö†Ô∏è Warning:</strong> All of the following will be permanently deleted:
        <ul style="margin: 8px 0 0 20px; line-height: 1.8;">
          <li>Your profile and account information</li>
          <li>All projects you've posted</li>
          <li>All bids and proposals</li>
          <li>All messages and conversations</li>
          <li>All uploaded files and images</li>
        </ul>
      </div>
      <div style="margin-top: 24px;">
        <label for="deleteConfirmation" style="display: block; font-weight: 600; margin-bottom: 8px; color: #1f2937;">
          Type <span style="color: #ef4444; font-family: monospace; background: #fef2f2; padding: 2px 6px; border-radius: 4px;">DELETE</span> to confirm:
        </label>
        <input
          type="text"
          id="deleteConfirmation"
          placeholder="Type DELETE here"
          style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; font-family: monospace;"
          autocomplete="off"
        />
      </div>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn-secondary" onclick="closeDeleteAccountModal()">
        Cancel
      </button>
      <button type="button" id="confirmDeleteButton" class="btn-danger" onclick="confirmDeleteAccount()" disabled>
        Delete My Account
      </button>
    </div>
  </div>
</div>

<script>
const STORAGE_KEYS = {
  USER_PROFILE: 'homeprohub_user',
  USER_ROLE: 'homeprohub_user_role',
  AUTH_TOKEN: 'homeprohub_auth_token',
  USERNAME: 'homeprohub_username',
  PROFILE_COMPLETE: 'homeprohub_profile_complete'
};

function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

  if (tabName === 'basic') {
    document.querySelector('.tab:nth-child(1)').classList.add('active');
    document.getElementById('basicTab').classList.add('active');
  } else if (tabName === 'notifications') {
    document.querySelector('.tab:nth-child(2)').classList.add('active');
    document.getElementById('notificationsTab').classList.add('active');
    loadNotificationPreferences();
  } else if (tabName === 'activity') {
    document.querySelector('.tab:nth-child(3)').classList.add('active');
    document.getElementById('activityTab').classList.add('active');
    loadActivityStats();
  }
}

// ========================================
// Notification Functions
// ========================================

async function loadNotificationPreferences() {
  try {
    const profile = await window.authService.getUserProfile();
    if (!profile) return;

    // Load phone number
    const phoneInput = document.getElementById('phoneNumber');
    if (profile.phone) {
      phoneInput.value = profile.phone;
    }

    // Load notification preferences
    const smsCheckbox = document.getElementById('smsNotifications');
    const emailCheckbox = document.getElementById('emailNotifications');

    smsCheckbox.checked = profile.notifications_sms_enabled !== false;
    emailCheckbox.checked = profile.notifications_email_enabled !== false;

    // Check phone verification status
    const phoneVerified = profile.phone_verified === true;
    const phoneVerifiedBanner = document.getElementById('phoneVerifiedBanner');
    const phoneVerificationForm = document.getElementById('phoneVerificationForm');
    const smsDisabledWarning = document.getElementById('smsDisabledWarning');
    const verifiedPhoneDisplay = document.getElementById('verifiedPhoneDisplay');

    if (phoneVerified) {
      phoneVerifiedBanner.style.display = 'block';
      phoneVerificationForm.style.display = 'none';
      verifiedPhoneDisplay.textContent = profile.phone || '';
      smsDisabledWarning.style.display = 'none';
      smsCheckbox.disabled = false;
    } else {
      phoneVerifiedBanner.style.display = 'none';
      phoneVerificationForm.style.display = 'block';

      // Disable SMS if phone not verified
      if (!phoneVerified && smsCheckbox.checked) {
        smsDisabledWarning.style.display = 'block';
        smsCheckbox.disabled = true;
      }
    }

  } catch (err) {
    console.error('Error loading notification preferences:', err);
  }
}

async function updateNotificationPreferences() {
  const statusMessage = document.getElementById('notificationsStatusMessage');
  statusMessage.textContent = 'Saving...';
  statusMessage.style.color = '#6b7280';

  try {
    const profile = await window.authService.getUserProfile();
    if (!profile) {
      throw new Error('Not logged in');
    }

    const phoneVerified = profile.phone_verified === true;
    const smsEnabled = document.getElementById('smsNotifications').checked;
    const emailEnabled = document.getElementById('emailNotifications').checked;

    // Prevent enabling SMS without verification
    if (smsEnabled && !phoneVerified) {
      document.getElementById('smsNotifications').checked = false;
      document.getElementById('smsDisabledWarning').style.display = 'block';
      statusMessage.textContent = '‚ö†Ô∏è Please verify your phone number first to enable SMS notifications';
      statusMessage.style.color = '#f59e0b';
      return;
    }

    const response = await window.authService.authenticatedFetch('/api/homeowners/notification-preferences', {
      method: 'PUT',
      body: JSON.stringify({
        notifications_sms_enabled: smsEnabled,
        notifications_email_enabled: emailEnabled
      })
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Failed to update preferences');
    }

    statusMessage.textContent = '‚úÖ Preferences saved successfully!';
    statusMessage.style.color = '#10b981';

    setTimeout(() => {
      statusMessage.textContent = '';
    }, 3000);

  } catch (err) {
    console.error('Error updating notification preferences:', err);
    statusMessage.textContent = `‚ùå Error: ${err.message}`;
    statusMessage.style.color = '#ef4444';
  }
}

async function sendVerificationCode() {
  const verifyButton = document.getElementById('verifyPhoneButton');
  const statusMessage = document.getElementById('notificationsStatusMessage');

  verifyButton.disabled = true;
  verifyButton.textContent = 'Sending...';
  statusMessage.textContent = '';

  try {
    const profile = await window.authService.getUserProfile();
    if (!profile || !profile.phone) {
      throw new Error('Please add a phone number to your profile first (in the Basic Info tab)');
    }

    const response = await window.authService.authenticatedFetch('/api/homeowners/verify-phone', {
      method: 'POST',
      body: JSON.stringify({})
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Failed to send verification code');
    }

    // Show code input form
    document.getElementById('phoneVerificationForm').style.display = 'none';
    document.getElementById('codeVerificationForm').style.display = 'block';

    // In development, show the code
    if (data.code) {
      statusMessage.textContent = `üì± Development Mode: Your verification code is ${data.code}`;
      statusMessage.style.color = '#2563eb';
    } else {
      statusMessage.textContent = 'üì≤ Verification code sent! Check your phone.';
      statusMessage.style.color = '#10b981';
    }

  } catch (err) {
    console.error('Error sending verification code:', err);
    statusMessage.textContent = `‚ùå ${err.message}`;
    statusMessage.style.color = '#ef4444';
    verifyButton.disabled = false;
    verifyButton.textContent = 'Send Verification Code';
  }
}

async function confirmVerificationCode() {
  const confirmButton = document.getElementById('confirmCodeButton');
  const statusMessage = document.getElementById('notificationsStatusMessage');
  const code = document.getElementById('verificationCode').value.trim();

  if (!code || code.length !== 6) {
    statusMessage.textContent = '‚ùå Please enter a 6-digit code';
    statusMessage.style.color = '#ef4444';
    return;
  }

  confirmButton.disabled = true;
  confirmButton.textContent = 'Verifying...';

  try {
    const response = await window.authService.authenticatedFetch('/api/homeowners/confirm-phone', {
      method: 'POST',
      body: JSON.stringify({ code })
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Invalid verification code');
    }

    // Success! Phone is now verified
    statusMessage.textContent = '‚úÖ Phone verified successfully!';
    statusMessage.style.color = '#10b981';

    // Hide code form, show verified banner
    document.getElementById('codeVerificationForm').style.display = 'none';
    document.getElementById('phoneVerifiedBanner').style.display = 'block';

    const profile = await window.authService.getUserProfile();
    document.getElementById('verifiedPhoneDisplay').textContent = profile.phone || '';

    // Enable SMS checkbox
    document.getElementById('smsNotifications').disabled = false;
    document.getElementById('smsDisabledWarning').style.display = 'none';

    // Clear code input
    document.getElementById('verificationCode').value = '';

    // Reload preferences
    setTimeout(() => {
      loadNotificationPreferences();
    }, 1000);

  } catch (err) {
    console.error('Error confirming verification code:', err);
    statusMessage.textContent = `‚ùå ${err.message}`;
    statusMessage.style.color = '#ef4444';
    confirmButton.disabled = false;
    confirmButton.textContent = 'Verify Code';
  }
}

function cancelVerification() {
  document.getElementById('codeVerificationForm').style.display = 'none';
  document.getElementById('phoneVerificationForm').style.display = 'block';
  document.getElementById('verificationCode').value = '';
  document.getElementById('verifyPhoneButton').disabled = false;
  document.getElementById('verifyPhoneButton').textContent = 'Send Verification Code';
  document.getElementById('notificationsStatusMessage').textContent = '';
}

// ========================================
// Activity Stats Functions
// ========================================

async function loadActivityStats() {
  try {
    const user = await window.authService.getCurrentUser();
    if (!user) return;

    // Set member since date
    const memberSinceEl = document.getElementById('memberSince');
    const activityEmailEl = document.getElementById('activityEmail');

    if (user.created_at) {
      const date = new Date(user.created_at);
      memberSinceEl.textContent = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    }

    activityEmailEl.textContent = user.email;

    // Fetch job statistics
    const response = await window.authService.authenticatedFetch(
      `/api/homeowner/stats?email=${encodeURIComponent(user.email)}`
    );

    if (response.ok) {
      const stats = await response.json();
      document.getElementById('totalJobs').textContent = stats.total_jobs || 0;
      document.getElementById('activeJobs').textContent = stats.active_jobs || 0;
      document.getElementById('totalBids').textContent = stats.total_bids || 0;
      document.getElementById('completedJobs').textContent = stats.completed_jobs || 0;
    }

  } catch (err) {
    console.error('Error loading activity stats:', err);
  }
}

// ========================================
// Profile Form Handling
// ========================================

(function() {
    'use strict';

    const profileForm = document.getElementById('profileForm');
    const saveButton = document.getElementById('saveButton');
    const statusMessage = document.getElementById('statusMessage');

    async function checkAuth() {
        try {
            // Wait for authService to be ready
            if (!window.authService || !window.authService.initialized) {
                await new Promise(resolve => {
                    const checkInterval = setInterval(() => {
                        if (window.authService && window.authService.initialized) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                });
            }

            const user = await window.authService.getCurrentUser();
            if (!user) {
                console.log('No user found - navigation will handle redirect');
                return false;
            }

            const userProfile = await window.authService.getUserProfile();
            if (!userProfile || userProfile.role !== 'homeowner') {
                console.log('Not a homeowner - navigation will handle redirect');
                return false;
            }

            return true;
        } catch (error) {
            console.error('Auth check failed:', error);
            return false;
        }
    }

    async function loadProfile() {
        try {
            const user = await window.authService.getCurrentUser();
            const profile = await window.authService.getUserProfile();

            if (user) {
                document.getElementById('email').value = user.email;
            }

            if (profile) {
                if (profile.first_name) document.getElementById('firstName').value = profile.first_name;
                if (profile.last_name) document.getElementById('lastName').value = profile.last_name;
                if (profile.phone) document.getElementById('phone').value = profile.phone;
                if (profile.street) document.getElementById('street').value = profile.street;
                if (profile.city) document.getElementById('city').value = profile.city;
                if (profile.state) document.getElementById('state').value = profile.state;
                if (profile.zip_code) document.getElementById('zipCode').value = profile.zip_code;
            }
        } catch (err) {
            console.error('Error loading profile:', err);
        }
    }

    profileForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        saveButton.disabled = true;
        saveButton.textContent = 'Saving...';
        statusMessage.textContent = '';

        try {
            const user = await window.authService.getCurrentUser();
            if (!user) {
                throw new Error('Not logged in');
            }

            const profileData = {
                first_name: document.getElementById('firstName').value.trim(),
                last_name: document.getElementById('lastName').value.trim(),
                full_name: `${document.getElementById('firstName').value.trim()} ${document.getElementById('lastName').value.trim()}`.trim(),
                phone: document.getElementById('phone').value.trim(),
                street: document.getElementById('street').value.trim(),
                city: document.getElementById('city').value.trim(),
                state: document.getElementById('state').value.trim(),
                zip_code: document.getElementById('zipCode').value.trim(),
                profile_complete: true
            };

            // Update Supabase database
            const response = await window.authService.authenticatedFetch('/api/profile/update', {
                method: 'PUT',
                body: JSON.stringify(profileData)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to save profile');
            }

            statusMessage.textContent = '‚úÖ Profile saved successfully!';
            statusMessage.style.color = '#10b981';

            // Update phone number in notification tab
            const phoneInput = document.getElementById('phoneNumber');
            if (phoneInput) {
                phoneInput.value = profileData.phone;
            }

            setTimeout(() => {
                statusMessage.textContent = '';
            }, 3000);

        } catch (err) {
            console.error('Error saving profile:', err);
            statusMessage.textContent = '‚ùå Error: ' + err.message;
            statusMessage.style.color = '#ef4444';
        } finally {
            saveButton.disabled = false;
            saveButton.textContent = 'Save Profile';
        }
    });

    // Initialize with async auth check
    checkAuth().then(isAuthenticated => {
        if (isAuthenticated) {
            loadProfile();
        }
    });
})();

// ========================================
// Delete Account Functions
// ========================================

function openDeleteAccountModal() {
  const modal = document.getElementById('deleteAccountModal');
  const confirmButton = document.getElementById('confirmDeleteButton');
  const confirmInput = document.getElementById('deleteConfirmation');

  // Reset modal state
  confirmInput.value = '';
  confirmButton.disabled = true;

  // Show modal
  modal.classList.add('active');

  // Focus input
  setTimeout(() => confirmInput.focus(), 100);
}

function closeDeleteAccountModal() {
  const modal = document.getElementById('deleteAccountModal');
  modal.classList.remove('active');
}

// Enable/disable confirm button based on input
document.addEventListener('DOMContentLoaded', function() {
  const confirmInput = document.getElementById('deleteConfirmation');
  const confirmButton = document.getElementById('confirmDeleteButton');

  if (confirmInput && confirmButton) {
    confirmInput.addEventListener('input', function() {
      const value = this.value.trim();
      confirmButton.disabled = value !== 'DELETE';
    });
  }

  // Close modal on overlay click
  const modal = document.getElementById('deleteAccountModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeDeleteAccountModal();
      }
    });
  }

  // Close modal on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modal = document.getElementById('deleteAccountModal');
      if (modal && modal.classList.contains('active')) {
        closeDeleteAccountModal();
      }
    }
  });
});

async function confirmDeleteAccount() {
  const confirmButton = document.getElementById('confirmDeleteButton');
  const confirmInput = document.getElementById('deleteConfirmation');

  // Validate input
  if (confirmInput.value.trim() !== 'DELETE') {
    alert('Please type DELETE to confirm account deletion');
    return;
  }

  // Disable button and show loading state
  confirmButton.disabled = true;
  confirmButton.textContent = 'Deleting Account...';

  try {
    const user = await window.authService.getCurrentUser();
    if (!user) {
      throw new Error('Not logged in');
    }

    // Call backend API to delete account
    const response = await window.authService.authenticatedFetch('/api/user/delete', {
      method: 'DELETE',
      body: JSON.stringify({
        email: user.email,
        confirmation: 'DELETE'
      })
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to delete account');
    }

    // Success! Account deleted
    console.log('Account deleted successfully');

    // Close modal
    closeDeleteAccountModal();

    // Sign out user
    await window.authService.signOut();

    // Redirect to landing page with goodbye message
    sessionStorage.setItem('account_deleted', 'true');
    window.location.href = '/index.html';

  } catch (error) {
    console.error('Error deleting account:', error);
    alert(`Failed to delete account: ${error.message}`);
    confirmButton.disabled = false;
    confirmButton.textContent = 'Delete My Account';
  }
}
</script>

<!-- Unified Navigation Component -->
<script src="components/navigation.js"></script>
</body>
</html>
