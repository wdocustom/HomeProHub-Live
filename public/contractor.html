<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HomeProHub â€“ Contractor Tools</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Darker, more "pro" hero just for contractors */
    .hero-contractor {
      background: linear-gradient(to right, #020617, #0b1120, #111827);
      color: #e5e7eb;
      padding: 40px 24px;
      margin-bottom: 32px;
    }
    .hero-inner {
      max-width: 900px;
      margin: 0 auto;
    }
    .hero-kicker {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #9ca3af;
      margin-bottom: 6px;
    }
    .hero-title {
      font-size: 30px;
      font-weight: 700;
      letter-spacing: -0.03em;
      margin-bottom: 8px;
      color: #f9fafb;
    }
    .hero-subtitle {
      font-size: 14px;
      line-height: 1.7;
      color: #9ca3af;
      max-width: 620px;
    }

    /* Plan badges for contractors */
    .tier-pill {
      display: inline-block;
      margin-left: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      color: #4b5563;
      white-space: nowrap;
    }
    .tier-pill--starter {
      border-color: #4ade80;
      background: #ecfdf5;
      color: #166534;
    }
    .tier-pill--pro {
      border-color: #60a5fa;
      background: #eff6ff;
      color: #1d4ed8;
    }
    .tier-pill--elite {
      border-color: #c4b5fd;
      background: #f5f3ff;
      color: #5b21b6;
    }

    .contractor-grid {
      max-width: 900px;
      margin: 0 auto 60px;
      padding: 0 24px;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2.4fr);
      gap: 20px;
    }

    @media (max-width: 860px) {
      .contractor-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .clarify-label {
      font-size: 12px;
      color: #4b5563;
      margin-top: 16px;
      margin-bottom: 4px;
    }
    .clarify-box {
      width: 100%;
      min-height: 80px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 13px;
      resize: vertical;
    }
  </style>
</head>
<body>

<header class="navbar">
  <div class="nav-inner">
    <div class="brand-area">
      <div class="brand-logo">H</div>
      <div class="brand-name">HomeProHub</div>
    </div>
    <div class="nav-links">
      <div class="profile-area">
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
</header>

<!-- Dark, pro-focused hero band -->
<section class="hero-contractor">
  <div class="hero-inner">
    <div class="hero-kicker">For contractors & trades</div>
    <h1 class="hero-title">Estimate better. Run tighter. Handle tougher jobs.</h1>
    <p class="hero-subtitle">
      Use HomeProHub as a second brain for bids, scope, field decisions, and building a real operation.
      Itâ€™s built for GCs, remodelers, and trades who want fewer surprises and stronger numbers.
    </p>
  </div>
</section>

<main>
  <!-- Two-column layout: features + contractor coach -->
  <section class="contractor-grid">
    <!-- Left card: features + tiers -->
    <div class="card">
      <h2 style="margin-top:0; margin-bottom:8px;">What you can do here</h2>
      <p style="margin:0 0 10px; font-size:14px; color:#4b5563;">
        Plans: <strong>Starter (Free)</strong>, <strong>Pro</strong>, <strong>Elite</strong>
      </p>

      <ul style="margin: 8px 0 6px 20px; padding: 0; color: #4b5563; font-size: 14px; line-height: 1.6;">
        <li>
          <strong>Price jobs with confidence:</strong>
          Break work into clear scope, allowances, and exclusions so your numbers hold up.
          <span class="tier-pill tier-pill--starter">Starter / Pro / Elite</span>
        </li>
        <li>
          <strong>Field support on tough projects:</strong>
          Ask trade-specific questions or diagnose issues with photos and a few details.
          <span class="tier-pill tier-pill--starter">Starter / Pro / Elite</span>
        </li>
        <li>
          <strong>Licensing & setup done right:</strong>
          Help getting licensed in your jurisdiction, plus what you need afterâ€”insurance, bond, registrations.
          <span class="tier-pill tier-pill--pro">Pro & Elite</span>
        </li>
        <li>
          <strong>Build a real operation:</strong>
          Guidance on branding, uniforms, logo, website, project management tools, and customer financing options.
          <span class="tier-pill tier-pill--pro">Pro & Elite</span>
        </li>
        <li>
          <strong>Access to experts:</strong>
          Tap into designers, architects, engineers, and 1-on-1 business coaching when jobs get complex.
          <span class="tier-pill tier-pill--elite">Elite</span>
        <li style="margin-top: 10px; border-top: 1px solid #e5e7eb; padding-top: 8px;">
  <a href="homeowner-grading-directory.html"" style="color: #2563eb; text-decoration: none;">
    <strong>Homeowner Grading Directory:</strong>
    Filter job leads by homeowner communication, decision speed, and payment reliability grade.
  </a>
  <span class="tier-pill tier-pill--pro">Pro & Elite</span>
</li>
      </ul>
    </div>

    <!-- Right card: Contractor Coach tool -->
    <div class="card">
      <h2 style="margin-top:0; margin-bottom:8px;">Contractor Coach</h2>
      <p style="margin:0 0 12px; font-size:14px; color:#4b5563;">
        Describe the job, client situation, or business problem youâ€™re dealing with.
        The coach responds like a seasoned GC or trade business mentor.
      </p>
      <p class="small-text" style="margin-top:0; margin-bottom:14px;">
        Contractor Coach (AI) is available on all plans: <strong>Starter</strong>, <strong>Pro</strong>, and <strong>Elite</strong>.
      </p>

      <label for="focus" style="font-size:12px; color:#4b5563;">What do you need help with?</label>
      <select id="focus">
        <option value="general">General contractor / project advice</option>
        <option value="pricing">Pricing & estimating</option>
        <option value="materials">Materials & methods</option>
        <option value="licensing">Licensing, insurance & compliance</option>
        <option value="client_comms">Client communication & expectations</option>
        <option value="business">Business systems & profitability</option>
      </select>

      <label for="zip" style="font-size:12px; color:#4b5563;">Job ZIP code (Required for estimate):</label>
      <input id="zip" type="text" placeholder="e.g. 33602" required />
      
      <label for="scopeLevel" style="font-size:12px; color:#4b5563;">Material & Finish Level</label>
      <select id="scopeLevel">
        <option value="budget">Budget / Builder Grade</option>
        <option value="mid">Mid-Range / Standard</option>
        <option value="high">High-End / Custom</option>
      </select>

      <label for="size" style="font-size:12px; color:#4b5563; margin-top:8px;">Project Size/Units (e.g., 200 sq ft, 5x8 bath)</label>
      <input id="size" type="text" placeholder="e.g. 150 sq ft of tiling, or 6x10 kitchen" />

      <label for="question" style="font-size:12px; color:#4b5563;">Describe the situation (What exactly needs to be done?):</label>
      <textarea
        id="question"
        placeholder="Example: Full master bath remodel. Client wants custom glass shower enclosure, heated floors, and mid-range tile."
      ></textarea>

      <div style="margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button id="askBtn" class="btn-primary">ðŸ§° Ask Coach</button>
        <div id="status" class="status"></div>
      </div>

      <div id="answer" class="answer-box"></div>

    </div>
  </section>
</main>

<script>
(function() {
  'use strict';

  // DOM elements
  const askButton = document.getElementById("askBtn");
  const textarea = document.getElementById("question");
  const statusText = document.getElementById("status");
  const answerBox = document.getElementById("answer");
  const focusSelect = document.getElementById("focus");
  const zipInput = document.getElementById("zip");
  const scopeLevelSelect = document.getElementById("scopeLevel");
  const sizeInput = document.getElementById("size");

  // Constants
  const MAX_QUESTION_LENGTH = 5000;
  const ZIP_CODE_REGEX = /^\d{5}$/;

  // State
  let lastQuestion = null;
  let lastFocus = null;
  let lastZip = null;
  let lastEstimateData = null;
  let profile = null;

  // Utility: Sanitize user input
  function sanitizeInput(input) {
    if (!input || typeof input !== 'string') return '';
    return input.trim().slice(0, MAX_QUESTION_LENGTH);
  }

  // Utility: Validate ZIP code
  function validateZipCode(zip) {
    return ZIP_CODE_REGEX.test(zip);
  }

  // Auth: Get profile data
  function getProfileData(runRedirect = true) {
    try {
      const username = localStorage.getItem('homeprohub_username');
      const token = localStorage.getItem('homeprohub_auth_token');
      const rawRole = localStorage.getItem("homeprohub_user_role");
      const rawProfile = localStorage.getItem('homeprohub_contractor_profile');

      if (!username || !token || rawRole !== 'contractor') {
        if (runRedirect) window.location.href = "index.html";
        return null;
      }

      const profile = rawProfile ? JSON.parse(rawProfile) : {};

      if (!profile.profileComplete) {
        if (runRedirect) window.location.href = "contractor-profile.html";
        return null;
      }

      return {
        ...profile,
        username: username,
        token: token,
        role: rawRole,
        name: profile.companyName || username.split('@')[0]
      };

    } catch (e) {
      if (runRedirect) window.location.href = "index.html";
      return null;
    }
  }

  // Auth: Logout
  function logout() {
    try {
      localStorage.removeItem("homeprohub_username");
      localStorage.removeItem("homeprohub_auth_token");
      localStorage.removeItem("homeprohub_user_role");
      localStorage.removeItem("homeprohub_contractor_profile");
      localStorage.removeItem("homeprohub_profile_complete");
      localStorage.removeItem("homeprohub_history_v1");
    } catch (e) {
      // Silent error
    }
    window.location.href = "index.html";
  }
  window.logout = logout;

  // Initialize profile
  profile = getProfileData();

  // PDF: Generate estimate
  function generatePdfEstimate(data) {
    try {
      if (!data || !data.line_items) {
        throw new Error('Invalid estimate data');
      }

      const printWindow = window.open('', '', 'height=800,width=800');
      if (!printWindow) {
        throw new Error('Could not open print window. Please allow pop-ups.');
      }

      const contractorName = profile && profile.companyName ? profile.companyName : 'HomeProHub Contractor';
      const contractorLicense = profile && profile.license ? profile.license : 'N/A';
      const contractorZip = profile && profile.zipCode ? profile.zipCode : 'N/A';

      const lineItemsHtml = data.line_items.map(item => {
        const itemName = sanitizeInput(item.item || 'Unknown Item');
        const lowPrice = typeof item.low === 'number' ? item.low : 0;
        const highPrice = typeof item.high === 'number' ? item.high : 0;
        const notes = sanitizeInput(item.notes || '-');

        return `
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;">${itemName}</td>
            <td style="padding: 8px; border: 1px solid #ddd;">$${lowPrice.toLocaleString()} - $${highPrice.toLocaleString()}</td>
            <td style="padding: 8px; border: 1px solid #ddd;">${notes}</td>
          </tr>
        `;
      }).join('');

      const disclaimersHtml = (data.disclaimers || []).map(d => `<li>${sanitizeInput(d)}</li>`).join('');

      const templateHtml = `
        <html>
          <head>
            <title>${sanitizeInput(data.project_title || 'Project Estimate')}</title>
            <style>
              body { font-family: sans-serif; padding: 20px; color: #1f2937; }
              h1 { color: #2563eb; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; }
              .header-info { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 20px; }
              .table-container { width: 100%; border-collapse: collapse; margin-top: 15px; }
              .table-container th { background-color: #f3f4f6; text-align: left; padding: 10px; border: 1px solid #ddd; }
              .total-row { font-weight: bold; background-color: #e5e7eb; }
            </style>
          </head>
          <body>
            <div class="header-info">
              <div>
                <strong>Contractor:</strong> ${contractorName}<br>
                <strong>License:</strong> ${contractorLicense}<br>
                <strong>Service Area:</strong> ${contractorZip}
              </div>
              <div>
                <strong>Date:</strong> ${new Date().toLocaleDateString()}<br>
                <strong>Estimate ID:</strong> HPH-${Math.floor(Math.random() * 90000) + 10000}
              </div>
            </div>
            <h1>Estimate: ${sanitizeInput(data.project_title || 'Project Estimate')}</h1>

            <h3>Line Item Breakdown (Rough Estimate)</h3>
            <table class="table-container">
              <thead>
                <tr>
                  <th style="width: 40%;">Item / Service</th>
                  <th style="width: 30%;">Low - High Range</th>
                  <th style="width: 30%;">Notes</th>
                </tr>
              </thead>
              <tbody>
                ${lineItemsHtml}
                <tr><td colspan="3" style="height: 10px;"></td></tr>
                <tr class="total-row"><td colspan="2" style="text-align: right; padding: 8px;">Subtotal (Labor & Materials)</td><td style="padding: 8px;">$${(data.subtotal_low || 0).toLocaleString()} - $${(data.subtotal_high || 0).toLocaleString()}</td></tr>
                <tr><td colspan="2" style="text-align: right; padding: 5px;">Overhead & Profit (${data.overhead_profit_percent || 0}%)</td><td style="padding: 5px;"></td></tr>
                <tr><td colspan="2" style="text-align: right; padding: 5px;">Contingency (${data.contingency_percent || 0}%)</td><td style="padding: 5px;"></td></tr>
                <tr><td colspan="3" style="height: 10px;"></td></tr>
                <tr class="total-row" style="background-color: #bfdbfe;"><td colspan="2" style="text-align: right; padding: 8px;">TOTAL ESTIMATE RANGE</td><td style="padding: 8px;">$${(data.total_projected_low || 0).toLocaleString()} - $${(data.total_projected_high || 0).toLocaleString()}</td></tr>
              </tbody>
            </table>

            <h3 style="margin-top: 30px;">Disclaimers</h3>
            <ul style="font-size: 12px; color: #4b5563;">
              ${disclaimersHtml}
              <li>This document is a computer-generated budget estimate, not a binding quote.</li>
            </ul>
          </body>
        </html>
      `;

      printWindow.document.write(templateHtml);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    } catch (e) {
      alert(e.message || 'Failed to generate PDF estimate');
    }
  }

  // Email: Send estimate
  function emailEstimate(data) {
    try {
      if (!data || !data.project_title) {
        throw new Error('Invalid estimate data');
      }

      const contractorName = profile && profile.companyName ? profile.companyName : 'HomeProHub Contractor';
      const subject = `Rough Estimate: ${sanitizeInput(data.project_title || 'Your Project')}`;
      const body = `
Dear Customer,

Project: ${sanitizeInput(data.project_title)}
Total Estimated Range: $${(data.total_projected_low || 0).toLocaleString()} - $${(data.total_projected_high || 0).toLocaleString()}
---

Please note that this is a non-binding ballpark figure created for initial budgeting. A formal, binding quote will require a site visit to assess all existing conditions and final material selections.

We look forward to speaking with you!

Best regards,
${contractorName}
${profile && profile.license ? 'License: ' + profile.license : ''}
`;

      window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    } catch (e) {
      alert(e.message || 'Failed to create email');
    }
  }

  // UI: Render estimate controls
  function renderEstimateControls(data, isUpdate = false) {
    try {
      if (!data) return;

      let controlsContainer = document.getElementById('pdfEmailControlsContainer');
      if (!controlsContainer) {
        controlsContainer = document.createElement('div');
        controlsContainer.id = 'pdfEmailControlsContainer';
        controlsContainer.style.cssText = 'margin-top: 15px; border-top: 1px solid #e5e7eb; padding-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;';

        const mainAnswerBox = document.getElementById("answer");
        if (mainAnswerBox && mainAnswerBox.parentNode) {
          mainAnswerBox.parentNode.insertBefore(controlsContainer, mainAnswerBox.nextSibling);
        } else {
          return;
        }
      }

      controlsContainer.innerHTML = '';

      const pdfBtn = document.createElement('button');
      pdfBtn.className = 'btn-primary';
      pdfBtn.textContent = 'ðŸ“„ Download PDF Estimate';
      pdfBtn.addEventListener('click', () => generatePdfEstimate(data));
      controlsContainer.appendChild(pdfBtn);

      const emailBtn = document.createElement('button');
      emailBtn.className = 'btn-secondary';
      emailBtn.textContent = 'âœ‰ï¸ Email to Customer';
      emailBtn.addEventListener('click', () => emailEstimate(data));
      controlsContainer.appendChild(emailBtn);

      lastEstimateData = data;

      if (statusText) statusText.textContent = isUpdate ? 'Updated' : 'Done.';
      if (askButton) askButton.textContent = 'Update';
    } catch (e) {
      // Silent error
    }
  }

  // API: Ask contractor backend
  async function askContractorBackend(question, focus, zip, scopeLevel, size) {
    const sanitizedQuestion = sanitizeInput(question);

    if (!sanitizedQuestion) {
      throw new Error('Question cannot be empty');
    }

    if (!profile || !profile.token) {
      throw new Error('Authentication required');
    }

    const response = await fetch("/contractor-ask", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${profile.token}`
      },
      body: JSON.stringify({
        question: sanitizedQuestion,
        focus: focus || 'general',
        zip: zip || '',
        scopeLevel: scopeLevel || 'mid',
        size: size || ''
      })
    });

    if (!response.ok) {
      const data = await response.json().catch(() => ({}));
      throw new Error(data.error || `Request failed (${response.status})`);
    }

    const data = await response.json();
    return data;
  }

  // Main ask handler
  if (askButton) {
    askButton.addEventListener("click", async () => {
      if (!profile) {
        window.location.href = "contractor-profile.html";
        return;
      }

      const scopeLevel = scopeLevelSelect ? scopeLevelSelect.value : 'mid';
      const size = sizeInput ? sizeInput.value.trim() : '';
      const q = textarea ? textarea.value.trim() : '';
      const focus = focusSelect ? focusSelect.value : 'general';
      const zip = zipInput ? zipInput.value.trim() : '';

      if (!q) {
        if (answerBox) answerBox.textContent = "Please describe your situation first.";
        return;
      }

      if (q.length > MAX_QUESTION_LENGTH) {
        if (answerBox) answerBox.textContent = `Question is too long. Maximum ${MAX_QUESTION_LENGTH} characters.`;
        return;
      }

      if (focus === 'pricing' && !validateZipCode(zip)) {
        if (answerBox) answerBox.textContent = "Valid 5-digit ZIP code is required for pricing estimates.";
        return;
      }

      // Disable inputs
      askButton.disabled = true;
      if (textarea) textarea.disabled = true;
      if (focusSelect) focusSelect.disabled = true;
      if (zipInput) zipInput.disabled = true;
      if (scopeLevelSelect) scopeLevelSelect.disabled = true;
      if (sizeInput) sizeInput.disabled = true;

      if (statusText) statusText.textContent = "Processing your request...";
      if (answerBox) answerBox.textContent = "";

      try {
        const response = await askContractorBackend(q, focus, zip, scopeLevel, size);

        if (response.format === 'json' && focus === 'pricing') {
          if (answerBox) {
            answerBox.textContent = "âœ… Estimate Generated! (See Controls Below)";
            answerBox.style.whiteSpace = 'normal';
          }
          renderEstimateControls(response.answer, false);

          lastQuestion = q;
          lastFocus = focus;
          lastZip = zip;

        } else {
          if (answerBox) answerBox.textContent = response.answer || 'No response received.';

          const controlsContainer = document.getElementById('pdfEmailControlsContainer');
          if (controlsContainer) controlsContainer.innerHTML = '';

          lastQuestion = q;
          lastFocus = focus;
          lastZip = zip;
        }

        if (statusText) statusText.textContent = 'Done.';
        if (askButton) askButton.textContent = 'Ask Again';

      } catch (err) {
        if (answerBox) {
          answerBox.textContent = err.message || "Unable to process your request. Please try again.";
        }
        if (statusText) statusText.textContent = "";

        const controlsContainer = document.getElementById('pdfEmailControlsContainer');
        if (controlsContainer) controlsContainer.innerHTML = '';

        if (askButton) askButton.textContent = 'Ask Coach';
      } finally {
        askButton.disabled = false;
        if (textarea) textarea.disabled = false;
        if (focusSelect) focusSelect.disabled = false;
        if (zipInput) zipInput.disabled = false;
        if (scopeLevelSelect) scopeLevelSelect.disabled = false;
        if (sizeInput) sizeInput.disabled = false;
      }
    });
  }

})();
</script>
</body>
</html>
