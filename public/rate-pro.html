<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leave a Review | HomeProHub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

  <!-- Header -->
  <header class="bg-white border-b border-slate-200">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex items-center gap-3">
        <i class="fa-solid fa-house text-2xl text-blue-600"></i>
        <span class="text-xl font-extrabold text-slate-900 tracking-tight">HomeProHub</span>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-20">
      <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
      <p class="text-slate-500 font-medium">Loading contractor profile...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden">
      <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden p-12 text-center">
        <i class="fa-solid fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
        <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight mb-3">Contractor Not Found</h1>
        <p class="text-lg text-slate-500 font-medium mb-6">This review link may be invalid or expired.</p>
        <a href="/" class="inline-block px-6 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-600/20 hover:scale-105 transition-transform">
          Go to HomeProHub
        </a>
      </div>
    </div>

    <!-- Contractor Profile & Review Form -->
    <div id="contentState" class="hidden">

      <!-- Contractor Card -->
      <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden mb-8">
        <div class="p-8 sm:p-12">
          <div class="flex flex-col sm:flex-row items-center sm:items-start gap-6 mb-8">
            <!-- Avatar -->
            <div class="w-24 h-24 rounded-full overflow-hidden bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center flex-shrink-0" id="avatarContainer">
              <i class="fa-solid fa-user text-4xl text-blue-600"></i>
            </div>

            <!-- Info -->
            <div class="flex-1 text-center sm:text-left">
              <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-900 tracking-tight mb-2" id="companyName">
                Loading...
              </h1>
              <p class="text-lg text-slate-500 font-medium mb-4" id="displayName"></p>

              <!-- Stats -->
              <div class="flex flex-wrap justify-center sm:justify-start gap-4 text-sm">
                <div class="flex items-center gap-2 text-slate-600">
                  <i class="fa-solid fa-calendar text-blue-600"></i>
                  <span class="font-medium">Member since <span id="memberSince" class="font-bold">2024</span></span>
                </div>
                <div class="flex items-center gap-2 text-slate-600" id="licenseVerified" style="display: none;">
                  <i class="fa-solid fa-badge-check text-green-600"></i>
                  <span class="font-bold">License Verified</span>
                </div>
                <div class="flex items-center gap-2 text-slate-600" id="insuranceVerified" style="display: none;">
                  <i class="fa-solid fa-shield-check text-green-600"></i>
                  <span class="font-bold">Insured</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Bio -->
          <div id="bioSection" class="hidden">
            <div class="bg-slate-50 rounded-2xl p-6">
              <p class="text-slate-700 font-medium leading-relaxed" id="bioText"></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Review Form -->
      <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="p-8">
          <h2 class="text-2xl font-extrabold text-slate-900 tracking-tight mb-2">Leave a Review</h2>
          <p class="text-slate-500 font-medium mb-8">
            Your feedback helps other homeowners make informed decisions.
          </p>

          <form id="reviewForm">
            <!-- Your Name -->
            <div class="mb-6">
              <label for="reviewerName" class="block text-sm font-bold text-slate-700 mb-2">
                Your Name *
              </label>
              <input
                type="text"
                id="reviewerName"
                required
                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-slate-900"
                placeholder="John Smith"
              />
            </div>

            <!-- Your Email -->
            <div class="mb-6">
              <label for="reviewerEmail" class="block text-sm font-bold text-slate-700 mb-2">
                Your Email *
              </label>
              <input
                type="email"
                id="reviewerEmail"
                required
                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-slate-900"
                placeholder="john@example.com"
              />
              <p class="mt-2 text-xs text-slate-500">We'll never share your email publicly</p>
            </div>

            <!-- Overall Rating -->
            <div class="mb-8">
              <label class="block text-sm font-bold text-slate-700 mb-3">
                Overall Rating *
              </label>
              <div class="flex gap-3">
                <label class="flex-1 relative cursor-pointer">
                  <input type="radio" name="overall_rating" value="1" required class="peer sr-only" />
                  <div class="h-16 flex flex-col items-center justify-center border-2 border-slate-300 rounded-xl peer-checked:border-blue-600 peer-checked:bg-blue-50 transition-all">
                    <i class="fa-solid fa-star text-2xl text-slate-400 peer-checked:text-blue-600"></i>
                    <span class="text-xs font-bold text-slate-600 mt-1">1</span>
                  </div>
                </label>
                <label class="flex-1 relative cursor-pointer">
                  <input type="radio" name="overall_rating" value="2" class="peer sr-only" />
                  <div class="h-16 flex flex-col items-center justify-center border-2 border-slate-300 rounded-xl peer-checked:border-blue-600 peer-checked:bg-blue-50 transition-all">
                    <i class="fa-solid fa-star text-2xl text-slate-400 peer-checked:text-blue-600"></i>
                    <span class="text-xs font-bold text-slate-600 mt-1">2</span>
                  </div>
                </label>
                <label class="flex-1 relative cursor-pointer">
                  <input type="radio" name="overall_rating" value="3" class="peer sr-only" />
                  <div class="h-16 flex flex-col items-center justify-center border-2 border-slate-300 rounded-xl peer-checked:border-blue-600 peer-checked:bg-blue-50 transition-all">
                    <i class="fa-solid fa-star text-2xl text-slate-400 peer-checked:text-blue-600"></i>
                    <span class="text-xs font-bold text-slate-600 mt-1">3</span>
                  </div>
                </label>
                <label class="flex-1 relative cursor-pointer">
                  <input type="radio" name="overall_rating" value="4" class="peer sr-only" />
                  <div class="h-16 flex flex-col items-center justify-center border-2 border-slate-300 rounded-xl peer-checked:border-blue-600 peer-checked:bg-blue-50 transition-all">
                    <i class="fa-solid fa-star text-2xl text-slate-400 peer-checked:text-blue-600"></i>
                    <span class="text-xs font-bold text-slate-600 mt-1">4</span>
                  </div>
                </label>
                <label class="flex-1 relative cursor-pointer">
                  <input type="radio" name="overall_rating" value="5" class="peer sr-only" />
                  <div class="h-16 flex flex-col items-center justify-center border-2 border-slate-300 rounded-xl peer-checked:border-blue-600 peer-checked:bg-blue-50 transition-all">
                    <i class="fa-solid fa-star text-2xl text-slate-400 peer-checked:text-blue-600"></i>
                    <span class="text-xs font-bold text-slate-600 mt-1">5</span>
                  </div>
                </label>
              </div>
            </div>

            <!-- Written Review -->
            <div class="mb-8">
              <label for="reviewText" class="block text-sm font-bold text-slate-700 mb-2">
                Your Review *
              </label>
              <textarea
                id="reviewText"
                required
                rows="5"
                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-slate-900 resize-none"
                placeholder="Tell us about your experience working with this contractor..."
              ></textarea>
            </div>

            <!-- Submit Button -->
            <button
              type="submit"
              id="submitBtn"
              class="w-full px-8 py-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-600/20 hover:scale-105 transition-transform flex items-center justify-center gap-2"
            >
              <i class="fa-solid fa-paper-plane"></i>
              <span>Submit Review</span>
            </button>
          </form>

          <!-- Success Message -->
          <div id="successMessage" class="hidden mt-8 p-6 bg-green-50 border-2 border-green-200 rounded-2xl">
            <div class="flex items-start gap-4">
              <i class="fa-solid fa-circle-check text-3xl text-green-600 mt-1"></i>
              <div>
                <h3 class="text-xl font-bold text-green-900 mb-2">Thank You!</h3>
                <p class="text-green-700 font-medium">
                  Your review has been submitted successfully. It will be visible after verification.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

  </main>

  <!-- Footer -->
  <footer class="mt-16 py-8 border-t border-slate-200">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <p class="text-sm text-slate-500">
        Powered by <a href="/" class="font-bold text-blue-600 hover:text-blue-700">HomeProHub</a>
      </p>
    </div>
  </footer>

  <script>
    let contractorSlug = null;
    let contractorId = null;

    // Extract contractor slug from URL
    const urlParams = new URLSearchParams(window.location.search);
    contractorSlug = urlParams.get('contractor');

    if (!contractorSlug) {
      showError();
    } else {
      loadContractorProfile();
    }

    async function loadContractorProfile() {
      try {
        const response = await fetch(`/api/public/contractor/${contractorSlug}`);

        if (!response.ok) {
          throw new Error('Contractor not found');
        }

        const contractor = await response.json();
        contractorId = contractor.user_id;

        // Populate contractor info
        document.getElementById('companyName').textContent = contractor.company_name || 'Professional Contractor';

        if (contractor.display_name) {
          document.getElementById('displayName').textContent = contractor.display_name;
        }

        if (contractor.member_since_year) {
          document.getElementById('memberSince').textContent = contractor.member_since_year;
        }

        // Show avatar if exists
        if (contractor.avatar_url) {
          document.getElementById('avatarContainer').innerHTML = `
            <img src="${contractor.avatar_url}" alt="${contractor.company_name}" class="w-full h-full object-cover" />
          `;
        }

        // Show badges
        if (contractor.license_verified) {
          document.getElementById('licenseVerified').style.display = 'flex';
        }

        if (contractor.insurance_verified) {
          document.getElementById('insuranceVerified').style.display = 'flex';
        }

        // Show bio if exists
        if (contractor.bio) {
          document.getElementById('bioText').textContent = contractor.bio;
          document.getElementById('bioSection').classList.remove('hidden');
        }

        // Show content
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('contentState').classList.remove('hidden');

      } catch (error) {
        console.error('Error loading contractor:', error);
        showError();
      }
    }

    function showError() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').classList.remove('hidden');
    }

    // Handle review submission
    document.getElementById('reviewForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> <span>Submitting...</span>';

      try {
        const formData = {
          contractor_slug: contractorSlug,
          reviewer_name: document.getElementById('reviewerName').value,
          reviewer_email: document.getElementById('reviewerEmail').value,
          overall_rating: parseInt(document.querySelector('input[name="overall_rating"]:checked').value),
          review_text: document.getElementById('reviewText').value
        };

        const response = await fetch('/api/public/reviews/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to submit review');
        }

        // Show success message
        document.getElementById('reviewForm').style.display = 'none';
        document.getElementById('successMessage').classList.remove('hidden');

        // Scroll to success message
        document.getElementById('successMessage').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      } catch (error) {
        console.error('Error submitting review:', error);
        alert('Error: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> <span>Submit Review</span>';
      }
    });
  </script>
</body>
</html>
