<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Homeowner Dashboard ‚Äì HomeProHub</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="components/navigation.css" />
  <link rel="stylesheet" href="components/license-badge.css" />
  <style>
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 24px;
    }

    .dashboard-header {
      margin-bottom: 40px;
    }

    .dashboard-header h1 {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
      margin: 0 0 8px 0;
    }

    .dashboard-header p {
      color: #6b7280;
      font-size: 16px;
      margin: 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
    }

    .stat-card .stat-label {
      font-size: 13px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .stat-card .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }

    .stat-card .stat-change {
      font-size: 13px;
      color: #10b981;
    }

    .jobs-section {
      margin-bottom: 40px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-header h2 {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      margin: 0;
    }

    .filter-tabs {
      display: flex;
      gap: 8px;
    }

    .filter-tab {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: white;
      color: #6b7280;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-tab:hover {
      border-color: #2563eb;
      color: #2563eb;
    }

    .filter-tab.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }

    .job-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 16px;
      transition: all 0.2s;
    }

    .job-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .job-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .job-title {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
      margin: 0 0 8px 0;
    }

    .job-meta {
      display: flex;
      gap: 16px;
      font-size: 14px;
      color: #6b7280;
    }

    .job-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-badge.open {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-badge.in_progress {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.completed {
      background: #d1fae5;
      color: #065f46;
    }

    .job-description {
      color: #4b5563;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 16px;
    }

    .job-budget {
      font-size: 18px;
      font-weight: 700;
      color: #2563eb;
      margin-bottom: 16px;
    }

    .bids-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }

    .bids-header {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 16px;
    }

    .bid-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .bid-card.accepted {
      background: #d1fae5;
      border-color: #10b981;
    }

    .bid-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .contractor-name {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }

    .bid-amount {
      font-size: 18px;
      font-weight: 700;
      color: #2563eb;
    }

    .bid-details {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 12px;
    }

    .bid-message {
      font-size: 14px;
      color: #4b5563;
      background: white;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      line-height: 1.6;
    }

    .bid-actions {
      display: flex;
      gap: 8px;
    }

    .btn-accept {
      padding: 8px 16px;
      border-radius: 6px;
      background: #10b981;
      color: white;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-accept:hover {
      background: #059669;
    }

    .btn-message {
      padding: 8px 16px;
      border-radius: 6px;
      background: #2563eb;
      color: white;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-message:hover {
      background: #1d4ed8;
    }

    .btn-decline {
      padding: 8px 16px;
      border-radius: 6px;
      background: white;
      color: #ef4444;
      border: 1px solid #e5e7eb;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-decline:hover {
      background: #fef2f2;
      border-color: #ef4444;
    }

    .no-jobs {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }

    .no-jobs h3 {
      font-size: 18px;
      margin-bottom: 8px;
    }

    /* Contractor Grade Badges */
    .grade-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 700;
      margin-left: 8px;
      border: 2px solid;
    }

    .grade-A {
      background: #d1fae5;
      color: #065f46;
      border-color: #10b981;
    }

    .grade-B {
      background: #dbeafe;
      color: #1e40af;
      border-color: #3b82f6;
    }

    .grade-C {
      background: #fef3c7;
      color: #92400e;
      border-color: #f59e0b;
    }

    .grade-D {
      background: #fed7aa;
      color: #9a3412;
      border-color: #ea580c;
    }

    .grade-F {
      background: #fecaca;
      color: #991b1b;
      border-color: #ef4444;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .error-message {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    /* Job Posting Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 24px;
      overflow-y: auto;
    }
    .modal-overlay.show {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 32px;
      cursor: pointer;
      color: #9ca3af;
      line-height: 1;
    }
    .modal-close:hover {
      color: #1f2937;
    }
    .modal-title {
      font-size: 28px;
      font-weight: 700;
      color: #111827;
      margin: 0 0 8px 0;
    }
    .modal-subtitle {
      font-size: 15px;
      color: #6b7280;
      margin: 0 0 32px 0;
    }
    .btn-post-job {
      padding: 10px 24px;
      border-radius: 8px;
      background: #2563eb;
      color: white;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-post-job:hover {
      background: #1d4ed8;
    }
    .ai-badge-indicator {
      display: inline-block;
      padding: 4px 12px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <!-- Navigation component will be injected here by navigation.js -->

  <main>
    <div class="dashboard-container">
      <div class="dashboard-header">
        <h1>My Jobs & Projects</h1>
        <p>Track your job postings, review bids, and manage your home projects</p>
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Jobs Posted</div>
          <div class="stat-value" id="totalJobsStat">0</div>
          <div class="stat-change">All time</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Open Jobs</div>
          <div class="stat-value" id="openJobsStat">0</div>
          <div class="stat-change">Accepting bids</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Bids Received</div>
          <div class="stat-value" id="totalBidsStat">0</div>
          <div class="stat-change">From contractors</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">In Progress</div>
          <div class="stat-value" id="inProgressStat">0</div>
          <div class="stat-change">Active projects</div>
        </div>
      </div>

      <!-- Error Message -->
      <div id="errorMessage" class="error-message" style="display: none;"></div>

      <!-- Jobs Section -->
      <div class="jobs-section">
        <div class="section-header">
          <div>
            <h2>Your Posted Jobs</h2>
          </div>
          <div style="display: flex; gap: 12px; align-items: center;">
            <button class="btn-post-job" id="newJobBtn">
              ‚ûï Post New Job
            </button>
            <div class="filter-tabs">
              <button class="filter-tab active" data-filter="all">All</button>
              <button class="filter-tab" data-filter="open">Open</button>
              <button class="filter-tab" data-filter="in_progress">In Progress</button>
              <button class="filter-tab" data-filter="completed">Completed</button>
            </div>
          </div>
        </div>

        <div id="jobsContainer">
          <div class="loading">Loading your jobs...</div>
        </div>
      </div>
    </div>
  </main>

  <!-- Job Posting Modal -->
  <div class="modal-overlay" id="jobModal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeJobModal()">√ó</button>
      <h2 class="modal-title">Post a New Job</h2>
      <p class="modal-subtitle">Get competitive bids from verified contractors in your area</p>

      <form id="jobPostingForm">
        <div class="form-group">
          <label for="jobTitle">Job Title <span style="color: #ef4444;">*</span></label>
          <input type="text" id="jobTitle" placeholder="e.g., Fix leaking ceiling in bathroom" required maxlength="100" />
        </div>

        <div class="form-group">
          <label for="jobDescription">Description <span style="color: #ef4444;">*</span></label>
          <textarea id="jobDescription" rows="6" placeholder="Describe the issue, what needs to be done, and any relevant details..." required></textarea>
        </div>

        <div class="form-group">
          <label for="jobCategory">Category <span style="color: #ef4444;">*</span></label>
          <select id="jobCategory" required>
            <option value="">Select a category...</option>
            <option value="plumbing">Plumbing</option>
            <option value="electrical">Electrical</option>
            <option value="hvac">HVAC</option>
            <option value="roofing">Roofing</option>
            <option value="painting">Painting</option>
            <option value="flooring">Flooring</option>
            <option value="carpentry">Carpentry</option>
            <option value="landscaping">Landscaping</option>
            <option value="general">General Contracting</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label for="budgetLow">Budget (Low) <span style="color: #ef4444;">*</span></label>
            <input type="number" id="budgetLow" placeholder="500" required min="0" step="50" />
          </div>

          <div class="form-group">
            <label for="budgetHigh">Budget (High) <span style="color: #ef4444;">*</span></label>
            <input type="number" id="budgetHigh" placeholder="2000" required min="0" step="50" />
          </div>
        </div>

        <div class="form-group">
          <label for="zipCode">ZIP Code <span style="color: #ef4444;">*</span></label>
          <input type="text" id="zipCode" placeholder="62701" pattern="[0-9]{5}" maxlength="5" required />
        </div>

        <div class="form-group">
          <label for="urgency">Urgency <span style="color: #ef4444;">*</span></label>
          <select id="urgency" required>
            <option value="flexible">Flexible - No rush</option>
            <option value="soon">Soon - Within 2 weeks</option>
            <option value="urgent">Urgent - Within days</option>
            <option value="emergency">Emergency - Immediate</option>
          </select>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="aiAssisted" disabled />
            AI-Assisted Post
            <span class="ai-badge-indicator" id="aiBadge" style="display: none;">AI GENERATED</span>
          </label>
          <p style="font-size: 12px; color: #6b7280; margin: 4px 0 0 0;">
            This job post was created from your AI assistant analysis
          </p>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 32px;">
          <button type="submit" class="btn-primary" id="submitJobBtn">
            Post Job
          </button>
          <button type="button" class="btn-secondary" onclick="closeJobModal()">
            Cancel
          </button>
          <div id="jobFormStatus" style="margin-left: auto; align-self: center; font-size: 14px;"></div>
        </div>
      </form>
    </div>
  </div>

  <!-- Estimate Viewer Modal -->
  <div class="modal-overlay" id="estimateModal">
    <div class="modal-content" style="max-width: 900px;">
      <button class="modal-close" onclick="closeEstimateModal()">√ó</button>
      <h2 class="modal-title" id="estimateModalTitle">Professional Estimate</h2>
      <p class="modal-subtitle" id="estimateModalSubtitle">AI-Generated Detailed Breakdown</p>

      <div id="estimateContent" style="margin-top: 24px;">
        <!-- Estimate content will be dynamically inserted here -->
      </div>
    </div>
  </div>

  <script>
    // Constants
    const STORAGE_KEYS = {
      USERNAME: 'homeprohub_username',
      AUTH_TOKEN: 'homeprohub_auth_token',
      USER_ROLE: 'homeprohub_user_role',
      USER: 'homeprohub_user'
    };

    // State
    let allJobs = [];
    let currentFilter = 'all';
    let userEmail = '';

    // Auth - Wait for authService to be ready
    // Note: Auth redirects are handled by navigation.js
    async function checkAuth() {
      try {
        // Wait for authService to initialize
        if (!window.authService || !window.authService.initialized) {
          await new Promise(resolve => {
            const checkInterval = setInterval(() => {
              if (window.authService && window.authService.initialized) {
                clearInterval(checkInterval);
                resolve();
              }
            }, 100);
          });
        }

        // Check if user is authenticated
        const user = await window.authService.getCurrentUser();
        if (!user) {
          console.log('No user found - navigation will handle redirect');
          return false;
        }

        // Get profile to check role
        const profile = await window.authService.getUserProfile();
        if (!profile || profile.role !== 'homeowner') {
          console.log('Not a homeowner - navigation will handle redirect');
          return false;
        }

        // Set user email for API calls
        userEmail = user.email;

        // Update profile link if it exists
        const profileLink = document.getElementById('profileLink');
        if (profileLink) {
          profileLink.textContent = profile.full_name || user.email;
        }

        return true;
      } catch (error) {
        console.error('Auth check failed:', error);
        return false;
      }
    }

    // Initialize after auth check
    checkAuth().then(isAuthenticated => {
      if (isAuthenticated) {
        loadJobs();
      }
    });

    // Format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount);
    }

    // Format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;

      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // Load jobs
    async function loadJobs() {
      try {
        const response = await window.authService.authenticatedFetch(
          `/api/homeowner/jobs?email=${encodeURIComponent(userEmail)}`
        );

        if (!response.ok) {
          throw new Error('Failed to load jobs');
        }

        const data = await response.json();
        allJobs = data.jobs || [];

        updateStats();
        renderJobs();

      } catch (error) {
        console.error('Error loading jobs:', error);
        showError('Failed to load your jobs. Please try again.');
      }
    }

    // Update stats
    function updateStats() {
      document.getElementById('totalJobsStat').textContent = allJobs.length;
      document.getElementById('openJobsStat').textContent = allJobs.filter(j => j.status === 'open').length;

      const totalBids = allJobs.reduce((sum, job) => sum + (job.bids?.length || 0), 0);
      document.getElementById('totalBidsStat').textContent = totalBids;

      document.getElementById('inProgressStat').textContent = allJobs.filter(j => j.status === 'in_progress').length;
    }

    // Render jobs
    function renderJobs() {
      const container = document.getElementById('jobsContainer');

      let filteredJobs = allJobs;
      if (currentFilter !== 'all') {
        filteredJobs = allJobs.filter(job => job.status === currentFilter);
      }

      if (filteredJobs.length === 0) {
        container.innerHTML = `
          <div class="no-jobs">
            <h3>No jobs found</h3>
            <p>You haven't posted any jobs yet. Start by asking our AI assistant about your home issue!</p>
            <a href="ask.html" class="btn-primary" style="display: inline-block; margin-top: 16px;">Ask AI Assistant</a>
          </div>
        `;
        return;
      }

      container.innerHTML = filteredJobs.map(job => `
        <div class="job-card">
          <div class="job-card-header">
            <div>
              <h3 class="job-title">${escapeHtml(job.title)}</h3>
              <div class="job-meta">
                <span>üìç ${escapeHtml(job.address)}</span>
                <span>üìÖ Posted ${formatDate(job.posted_at)}</span>
                <span>üíº ${job.bids?.length || 0} bid${(job.bids?.length || 0) !== 1 ? 's' : ''}</span>
              </div>
            </div>
            <span class="status-badge ${job.status}">${job.status.replace('_', ' ')}</span>
          </div>

          <p class="job-description">${escapeHtml(job.description.substring(0, 200))}${job.description.length > 200 ? '...' : ''}</p>

          ${job.budget_low && job.budget_high ? `
            <div class="job-budget">
              Budget: ${formatCurrency(job.budget_low)} - ${formatCurrency(job.budget_high)}
            </div>
          ` : ''}

          ${job.bids && job.bids.length > 0 ? `
            <div class="bids-section">
              <div class="bids-header">${job.bids.length} Bid${job.bids.length !== 1 ? 's' : ''} Received</div>
              ${job.bids.map(bid => renderBid(bid, job)).join('')}
            </div>
          ` : '<p style="color: #9ca3af; font-size: 14px;">No bids received yet</p>'}
        </div>
      `).join('');

      // Add event listeners to bid action buttons
      attachBidActionListeners();
    }

    // Calculate contractor grade (A-F) based on profile data
    // TODO: Replace with actual backend grading when available
    function getContractorGrade(contractor) {
      if (!contractor) return 'C';

      let score = 0;

      // Years in business (0-40 points)
      const years = contractor.years_in_business || 0;
      score += Math.min(years * 4, 40);

      // Has license (20 points)
      if (contractor.license_number) score += 20;

      // Has insurance (20 points)
      if (contractor.insurance_info) score += 20;

      // Rating if available (0-20 points)
      if (contractor.rating) {
        score += (contractor.rating / 5) * 20;
      } else {
        score += 10; // Default middle score if no ratings yet
      }

      // Convert score to grade
      if (score >= 90) return 'A';
      if (score >= 80) return 'B';
      if (score >= 70) return 'C';
      if (score >= 60) return 'D';
      return 'F';
    }

    // Render single bid
    function renderBid(bid, job) {
      const isAccepted = bid.status === 'accepted';
      const isPending = bid.status === 'pending';
      const contractorGrade = getContractorGrade(bid.contractor);

      // Generate license badge for contractor
      const licenseBadge = bid.contractor ? generateLicenseBadge(bid.contractor, { size: 'compact', showGetLicensed: false }) : '';

      // Check if bid has professional estimate attached
      const hasEstimate = bid.has_estimate && bid.estimate;

      // Check if bid was updated (submitted_at and updated_at are different)
      const isUpdated = bid.updated_at && bid.submitted_at &&
                        new Date(bid.updated_at).getTime() > new Date(bid.submitted_at).getTime();

      return `
        <div class="bid-card ${isAccepted ? 'accepted' : ''}">
          <div class="bid-header">
            <div style="display: flex; align-items: center; gap: 8px;">
              <div class="contractor-name">${escapeHtml(bid.contractor?.business_name || bid.contractor_business_name || 'Contractor')}</div>
              <span class="grade-badge grade-${contractorGrade}" title="Contractor Grade: ${contractorGrade}">${contractorGrade}</span>
              ${licenseBadge}
              ${hasEstimate ? `
                <span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                  <span>üí∞</span> Professional Estimate
                </span>
              ` : ''}
              ${isUpdated ? `
                <span style="background: #f59e0b; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                  <span>üîÑ</span> Updated
                </span>
              ` : ''}
            </div>
            <div class="bid-amount">${formatCurrency(bid.bid_amount_low)} - ${formatCurrency(bid.bid_amount_high)}</div>
          </div>

          <div class="bid-details">
            ${bid.contractor?.years_in_business ? `‚è±Ô∏è ${bid.contractor.years_in_business} years in business ‚Ä¢ ` : ''}
            ${bid.estimated_duration ? `üìÖ Duration: ${escapeHtml(bid.estimated_duration)}` : ''}
            ${isUpdated ? `<br>üîÑ Bid updated ${formatDate(bid.updated_at)}` : `<br>üìÖ Bid submitted ${formatDate(bid.submitted_at)}`}
          </div>

          ${bid.message ? `
            <div class="bid-message">${escapeHtml(bid.message)}</div>
          ` : ''}

          <div class="bid-actions">
            ${isAccepted ? `
              <span style="color: #10b981; font-weight: 600;">‚úì Accepted</span>
              ${hasEstimate ? `<button class="btn-view-estimate" data-bid-id="${bid.id}" style="background: #059669; margin-left: 8px;">üìä View Detailed Estimate</button>` : ''}
              <button class="btn-message" data-contractor-email="${bid.contractor_email}" data-job-id="${job.id}">üí¨ Message Contractor</button>
            ` : isPending ? `
              <button class="btn-accept" data-bid-id="${bid.id}" data-job-id="${job.id}">Accept Bid</button>
              ${hasEstimate ? `<button class="btn-view-estimate" data-bid-id="${bid.id}" style="background: #059669;">üìä View Detailed Estimate</button>` : ''}
              <button class="btn-message" data-contractor-email="${bid.contractor_email}" data-job-id="${job.id}">Message Contractor</button>
              <button class="btn-decline" data-bid-id="${bid.id}" data-job-id="${job.id}">Decline</button>
            ` : `
              <span style="color: #6b7280;">Status: ${bid.status}</span>
            `}
          </div>
        </div>
      `;
    }

    // Attach event listeners to bid action buttons
    function attachBidActionListeners() {
      // Accept bid buttons
      document.querySelectorAll('.btn-accept').forEach(btn => {
        btn.addEventListener('click', async function() {
          const bidId = this.dataset.bidId;
          const jobId = this.dataset.jobId;

          if (!confirm('Are you sure you want to accept this bid? This will reject all other bids for this job.')) {
            return;
          }

          try {
            this.disabled = true;
            this.textContent = 'Accepting...';

            const response = await window.authService.authenticatedFetch('/api/bid/accept', {
              method: 'POST',
              body: JSON.stringify({
                bidId,
                jobId,
                homeownerEmail: userEmail
              })
            });

            if (!response.ok) {
              throw new Error('Failed to accept bid');
            }

            alert('Bid accepted successfully! The contractor has been notified.');
            await loadJobs(); // Reload jobs to show updated status

          } catch (error) {
            console.error('Error accepting bid:', error);
            alert('Failed to accept bid. Please try again.');
            this.disabled = false;
            this.textContent = 'Accept Bid';
          }
        });
      });

      // Message contractor buttons
      document.querySelectorAll('.btn-message').forEach(btn => {
        btn.addEventListener('click', async function() {
          const contractorEmail = this.dataset.contractorEmail;
          const jobId = this.dataset.jobId;

          // Create or find conversation and redirect to messages
          try {
            const response = await window.authService.authenticatedFetch('/api/conversations/create', {
              method: 'POST',
              body: JSON.stringify({
                job_id: jobId,
                homeowner_email: userEmail,
                contractor_email: contractorEmail
              })
            });

            if (response.ok) {
              window.location.href = 'messages.html';
            } else {
              // Fallback: just go to messages page
              window.location.href = 'messages.html';
            }
          } catch (error) {
            console.error('Error creating conversation:', error);
            // Fallback: just go to messages page
            window.location.href = 'messages.html';
          }
        });
      });

      // Decline bid buttons
      document.querySelectorAll('.btn-decline').forEach(btn => {
        btn.addEventListener('click', async function() {
          const bidId = this.dataset.bidId;
          const jobId = this.dataset.jobId;

          if (!confirm('Are you sure you want to decline this bid? The contractor will be notified.')) {
            return;
          }

          try {
            this.disabled = true;
            this.textContent = 'Declining...';

            const response = await window.authService.authenticatedFetch('/api/bid/decline', {
              method: 'POST',
              body: JSON.stringify({
                bidId,
                jobId,
                homeownerEmail: userEmail
              })
            });

            if (!response.ok) {
              throw new Error('Failed to decline bid');
            }

            alert('Bid declined successfully. The contractor has been notified.');
            await loadJobs(); // Reload jobs to show updated status

          } catch (error) {
            console.error('Error declining bid:', error);
            alert('Failed to decline bid. Please try again.');
            this.disabled = false;
            this.textContent = 'Decline';
          }
        });
      });

      // View Estimate buttons
      document.querySelectorAll('.btn-view-estimate').forEach(btn => {
        btn.addEventListener('click', function() {
          const bidId = this.dataset.bidId;
          openEstimateModal(bidId);
        });
      });
    }

    // Open estimate modal
    function openEstimateModal(bidId) {
      // Find the bid with this ID from all jobs
      let targetBid = null;
      for (const job of allJobs) {
        if (job.bids) {
          targetBid = job.bids.find(bid => bid.id === bidId);
          if (targetBid) break;
        }
      }

      if (!targetBid || !targetBid.estimate) {
        alert('Estimate data not found');
        return;
      }

      const estimate = targetBid.estimate;
      const contractorName = targetBid.contractor?.business_name || targetBid.contractor_business_name || 'Contractor';

      // Update modal title
      document.getElementById('estimateModalTitle').textContent = `Professional Estimate from ${contractorName}`;
      document.getElementById('estimateModalSubtitle').textContent = estimate.project_title || 'AI-Generated Detailed Breakdown';

      // Render estimate content
      renderEstimateContent(estimate);

      // Show modal
      document.getElementById('estimateModal').classList.add('show');
    }

    // Close estimate modal
    function closeEstimateModal() {
      document.getElementById('estimateModal').classList.remove('show');
    }

    // Render estimate content
    function renderEstimateContent(estimate) {
      const container = document.getElementById('estimateContent');

      const lineItems = estimate.line_items || [];
      const subtotalLow = estimate.subtotal_low || 0;
      const subtotalHigh = estimate.subtotal_high || 0;
      const overheadPercent = estimate.overhead_profit_percent || 20;
      const contingencyPercent = estimate.contingency_percent || 10;
      const totalLow = estimate.total_projected_low || estimate.total_low || 0;
      const totalHigh = estimate.total_projected_high || estimate.total_high || 0;

      const overheadLow = (subtotalLow * overheadPercent / 100);
      const overheadHigh = (subtotalHigh * overheadPercent / 100);
      const contingencyLow = (subtotalLow * contingencyPercent / 100);
      const contingencyHigh = (subtotalHigh * contingencyPercent / 100);

      container.innerHTML = `
        <div style="background: white; border-radius: 12px; overflow: hidden; border: 1px solid #e5e7eb;">
          <!-- Total Summary -->
          <div style="background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); padding: 24px; color: white; text-align: center;">
            <div style="font-size: 16px; opacity: 0.9; margin-bottom: 8px;">Estimated Total Cost</div>
            <div style="font-size: 36px; font-weight: 700;">
              ${formatCurrency(totalLow)} - ${formatCurrency(totalHigh)}
            </div>
            <div style="font-size: 14px; opacity: 0.8; margin-top: 8px;">Professional AI-Generated Estimate</div>
          </div>

          <!-- Line Items -->
          <div style="padding: 24px;">
            <h3 style="margin: 0 0 16px 0; color: #1f2937; font-size: 18px;">Detailed Breakdown</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="border-bottom: 2px solid #e5e7eb;">
                  <th style="text-align: left; padding: 12px 8px; color: #6b7280; font-weight: 600; font-size: 14px;">Item</th>
                  <th style="text-align: right; padding: 12px 8px; color: #6b7280; font-weight: 600; font-size: 14px;">Low</th>
                  <th style="text-align: right; padding: 12px 8px; color: #6b7280; font-weight: 600; font-size: 14px;">High</th>
                </tr>
              </thead>
              <tbody>
                ${lineItems.map((item, index) => `
                  <tr style="border-bottom: 1px solid #f3f4f6; ${index % 2 === 0 ? 'background: #f9fafb;' : ''}">
                    <td style="padding: 12px 8px; font-size: 14px; color: #1f2937;">${escapeHtml(item.item)}</td>
                    <td style="padding: 12px 8px; text-align: right; font-size: 14px; color: #1f2937;">${formatCurrency(item.low_estimate)}</td>
                    <td style="padding: 12px 8px; text-align: right; font-size: 14px; color: #1f2937;">${formatCurrency(item.high_estimate)}</td>
                  </tr>
                `).join('')}
                <tr style="border-top: 2px solid #e5e7eb; font-weight: 600; background: #f9fafb;">
                  <td style="padding: 12px 8px; font-size: 14px; color: #1f2937;">Subtotal (Materials & Labor)</td>
                  <td style="padding: 12px 8px; text-align: right; font-size: 14px; color: #1f2937;">${formatCurrency(subtotalLow)}</td>
                  <td style="padding: 12px 8px; text-align: right; font-size: 14px; color: #1f2937;">${formatCurrency(subtotalHigh)}</td>
                </tr>
                <tr style="background: #fffbeb;">
                  <td style="padding: 12px 8px; font-size: 14px; color: #78350f;">Overhead & Profit (${overheadPercent}%)</td>
                  <td style="padding: 12px 8px; text-align: right; font-size: 14px; color: #78350f;">${formatCurrency(overheadLow)}</td>
                  <td style="padding: 12px 8px; text-align: right; font-size: 14px; color: #78350f;">${formatCurrency(overheadHigh)}</td>
                </tr>
                <tr style="background: #fffbeb;">
                  <td style="padding: 12px 8px; font-size: 14px; color: #78350f;">Contingency (${contingencyPercent}%)</td>
                  <td style="padding: 12px 8px; text-align: right; font-size: 14px; color: #78350f;">${formatCurrency(contingencyLow)}</td>
                  <td style="padding: 12px 8px; text-align: right; font-size: 14px; color: #78350f;">${formatCurrency(contingencyHigh)}</td>
                </tr>
                <tr style="border-top: 3px solid #2563eb; background: #eff6ff; font-weight: 700;">
                  <td style="padding: 16px 8px; font-size: 16px; color: #1e40af;">Total Project Cost</td>
                  <td style="padding: 16px 8px; text-align: right; font-size: 16px; color: #1e40af;">${formatCurrency(totalLow)}</td>
                  <td style="padding: 16px 8px; text-align: right; font-size: 16px; color: #1e40af;">${formatCurrency(totalHigh)}</td>
                </tr>
              </tbody>
            </table>

            <div style="margin-top: 24px; padding: 16px; background: #f0fdf4; border-left: 4px solid #10b981; border-radius: 4px;">
              <div style="font-weight: 600; color: #065f46; margin-bottom: 8px;">‚úì Professional Estimate Included</div>
              <p style="margin: 0; font-size: 14px; color: #047857; line-height: 1.6;">
                This detailed estimate was generated using AI and includes materials, labor, overhead, and contingency.
                Actual costs may vary based on final specifications and unforeseen conditions.
              </p>
            </div>
          </div>
        </div>

        <div style="margin-top: 24px; text-align: right;">
          <button onclick="closeEstimateModal()" style="padding: 12px 32px; background: #6b7280; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            Close
          </button>
        </div>
      `;
    }

    // Filter tabs
    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        currentFilter = this.dataset.filter;
        renderJobs();
      });
    });

    // Show error
    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 5000);
    }

    // Escape HTML
    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return unsafe
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Job Posting Modal Functions
    function openJobModal() {
      document.getElementById('jobModal').classList.add('show');

      // Check for pending AI data
      const pendingJobData = sessionStorage.getItem('pendingJob');
      if (pendingJobData) {
        try {
          const data = JSON.parse(pendingJobData);
          autoPopulateFromAI(data);
          sessionStorage.removeItem('pendingJob'); // Clear after use
        } catch (e) {
          console.error('Error parsing pending job data:', e);
        }
      }
    }

    function closeJobModal() {
      document.getElementById('jobModal').classList.remove('show');
      document.getElementById('jobPostingForm').reset();
      document.getElementById('aiAssisted').checked = false;
      document.getElementById('aiBadge').style.display = 'none';
      document.getElementById('jobFormStatus').textContent = '';
    }

    window.closeJobModal = closeJobModal; // Make globally accessible

    function autoPopulateFromAI(data) {
      if (!data) return;

      // Populate title from question
      if (data.originalQuestion) {
        const titleField = document.getElementById('jobTitle');
        // Create a short title from the question (first 80 chars)
        const shortTitle = data.originalQuestion.substring(0, 80).trim();
        titleField.value = shortTitle + (data.originalQuestion.length > 80 ? '...' : '');
      }

      // Populate description with both question and AI analysis
      if (data.originalQuestion || data.aiAnalysis) {
        const descField = document.getElementById('jobDescription');
        let description = '';

        if (data.originalQuestion) {
          description += `ISSUE DESCRIPTION:\n${data.originalQuestion}\n\n`;
        }

        if (data.aiAnalysis) {
          description += `AI ANALYSIS:\n${data.aiAnalysis}`;
        }

        descField.value = description.trim();
      }

      // Populate budget if available
      if (data.budgetLow) {
        document.getElementById('budgetLow').value = data.budgetLow;
      }
      if (data.budgetHigh) {
        document.getElementById('budgetHigh').value = data.budgetHigh;
      }

      // Mark as AI-assisted
      if (data.fromAI) {
        document.getElementById('aiAssisted').checked = true;
        document.getElementById('aiBadge').style.display = 'inline-block';
      }

      // Try to guess category from the question
      if (data.originalQuestion) {
        const question = data.originalQuestion.toLowerCase();
        const categoryField = document.getElementById('jobCategory');

        if (question.includes('leak') || question.includes('pipe') || question.includes('drain') || question.includes('toilet') || question.includes('faucet')) {
          categoryField.value = 'plumbing';
        } else if (question.includes('electric') || question.includes('outlet') || question.includes('wire') || question.includes('breaker')) {
          categoryField.value = 'electrical';
        } else if (question.includes('hvac') || question.includes('heat') || question.includes('ac') || question.includes('furnace') || question.includes('air condition')) {
          categoryField.value = 'hvac';
        } else if (question.includes('roof') || question.includes('shingle') || question.includes('gutter')) {
          categoryField.value = 'roofing';
        } else if (question.includes('paint') || question.includes('wall')) {
          categoryField.value = 'painting';
        } else if (question.includes('floor') || question.includes('carpet') || question.includes('tile')) {
          categoryField.value = 'flooring';
        }
      }
    }

    // Handle job posting form submission
    document.getElementById('jobPostingForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = document.getElementById('submitJobBtn');
      const statusEl = document.getElementById('jobFormStatus');

      submitBtn.disabled = true;
      submitBtn.textContent = 'Posting...';
      statusEl.textContent = 'Creating job post...';
      statusEl.style.color = '#6b7280';

      try {
        const formData = {
          title: document.getElementById('jobTitle').value.trim(),
          description: document.getElementById('jobDescription').value.trim(),
          category: document.getElementById('jobCategory').value,
          budget_low: parseInt(document.getElementById('budgetLow').value),
          budget_high: parseInt(document.getElementById('budgetHigh').value),
          zip_code: document.getElementById('zipCode').value.trim(),
          urgency: document.getElementById('urgency').value,
          ai_assisted: document.getElementById('aiAssisted').checked,
          homeowner_email: userEmail
        };

        const response = await window.authService.authenticatedFetch('/api/jobs', {
          method: 'POST',
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.message || 'Failed to create job');
        }

        statusEl.textContent = 'Job posted successfully! ‚úÖ';
        statusEl.style.color = '#10b981';

        // Close modal and reload jobs
        setTimeout(() => {
          closeJobModal();
          loadJobs();
        }, 1500);

      } catch (error) {
        console.error('Error posting job:', error);
        statusEl.textContent = 'Error: ' + error.message;
        statusEl.style.color = '#ef4444';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Post Job';
      }
    });

    // New Job button click handler
    document.getElementById('newJobBtn').addEventListener('click', openJobModal);

    // Auto-open modal if coming from AI assistant
    if (sessionStorage.getItem('pendingJob')) {
      setTimeout(() => openJobModal(), 500);
    }
  </script>

  <!-- Supabase Auth -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/services/auth.js"></script>

  <!-- License Badge Component -->
  <script src="components/license-badge.js"></script>

  <!-- Unified Navigation Component -->
  <script src="components/navigation.js"></script>
</body>
</html>
