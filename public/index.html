<!DOCTYPE html><html><head>
  <title>HomeProHub</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* New Styles for Desktop Optimization */
    body {
        background-color: #f8f9fa; 
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
        padding-top: 80px; /* More space from the top */
    }
    .login-container {
        max-width: 800px; /* Increased max width for desktop layout */
        width: 90%;
        background: white;
        padding: 50px 40px; /* Increased padding */
        border-radius: 16px; /* Slightly larger border radius */
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        text-align: left; /* Aligns content better for professional look */
        
        display: grid;
        grid-template-columns: 1.5fr 1fr; /* Two main columns for professional look */
        gap: 60px;
        align-items: center;
    }
    @media (max-width: 800px) {
        .login-container {
            grid-template-columns: 1fr;
            text-align: center;
        }
    }
    
    .logo-area {
        margin-bottom: 25px;
        text-align: center; /* Center logo in its column */
    }
    .logo-circle {
        width: 70px; /* Larger logo */
        height: 70px;
        background-color: #ffd700; 
        border-radius: 50%;
        margin: 0 auto 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        font-weight: 700;
        color: #1f2937;
        font-family: monospace; 
    }
    .welcome-text {
        font-size: 32px; /* Larger title */
        font-weight: 700;
        margin-bottom: 5px;
        color: #1f2937;
    }
    .welcome-sub {
        font-size: 16px; /* Larger subtext */
        color: #6b7280;
        margin-bottom: 30px;
        max-width: 400px;
    }

    /* Form Column Styling */
    .form-column {
        padding-left: 30px;
        border-left: 1px solid #e5e7eb; /* Separator line */
    }
    @media (max-width: 800px) {
        .form-column {
            padding-left: 0;
            border-left: none;
        }
    }
    
    /* Form Elements */
    .input-group input {
        width: 100%;
        padding: 14px 15px; /* Larger input fields */
        margin-bottom: 18px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 16px;
    }
    .btn-login {
        width: 100%;
        padding: 18px; /* Larger button */
        border: none;
        border-radius: 8px;
        background-color: #ffd700; 
        color: #1f2937;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
    }
    .signup-text {
        margin-top: 25px;
        font-size: 14px;
        color: #6b7280;
        text-align: center;
    }
    .status-message {
        margin-top: 10px;
        font-size: 14px;
        color: #ef4444;
        text-align: center;
    }
  </style>
</head><body>
<div class="login-container">
    
    <div class="info-column">
        <div class="logo-area">
            <div class="logo-circle">HH</div>
        </div>
        <div class="welcome-text">Welcome to HomeProHub!</div>
        <div class="welcome-sub">The single hub for contractors and homeowners. Sign in to access secure tools, client data, and AI assistance.</div>

        <p style="font-size: 14px; color: #4b5563;">
            <strong style="color: #2563eb;">Note:</strong> Your account status (Homeowner or Contractor) will be confirmed after login, directing you to the correct tools automatically.
        </p>
    </div>

    <div class="form-column">
        <form id="loginForm">
            <h2 style="margin-top: 0;">Log In to Access</h2>
            <div class="input-group">
                <input type="email" id="loginUsername" placeholder="Email" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
            </div>
            <button type="submit" class="btn-login">LOGIN</button>
            <a href="#" class="forgot-password">Forgot password?</a>
            <p id="loginStatus" class="status-message"></p>
        </form>

        <form id="signupForm" style="display:none;">
            <h2 style="margin-top: 0;">Create Account</h2>
            <div class="input-group">
                <input type="email" id="signupUsername" placeholder="Email (Required)" required>
                <input type="password" id="signupPassword" placeholder="Password (Min 6 chars)" required>
            </div>
            <button type="submit" class="btn-login" style="background-color: #10b981;">REGISTER</button>
            <p id="signupStatus" class="status-message" style="color: #10b981;"></p>
        </form>
        
        <div class="signup-text">
            Don't have an account? <a href="#" id="showSignup">Register Now!</a>
        </div>
        <div class="signup-text" style="display:none;">
            Already have an account? <a href="#" id="showLogin">Log In!</a>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // --- LIVE SUPABASE INTEGRATION ---
    const SUPABASE_URL = 'https://artcgqykrmliskbkzunz.supabase.co'; 
    const SUPABASE_ANON_KEY = 'sb_publishable_93uN7DNKNFnNQ2ZH9fMuvA_jGCWHifP';
    
    // Check if the supabase global object exists
    const { createClient } = window.supabase;
    // FIX: Use the single object parameter method and pass persistSession for stability
    const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
            persistSession: true, // Recommended for production session management
        }
    });
    
    // --- ELEMENT SELECTORS ---
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const loginStatus = document.getElementById('loginStatus');
    const signupStatus = document.getElementById('signupStatus');
    const showSignupLink = document.getElementById('showSignup');
    const showLoginLink = document.getElementById('showLogin');
    
    // --- UI TOGGLES ---
    showSignupLink.addEventListener('click', (e) => {
        e.preventDefault();
        loginForm.style.display = 'none';
        signupForm.style.display = 'block';
        showSignupLink.parentNode.style.display = 'none';
        showLoginLink.parentNode.style.display = 'block';
        loginStatus.textContent = '';
        signupStatus.textContent = '';
    });

    showLoginLink.addEventListener('click', (e) => {
        e.preventDefault();
        signupForm.style.display = 'none';
        loginForm.style.display = 'block';
        showLoginLink.parentNode.style.display = 'none';
        showSignupLink.parentNode.style.display = 'block';
        loginStatus.textContent = '';
        signupStatus.textContent = '';
    });

    // --- SIGNUP LOGIC (Live Supabase) ---
    signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        signupStatus.textContent = 'Creating secure account...';
        
        const username = document.getElementById('signupUsername').value;
        const password = document.getElementById('signupPassword').value;

        try {
            const { data, error } = await client.auth.signUp({ 
                email: username, 
                password: password,
            });

            if (error) {
                signupStatus.textContent = `Error: ${error.message}`;
            } else {
                signupStatus.textContent = `âœ… Success! Check your email (${username}) to confirm registration.`;
                document.getElementById('signupUsername').value = '';
                document.getElementById('signupPassword').value = '';
            }
        } catch (error) {
            signupStatus.textContent = 'Network error. Try again.';
        }
    });

    // --- LOGIN LOGIC (Live Supabase) ---
    // --- LOGIN LOGIC (Live Supabase) ---
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        loginStatus.textContent = 'Logging in...';

        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        try {
            // --- 1. LIVE SUPABASE LOGIN CALL ---
            const { data, error } = await client.auth.signInWithPassword({ 
                email: username, 
                password: password 
            });

            if (error) {
                loginStatus.textContent = `Error: ${error.message || 'Invalid credentials.'}`;
            } else if (data.user) {
                // User successfully logged in. Save session data.
                localStorage.setItem('homeprohub_auth_token', data.session.access_token);
                localStorage.setItem('homeprohub_username', data.user.email);
                
                // --- 2. NEW STEP: Check for existing role on server ---
                const roleResponse = await fetch(`/api/get-role?username=${data.user.email}`);
                const roleData = await roleResponse.json();
                
                if (roleData.role) {
                    // ROLE FOUND: Bypass role picker and go straight to dashboard
                    localStorage.setItem('homeprohub_user_role', roleData.role);
                    loginStatus.textContent = 'Success! Directing to dashboard...';
                    
                    // Small delay to ensure localStorage saves before redirect
                    setTimeout(() => {
                        window.location.href = roleData.role === 'homeowner' ? 'home.html' : 'contractor.html';
                    }, 500);
                } else {
                    // NO ROLE FOUND: Go to role selection for the first time setup
                    loginStatus.textContent = 'Success! Please select your role...';
                    window.location.href = 'role-selection.html';
                }
            } else {
                 loginStatus.textContent = 'Login failed. Check console for details.';
            }
        } catch (error) {
            // CATCH BLOCK FOR TRY/CATCH
            loginStatus.textContent = 'Network error. Try again.';
        }
    });
</script>
</body></html>