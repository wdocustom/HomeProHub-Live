<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8" />
  <title>HomeProHub â€“ Home Issue Assistant</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="components/navigation.css" />
  <!-- Supabase Auth -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/services/auth.js"></script>
  <style>
    body {
      background: #f9fafb;
    }

    .hero {
      max-width: 896px;
      margin: 48px auto 24px;
      padding: 0 24px;
      text-align: center;
    }
    .hero-kicker {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      margin-bottom: 8px;
    }
    .hero-title {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.03em;
      margin-bottom: 12px;
      color: #111827;
    }
    .hero-subtitle {
      font-size: 15px;
      line-height: 1.6;
      color: #6b7280;
      max-width: 640px;
      margin: 0 auto;
    }

    .input-container {
      max-width: 896px;
      margin: 0 auto 60px;
      padding: 0 24px;
    }

    .input-card {
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      border: 2px solid #e5e7eb;
    }

    .input-label {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      display: block;
    }

    .input-textarea {
      width: 100%;
      min-height: 140px;
      padding: 16px;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      font-size: 15px;
      line-height: 1.6;
      resize: vertical;
      font-family: inherit;
      transition: all 0.2s;
    }

    .input-textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .input-hint {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
      line-height: 1.5;
    }

    .photo-upload-section {
      margin-top: 20px;
    }

    .btn-analyze {
      background: #2563eb;
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(37, 99, 235, 0.3);
      width: 100%;
      max-width: 320px;
    }

    .btn-analyze:hover:not(:disabled) {
      background: #1d4ed8;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    .btn-analyze:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Answer Output Section */
    .answer-container {
      max-width: 896px;
      margin: 40px auto;
      padding: 0 24px;
      display: none;
    }

    .answer-container.show {
      display: block;
    }

    .answer-header {
      margin-bottom: 16px;
    }

    .answer-header h2 {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
      margin: 0 0 4px 0;
    }

    .answer-header p {
      font-size: 14px;
      color: #6b7280;
      margin: 0;
    }

    .answer-card {
      background: white;
      border-radius: 16px;
      padding: 48px;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      border: 2px solid #e5e7eb;
    }

    /* Prose styling for markdown content */
    .prose {
      color: #374151;
      font-size: 15px;
      line-height: 1.7;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .prose h1, .prose h2, .prose h3 {
      color: #111827;
      font-weight: 700;
      margin-top: 24px;
      margin-bottom: 12px;
      line-height: 1.3;
    }

    .prose h1 { font-size: 28px; }
    .prose h2 { font-size: 22px; }
    .prose h3 { font-size: 18px; }

    .prose p {
      margin: 16px 0;
    }

    .prose strong {
      font-weight: 700;
      color: #111827;
      font-size: 1.05em;
    }

    .prose ul, .prose ol {
      margin: 16px 0;
      padding-left: 24px;
    }

    .prose li {
      margin: 8px 0;
    }

    .prose code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.9em;
    }

    /* Next Steps CTA */
    .next-steps-cta {
      max-width: 896px;
      margin: 32px auto;
      padding: 0 24px;
      display: none;
    }

    .next-steps-cta.show {
      display: block;
    }

    .next-steps-card {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border: 2px solid #93c5fd;
      border-radius: 16px;
      padding: 32px;
      text-align: center;
    }

    .next-steps-card h3 {
      font-size: 22px;
      font-weight: 700;
      color: #1e40af;
      margin: 0 0 8px 0;
    }

    .next-steps-card p {
      font-size: 15px;
      color: #1e3a8a;
      margin: 0 0 20px 0;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    .btn-post-project {
      background: #2563eb;
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
    }

    .btn-post-project:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    .microcopy {
      font-size: 12px;
      color: #64748b;
      margin-top: 12px;
    }

    /* Clarify Section */
    .clarify-section {
      max-width: 896px;
      margin: 24px auto;
      padding: 0 24px;
      display: none;
    }

    .clarify-section.show {
      display: block;
    }

    .small-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
    }

    .history-empty {
      font-size: 12px;
      color: #9ca3af;
    }
    .history-list {
      margin: 8px 0 0 18px;
      padding: 0;
      max-height: 180px;
      overflow-y: auto;
    }
    .history-item-title {
      font-size: 13px;
      color: #111827;
    }
    .history-item-time {
      font-size: 11px;
      color: #9ca3af;
    }
    .clear-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      color: #6b7280;
      cursor: pointer;
    }
    .clear-btn:hover {
      border-color: #dc2626;
      color: #b91c1c;
    }

    .clarify-label {
      font-size: 12px;
      color: #4b5563;
      margin-top: 16px;
      margin-bottom: 4px;
    }
    .clarify-box {
      width: 100%;
      min-height: 70px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 13px;
      resize: vertical;
    }
  </style></head><body>
  <!-- Navigation component will be injected here by navigation.js -->

  <main>
  <section class="hero">
    <h1 class="hero-title">AI Home Assistant</h1>
    <p class="hero-subtitle">
      Describe what you see, hear, or smell. We'll analyze it instantly.
    </p>
  </section>

  <!-- Input Section -->
  <div class="input-container">
    <div class="input-card">
      <label for="question" class="input-label">Describe the issue in detail</label>
      <textarea
        id="question"
        class="input-textarea"
        placeholder="Example: There is a brown stain on my living room ceiling under the upstairs bathroom. It seems to grow slowly after showers, slight musty smell, and the drywall feels a little soft to the touch..."
      ></textarea>

      <div class="input-hint">
        Be specific: location, when it happens, smells, sounds, age of the home, any recent work, and how long it's been going on.
      </div>

      <div class="photo-upload-section">
        <label for="photoInput" class="input-label">Optional photo (helps the AI see stains, cracks, etc.):</label>
        <input type="file" id="photoInput" accept="image/*" />
      </div>

      <div style="margin-top:24px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <button type="button" id="askBtn" class="btn-analyze">
          <span>âœ¨</span>
          <span>Analyze My Issue</span>
        </button>
        <div id="status" class="status"></div>
      </div>
    </div>
  </div>

  <!-- Answer Output Section -->
  <div class="answer-container" id="answerContainer">
    <div class="answer-header">
      <h2>Preliminary Analysis</h2>
      <p>AI-powered diagnosis and recommended next steps</p>
    </div>
    <div class="answer-card">
      <div id="answer" class="prose"></div>
    </div>
  </div>

  <!-- Clarify Section -->
  <div class="clarify-section" id="clarifySection">
    <div class="input-card">
      <label for="clarify" class="input-label">Need to add more details?</label>
      <textarea
        id="clarify"
        class="input-textarea"
        style="min-height: 100px;"
        placeholder="Example: The house was built in 2005, this only happens after long showers, and the stain looks slightly yellow around the edges..."
      ></textarea>
      <div style="margin-top:16px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <button id="clarifyBtn" class="btn-analyze">
          <span>ðŸ”„</span>
          <span>Clarify & Update Answer</span>
        </button>
        <div id="clarifyStatus" class="status"></div>
      </div>
    </div>
  </div>

  <!-- Next Steps CTA -->
  <div class="next-steps-cta" id="nextStepsCta">
    <div class="next-steps-card">
      <h3>Ready to get quotes?</h3>
      <p>Turn this analysis into a structured project for verified contractors</p>
      <button id="postProjectBtn" class="btn-post-project">Post to Project Board</button>
      <div class="microcopy">Free â€¢ No Obligation â€¢ You Control the Bids</div>
    </div>
  </div>

  <!-- History Section (moved to bottom) -->
  <div style="max-width: 896px; margin: 40px auto 80px; padding: 0 24px;">
    <div class="input-card" style="padding: 32px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <div style="font-size:15px; font-weight:600; color:#111827;">Previous questions</div>
        <button class="clear-btn" id="clearHistoryBtn">Clear history</button>
      </div>
      <div id="historyEmpty" class="history-empty">
        No questions yet. Ask something to start a history.
      </div>
      <ul id="historyList" class="history-list"></ul>
    </div>
  </div>

  <!-- Project Submission Modal (kept for form functionality) -->
      <div id="projectSubmissionModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 24px; overflow-y: auto;">
        <div style="background: white; border-radius: 16px; padding: 32px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; margin: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="margin: 0; font-size: 24px; color: #1f2937;">Submit Project to Contractors</h2>
            <button onclick="closeProjectModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #9ca3af;">&times;</button>
          </div>

          <form id="projectSubmissionForm">
            <div class="form-group">
              <label>Project Title <span style="color: #ef4444;">*</span></label>
              <input id="projectTitle" type="text" placeholder="e.g., Shower Pan Leak Repair" required maxlength="100" />
            </div>

            <div class="form-group">
              <label>Project Description (AI-Generated) <span style="color: #ef4444;">*</span></label>
              <textarea id="projectDescription" rows="8" readonly style="background: #f9fafb;"></textarea>
              <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">This was generated by AI based on your conversation. Contractors will see this.</p>
            </div>

            <div class="form-group">
              <label>Your Address <span style="color: #ef4444;">*</span></label>
              <input id="projectAddress" type="text" placeholder="123 Main St, City, State" required maxlength="200" />
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div class="form-group">
                <label>ZIP Code <span style="color: #ef4444;">*</span></label>
                <input id="projectZip" type="text" pattern="[0-9]{5}" placeholder="12345" required maxlength="5" />
              </div>

              <div class="form-group">
                <label>Urgency</label>
                <select id="projectUrgency">
                  <option value="flexible">Flexible timing</option>
                  <option value="soon">Within 2 weeks</option>
                  <option value="urgent">Urgent (ASAP)</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>AI-Estimated Budget Range <span style="color: #ef4444;">*</span></label>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <input id="budgetLow" type="number" placeholder="Low estimate" required min="0" step="100" />
                </div>
                <div>
                  <input id="budgetHigh" type="number" placeholder="High estimate" required min="0" step="100" />
                </div>
              </div>
              <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Based on AI analysis. Contractors can adjust their bids.</p>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="acceptTerms" required />
                <span style="font-size: 14px;">I understand contractors will contact me with bids and questions</span>
              </label>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button type="submit" class="btn-primary" id="submitProjectBtn">Submit Project Posting</button>
              <button type="button" class="btn-secondary" onclick="closeProjectModal()">Cancel</button>
            </div>
            <div id="projectSubmissionStatus" style="margin-top: 12px; font-size: 14px;"></div>
          </form>
        </div>
      </div>


      <div class="history-box" style="margin-top:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
          <div style="font-size:13px; font-weight:600; color:#111827;">Previous questions on this browser</div>
          <button class="clear-btn" id="clearHistoryBtn">Clear history</button>
        </div>
        <div id="historyEmpty" class="history-empty">
          No questions yet. Ask something to start a history.
        </div>
        <ul id="historyList" class="history-list"></ul>
      </div>
    </div>
  </section></main><script>
(function() {
  'use strict';

  // DOM elements
  const button = document.getElementById("askBtn");
  const textarea = document.getElementById("question");
  const statusText = document.getElementById("status");
  const answerBox = document.getElementById("answer");
  const answerContainer = document.getElementById("answerContainer");
  const clarifySection = document.getElementById("clarifySection");
  const nextStepsCta = document.getElementById("nextStepsCta");
  const photoInput = document.getElementById("photoInput");
  const historyList = document.getElementById("historyList");
  const historyEmpty = document.getElementById("historyEmpty");
  const clearHistoryBtn = document.getElementById("clearHistoryBtn");
  const clarifyButton = document.getElementById("clarifyBtn");
  const clarifyStatus = document.getElementById("clarifyStatus");
  const clarifyBox = document.getElementById("clarify");
  const postProjectBtn = document.getElementById("postProjectBtn");
  const profileLinkEl = document.getElementById("profileLink");

  // Extract INTENT TYPE utility (from ai-diagnosis-results.html)
  function extractIntent(text) {
    const intentPattern = /^[\s]*INTENT\s*TYPE\s*:\s*(PROJECT|ISSUE)[\s]*$/gim;
    const match = text.match(intentPattern);

    let intentType = 'ISSUE'; // Default to ISSUE
    let cleanedAnswer = text;

    if (match && match[0]) {
      const extractedType = match[0].match(/(PROJECT|ISSUE)/i);
      if (extractedType && extractedType[1]) {
        intentType = extractedType[1].toUpperCase();
      }
      cleanedAnswer = text.replace(intentPattern, '').trim();
    }

    return {
      cleanedAnswer,
      intentType,
      isProject: intentType === 'PROJECT'
    };
  }

  // Constants
  const HISTORY_KEY = "homeprohub_history_v1";
  const MAX_HISTORY_ITEMS = 15;
  const MAX_QUESTION_LENGTH = 5000;
  const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

  // State
  let lastQuestion = null;
  let lastImageBase64 = null;
  let lastImageType = null;

  // Utility: Sanitize user input
  function sanitizeInput(input) {
    if (!input || typeof input !== 'string') return '';
    return input.trim().slice(0, MAX_QUESTION_LENGTH);
  }

  // Auth: Get user data (async wrapper for compatibility)
  // Note: Auth is handled by navigation.js component
  let currentUser = null;
  async function getUserData() {
    try {
      const user = await window.authService.getCurrentUser();
      const profile = await window.authService.getUserProfile();

      if (user && profile && profile.role === "homeowner") {
        return {
          username: user.email,
          token: 'supabase_session', // Token handled by authService
          role: profile.role,
          name: profile.full_name || user.email.split('@')[0] || "User"
        };
      }
      return null;
    } catch (e) {
      console.error('Error getting user data:', e);
      return null;
    }
  }

  // Image: Read as base64
  function readImageAsBase64(file) {
    return new Promise((resolve, reject) => {
      if (!file) {
        resolve(null);
        return;
      }

      if (file.size > MAX_FILE_SIZE) {
        reject(new Error('File size exceeds 5MB limit'));
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const result = reader.result;
          const base64 = result.split(",")[1];
          resolve(base64);
        } catch (e) {
          reject(new Error('Failed to process image'));
        }
      };
      reader.onerror = () => reject(new Error('Failed to read image file'));
      reader.readAsDataURL(file);
    });
  }

  // API: Ask backend
  async function askBackend(question, imageBase64, imageType) {
    const sanitizedQuestion = sanitizeInput(question);

    if (!sanitizedQuestion) {
      throw new Error('Question cannot be empty');
    }

    const user = await window.authService.getCurrentUser();
    if (!user) {
      throw new Error('Authentication required');
    }

    const response = await window.authService.authenticatedFetch("/ask", {
      method: "POST",
      body: JSON.stringify({
        question: sanitizedQuestion,
        imageBase64,
        imageType
      })
    });

    if (!response.ok) {
      const data = await response.json().catch(() => ({}));
      throw new Error(data.error || `Request failed (${response.status})`);
    }

    const data = await response.json();
    return data.answer || '';
  }

  // History: Load
  function loadHistory() {
    try {
      const raw = localStorage.getItem(HISTORY_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return [];
      return parsed;
    } catch (e) {
      return [];
    }
  }

  // History: Save
  function saveHistory(history) {
    try {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    } catch (e) {
      // Silent error - history is non-critical
    }
  }

  // History: Add entry
  function addToHistory(question, answer) {
    try {
      const history = loadHistory();
      const entry = {
        question: sanitizeInput(question),
        answer: sanitizeInput(answer),
        timestamp: new Date().toISOString()
      };
      history.unshift(entry);
      const trimmed = history.slice(0, MAX_HISTORY_ITEMS);
      saveHistory(trimmed);
      renderHistory();
    } catch (e) {
      // Silent error
    }
  }

  // History: Render
  function renderHistory() {
    try {
      const history = loadHistory();
      historyList.innerHTML = "";

      if (!history.length) {
        historyEmpty.style.display = "block";
        return;
      }

      historyEmpty.style.display = "none";

      history.forEach((entry) => {
        const li = document.createElement("li");
        li.style.marginBottom = "6px";

        const title = document.createElement("div");
        title.className = "history-item-title";
        const text = entry.question.length > 80
          ? entry.question.slice(0, 80) + "..."
          : entry.question;
        title.textContent = text;

        const time = document.createElement("div");
        time.className = "history-item-time";
        const date = new Date(entry.timestamp);
        time.textContent = date.toLocaleString();

        li.appendChild(title);
        li.appendChild(time);
        historyList.appendChild(li);
      });
    } catch (e) {
      // Silent error
    }
  }

  // History: Clear
  if (clearHistoryBtn) {
    clearHistoryBtn.addEventListener("click", () => {
      try {
        localStorage.removeItem(HISTORY_KEY);
        renderHistory();
      } catch (e) {
        // Silent error
      }
    });
  }

  // Main ask handler
  if (button) {
    button.addEventListener("click", async () => {
      const q = textarea ? textarea.value.trim() : '';

      if (!q) {
        if (answerBox) answerBox.textContent = "Please describe your issue in detail.";
        return;
      }

      if (q.length > MAX_QUESTION_LENGTH) {
        if (answerBox) answerBox.textContent = `Question is too long. Maximum ${MAX_QUESTION_LENGTH} characters.`;
        return;
      }

      // Disable inputs
      button.disabled = true;
      if (clarifyButton) clarifyButton.disabled = true;
      if (textarea) textarea.disabled = true;
      if (photoInput) photoInput.disabled = true;

      if (statusText) statusText.textContent = "Analyzing your issue...";
      if (clarifyStatus) clarifyStatus.textContent = "";
      if (answerBox) answerBox.innerHTML = "";
      if (answerContainer) answerContainer.classList.remove('show');
      if (clarifySection) clarifySection.classList.remove('show');
      if (nextStepsCta) nextStepsCta.classList.remove('show');

      try {
        let imageBase64 = null;
        let imageType = null;

        const file = photoInput && photoInput.files ? photoInput.files[0] : null;
        if (file) {
          imageType = file.type;
          imageBase64 = await readImageAsBase64(file);
        }

        const reply = await askBackend(q, imageBase64, imageType);

        // Extract intent and clean the answer
        const { cleanedAnswer, intentType, isProject } = extractIntent(reply);

        // Display cleaned answer
        if (answerBox) answerBox.textContent = cleanedAnswer;
        if (statusText) statusText.textContent = "Analysis complete.";

        // Show answer container, clarify section, and next steps CTA
        if (answerContainer) answerContainer.classList.add('show');
        if (clarifySection) clarifySection.classList.add('show');
        if (nextStepsCta) nextStepsCta.classList.add('show');

        addToHistory(q, reply);

        // Save context for clarifications and project posting
        lastQuestion = q;
        lastAIAnswer = cleanedAnswer; // Save cleaned version
        lastImageBase64 = imageBase64;
        lastImageType = imageType;

      } catch (err) {
        if (answerBox) {
          answerBox.textContent = err.message || "Unable to process your request. Please try again.";
        }
        if (statusText) statusText.textContent = "";
        if (answerContainer) answerContainer.classList.remove('show');
        if (clarifySection) clarifySection.classList.remove('show');
        if (nextStepsCta) nextStepsCta.classList.remove('show');
      } finally {
        button.disabled = false;
        if (clarifyButton) clarifyButton.disabled = false;
        if (textarea) textarea.disabled = false;
        if (photoInput) photoInput.disabled = false;
      }
    });
  }

  // Clarify handler
  if (clarifyButton) {
    clarifyButton.addEventListener("click", async () => {
      const extra = clarifyBox ? clarifyBox.value.trim() : '';

      if (!lastQuestion) {
        if (clarifyStatus) clarifyStatus.textContent = "Please ask an initial question first.";
        return;
      }

      if (!extra) {
        if (clarifyStatus) clarifyStatus.textContent = "Please provide additional details.";
        return;
      }

      if (extra.length > MAX_QUESTION_LENGTH) {
        if (clarifyStatus) clarifyStatus.textContent = `Clarification is too long. Maximum ${MAX_QUESTION_LENGTH} characters.`;
        return;
      }

      // Disable inputs
      clarifyButton.disabled = true;
      if (button) button.disabled = true;
      if (clarifyBox) clarifyBox.disabled = true;

      if (clarifyStatus) clarifyStatus.textContent = "Updating analysis...";
      if (statusText) statusText.textContent = "";
      if (answerBox) answerBox.textContent = "";
      if (jobPostArea) jobPostArea.style.display = 'none';

      const combinedQuestion =
        `Original description from homeowner:\n` +
        lastQuestion +
        `\n\nNew details / clarifications from homeowner:\n` +
        extra +
        `\n\nPlease update and refine your previous guidance based on these new details. ` +
        `Keep the same structure (summary, severity, urgency, DIY checks, materials, safety, when to call a pro, script). ` +
        `If earlier advice is no longer correct, clearly correct it.`;

      try {
        const reply = await askBackend(combinedQuestion, lastImageBase64, lastImageType);

        if (answerBox) answerBox.textContent = reply;
        if (clarifyStatus) clarifyStatus.textContent = "Analysis updated.";

        addToHistory(combinedQuestion, reply);

        lastQuestion = combinedQuestion;
        lastAIAnswer = reply;
        if (clarifyBox) clarifyBox.value = "";
        if (jobPostArea) jobPostArea.style.display = 'block';

      } catch (err) {
        if (answerBox) {
          answerBox.textContent = err.message || "Unable to update analysis. Please try again.";
        }
        if (clarifyStatus) clarifyStatus.textContent = "";
        if (jobPostArea) jobPostArea.style.display = 'none';
      } finally {
        clarifyButton.disabled = false;
        if (button) button.disabled = false;
        if (clarifyBox) clarifyBox.disabled = false;
      }
    });
  }

  // Post project handler
  let lastAIAnswer = '';

  window.closeProjectModal = function() {
    document.getElementById('projectSubmissionModal').style.display = 'none';
    document.getElementById('projectSubmissionForm').reset();
    document.getElementById('projectSubmissionStatus').textContent = '';
  };

  const postProjectBtn = document.getElementById('postProjectBtn');
  if (postProjectBtn) {
    postProjectBtn.addEventListener('click', async () => {
      if (!lastQuestion || !lastAIAnswer) {
        alert("Please generate a project analysis first.");
        return;
      }

      // Get user profile data
      const userProfile = await window.authService.getUserProfile();

      // Pre-fill the form
      document.getElementById('projectDescription').value = lastQuestion + '\n\nAI Analysis:\n' + lastAIAnswer;
      document.getElementById('projectZip').value = userProfile?.zip_code || '';
      document.getElementById('projectAddress').value = userProfile?.address || '';

      // Try to extract budget from AI response (simple approach - look for dollar amounts)
      const dollarMatches = lastAIAnswer.match(/\$[\d,]+/g);
      if (dollarMatches && dollarMatches.length >= 2) {
        const amounts = dollarMatches.map(m => parseInt(m.replace(/[$,]/g, '')));
        document.getElementById('budgetLow').value = Math.min(...amounts);
        document.getElementById('budgetHigh').value = Math.max(...amounts);
      }

      // Show modal
      document.getElementById('projectSubmissionModal').style.display = 'flex';
    });
  }

  // Handle project submission form
  const projectForm = document.getElementById('projectSubmissionForm');
  if (projectForm) {
    projectForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = document.getElementById('submitProjectBtn');
      const statusEl = document.getElementById('projectSubmissionStatus');

      const user = await window.authService.getCurrentUser();
      if (!user) {
        statusEl.textContent = 'Authentication required';
        statusEl.style.color = '#ef4444';
        return;
      }

      const projectData = {
        title: document.getElementById('projectTitle').value.trim(),
        description: document.getElementById('projectDescription').value.trim(),
        address: document.getElementById('projectAddress').value.trim(),
        zipCode: document.getElementById('projectZip').value.trim(),
        urgency: document.getElementById('projectUrgency').value,
        budgetLow: parseInt(document.getElementById('budgetLow').value),
        budgetHigh: parseInt(document.getElementById('budgetHigh').value),
        homeownerEmail: user.email,
        originalQuestion: lastQuestion,
        aiAnalysis: lastAIAnswer,
        status: 'open',
        postedAt: new Date().toISOString()
      };

      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      statusEl.textContent = 'Submitting your project to contractors...';
      statusEl.style.color = '#6b7280';

      try {
        const response = await window.authService.authenticatedFetch('/api/submit-job', {
          method: 'POST',
          body: JSON.stringify(projectData)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to submit project');
        }

        const result = await response.json();

        statusEl.textContent = 'âœ… Project posted successfully! Contractors can now view and bid on your project.';
        statusEl.style.color = '#10b981';

        setTimeout(() => {
          closeProjectModal();
          // Optionally redirect to a "My Projects" page
        }, 2000);

      } catch (err) {
        statusEl.textContent = 'Error: ' + (err.message || 'Failed to submit project');
        statusEl.style.color = '#ef4444';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Project Posting';
      }
    });
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', renderHistory);
  renderHistory();

})();
</script>

<!-- Unified Navigation Component -->
<script src="components/navigation.js"></script>
</body>
</html>