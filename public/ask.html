<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8" />
  <title>HomeProHub ‚Äì Home Issue Assistant</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .hero {
      max-width: 900px;
      margin: 48px auto 24px;
      padding: 0 24px;
      text-align: center;
    }
    .hero-kicker {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      margin-bottom: 8px;
    }
    .hero-title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.03em;
      margin-bottom: 10px;
      color: #111827;
    }
    .hero-subtitle {
      font-size: 14px;
      line-height: 1.6;
      color: #6b7280;
      max-width: 640px;
      margin: 0 auto;
    }

    .ask-layout {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2.4fr);
      gap: 20px;
    }
    @media (max-width: 860px) {
      .ask-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .small-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
    }

    .history-empty {
      font-size: 12px;
      color: #9ca3af;
    }
    .history-list {
      margin: 8px 0 0 18px;
      padding: 0;
      max-height: 180px;
      overflow-y: auto;
    }
    .history-item-title {
      font-size: 13px;
      color: #111827;
    }
    .history-item-time {
      font-size: 11px;
      color: #9ca3af;
    }
    .clear-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      color: #6b7280;
      cursor: pointer;
    }
    .clear-btn:hover {
      border-color: #dc2626;
      color: #b91c1c;
    }

    .clarify-label {
      font-size: 12px;
      color: #4b5563;
      margin-top: 16px;
      margin-bottom: 4px;
    }
    .clarify-box {
      width: 100%;
      min-height: 70px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 13px;
      resize: vertical;
    }
  </style></head><body><header class="navbar">
  <div class="nav-inner">
    <div class="brand-area">
      <div class="brand-logo">HH</div>
      <div class="brand-name">HomeProHub</div>
    </div>
    <div class="nav-links">
      <a href="home.html">Dashboard</a>
      <a href="ask.html">Assistant</a>
      <div class="profile-area">
        <a href="user-profile.html" class="profile-link" id="profileLink">Profile</a>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
  </div></header><main>
  <section class="hero">
    <div class="hero-kicker">Home issue assistant</div>
    <h1 class="hero-title">Describe what‚Äôs going on at home.</h1>
    <p class="hero-subtitle">
      Type what you‚Äôre seeing, hearing, or smelling. Add a photo if you can.
      You‚Äôll get a clear summary, severity, urgency, DIY checks, materials you may need,
      safety warnings, and what to tell a contractor.
    </p>
  </section>

  <section style="max-width: 900px; margin: 0 auto 60px; padding: 0 24px;">
    <div class="card">
      <div class="ask-layout">
        <section>
          <label for="question" style="font-size:13px; color:#374151;">Describe the issue in detail</label>
          <textarea
            id="question"
            placeholder="Example: There is a brown stain on my living room ceiling under the upstairs bathroom. It seems to grow slowly after showers, slight musty smell, and the drywall feels a little soft to the touch..."
          ></textarea>

          <div class="small-hint">
            Be specific: location, when it happens, smells, sounds, age of the home,
            any recent work, and how long it‚Äôs been going on.
          </div>

          <label for="photoInput" class="small-hint" style="display:block; margin-top:12px;">
            Optional photo (helps the AI see stains, cracks, etc.):
          </label>
          <input type="file" id="photoInput" accept="image/*" />

          <div style="margin-top:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <button type="button" id="askBtn" class="btn-primary">üí¨ Ask HomeProHub AI</button>
            <div id="status" class="status"></div>
          </div>
        </section>

        <aside>
          <div class="history-box">
            <h3 style="margin-top:0; margin-bottom:6px; font-size:15px;">What you‚Äôll get back</h3>
            <ul style="margin: 0 0 0 18px; padding: 0; font-size:13px; color:#4b5563;">
              <li>Summary of what might be happening (plain language)</li>
              <li><strong>Severity</strong> (High / Medium / Low) and <strong>urgency</strong> (Fix now / Fix soon / Monitor)</li>
              <li>DIY-friendly checks you can safely try</li>
              <li>Materials & tools you may need for light DIY work, with example product types and brands</li>
              <li>Clear safety warnings & when to stop</li>
              <li>When to call a pro and what type</li>
              <li>A short script to read or send to a contractor</li>
            </ul>
          </div>
        </aside>
      </div>

      <div id="answer" class="answer-box" style="margin-top:20px;"></div>

      <div style="margin-top:16px;">
        <div class="clarify-label">
          Need to clarify or add something you forgot? Add more detail and get an updated answer:
        </div>
        <textarea
          id="clarify"
          class="clarify-box"
          placeholder="Example: The house was built in 2005, this only happens after long showers, and the stain looks slightly yellow around the edges..."
        ></textarea>
        <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button id="clarifyBtn" class="btn-muted">üîÅ Clarify & update answer</button>
          <div id="clarifyStatus" class="status"></div>
        </div>
      </div>
      
      <div id="jobPostArea" style="margin-top:25px; padding: 20px; border: 1px solid #c7d2fe; border-radius: 12px; background: #f0f7ff; text-align: center; display:none;">
        <h3 style="margin-top: 0; font-size: 18px; color: #2563eb;">Ready to Hire a Pro?</h3>
        <p style="font-size: 14px; color: #4b5563; max-width: 500px; margin: 0 auto 15px;">
          Convert the AI's diagnosis and suggested next steps into a structured job posting. This will instantly push the details out to qualified contractors in your local area (filtered by ZIP code) for them to review and bid.
        </p>
        <button id="postJobBtn" class="btn-primary" style="padding: 10px 20px;">‚úÖ Post This Project to the Contractor Board</button>
      </div>

      <!-- Job Submission Modal -->
      <div id="jobSubmissionModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 24px; overflow-y: auto;">
        <div style="background: white; border-radius: 16px; padding: 32px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; margin: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="margin: 0; font-size: 24px; color: #1f2937;">Submit Job to Contractors</h2>
            <button onclick="closeJobModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #9ca3af;">&times;</button>
          </div>

          <form id="jobSubmissionForm">
            <div class="form-group">
              <label>Job Title <span style="color: #ef4444;">*</span></label>
              <input id="jobTitle" type="text" placeholder="e.g., Shower Pan Leak Repair" required maxlength="100" />
            </div>

            <div class="form-group">
              <label>Job Description (AI-Generated) <span style="color: #ef4444;">*</span></label>
              <textarea id="jobDescription" rows="8" readonly style="background: #f9fafb;"></textarea>
              <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">This was generated by AI based on your conversation. Contractors will see this.</p>
            </div>

            <div class="form-group">
              <label>Your Address <span style="color: #ef4444;">*</span></label>
              <input id="jobAddress" type="text" placeholder="123 Main St, City, State" required maxlength="200" />
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div class="form-group">
                <label>ZIP Code <span style="color: #ef4444;">*</span></label>
                <input id="jobZip" type="text" pattern="[0-9]{5}" placeholder="12345" required maxlength="5" />
              </div>

              <div class="form-group">
                <label>Urgency</label>
                <select id="jobUrgency">
                  <option value="flexible">Flexible timing</option>
                  <option value="soon">Within 2 weeks</option>
                  <option value="urgent">Urgent (ASAP)</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>AI-Estimated Budget Range <span style="color: #ef4444;">*</span></label>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <input id="budgetLow" type="number" placeholder="Low estimate" required min="0" step="100" />
                </div>
                <div>
                  <input id="budgetHigh" type="number" placeholder="High estimate" required min="0" step="100" />
                </div>
              </div>
              <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Based on AI analysis. Contractors can adjust their bids.</p>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="acceptTerms" required />
                <span style="font-size: 14px;">I understand contractors will contact me with bids and questions</span>
              </label>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button type="submit" class="btn-primary" id="submitJobBtn">Submit Job Posting</button>
              <button type="button" class="btn-secondary" onclick="closeJobModal()">Cancel</button>
            </div>
            <div id="jobSubmissionStatus" style="margin-top: 12px; font-size: 14px;"></div>
          </form>
        </div>
      </div>


      <div class="history-box" style="margin-top:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
          <div style="font-size:13px; font-weight:600; color:#111827;">Previous questions on this browser</div>
          <button class="clear-btn" id="clearHistoryBtn">Clear history</button>
        </div>
        <div id="historyEmpty" class="history-empty">
          No questions yet. Ask something to start a history.
        </div>
        <ul id="historyList" class="history-list"></ul>
      </div>
    </div>
  </section></main><script>
(function() {
  'use strict';

  // DOM elements
  const button = document.getElementById("askBtn");
  const textarea = document.getElementById("question");
  const statusText = document.getElementById("status");
  const answerBox = document.getElementById("answer");
  const photoInput = document.getElementById("photoInput");
  const historyList = document.getElementById("historyList");
  const historyEmpty = document.getElementById("historyEmpty");
  const clearHistoryBtn = document.getElementById("clearHistoryBtn");
  const clarifyButton = document.getElementById("clarifyBtn");
  const clarifyStatus = document.getElementById("clarifyStatus");
  const clarifyBox = document.getElementById("clarify");
  const jobPostArea = document.getElementById("jobPostArea");
  const postJobBtn = document.getElementById("postJobBtn");
  const profileLinkEl = document.getElementById("profileLink");

  // Constants
  const HISTORY_KEY = "homeprohub_history_v1";
  const MAX_HISTORY_ITEMS = 15;
  const MAX_QUESTION_LENGTH = 5000;
  const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

  // State
  let lastQuestion = null;
  let lastImageBase64 = null;
  let lastImageType = null;

  // Utility: Sanitize user input
  function sanitizeInput(input) {
    if (!input || typeof input !== 'string') return '';
    return input.trim().slice(0, MAX_QUESTION_LENGTH);
  }

  // Auth: Get user data
  function getUserData() {
    try {
      const username = localStorage.getItem("homeprohub_username");
      const token = localStorage.getItem("homeprohub_auth_token");
      const role = localStorage.getItem("homeprohub_user_role");

      if (username && token && role === "homeowner") {
        return {
          username: username,
          token: token,
          role: role,
          name: username.split('@')[0] || "User"
        };
      }
      return null;
    } catch (e) {
      return null;
    }
  }

  // Auth: Logout
  function logout() {
    try {
      localStorage.removeItem("homeprohub_username");
      localStorage.removeItem("homeprohub_auth_token");
      localStorage.removeItem("homeprohub_user_role");
      localStorage.removeItem("homeprohub_profile_complete");
      localStorage.removeItem("homeprohub_history_v1");
    } catch (e) {
      // Silent error
    }
    window.location.href = "index.html";
  }
  window.logout = logout;

  // Auth check
  const user = getUserData();
  if (!user) {
    window.location.href = "index.html";
  } else if (profileLinkEl) {
    profileLinkEl.textContent = user.name;
  }

  // Image: Read as base64
  function readImageAsBase64(file) {
    return new Promise((resolve, reject) => {
      if (!file) {
        resolve(null);
        return;
      }

      if (file.size > MAX_FILE_SIZE) {
        reject(new Error('File size exceeds 5MB limit'));
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const result = reader.result;
          const base64 = result.split(",")[1];
          resolve(base64);
        } catch (e) {
          reject(new Error('Failed to process image'));
        }
      };
      reader.onerror = () => reject(new Error('Failed to read image file'));
      reader.readAsDataURL(file);
    });
  }

  // API: Ask backend
  async function askBackend(question, imageBase64, imageType) {
    const sanitizedQuestion = sanitizeInput(question);

    if (!sanitizedQuestion) {
      throw new Error('Question cannot be empty');
    }

    const user = getUserData();
    if (!user) {
      throw new Error('Authentication required');
    }

    const response = await fetch("/ask", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${user.token}`
      },
      body: JSON.stringify({
        question: sanitizedQuestion,
        imageBase64,
        imageType
      })
    });

    if (!response.ok) {
      const data = await response.json().catch(() => ({}));
      throw new Error(data.error || `Request failed (${response.status})`);
    }

    const data = await response.json();
    return data.answer || '';
  }

  // History: Load
  function loadHistory() {
    try {
      const raw = localStorage.getItem(HISTORY_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return [];
      return parsed;
    } catch (e) {
      return [];
    }
  }

  // History: Save
  function saveHistory(history) {
    try {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    } catch (e) {
      // Silent error - history is non-critical
    }
  }

  // History: Add entry
  function addToHistory(question, answer) {
    try {
      const history = loadHistory();
      const entry = {
        question: sanitizeInput(question),
        answer: sanitizeInput(answer),
        timestamp: new Date().toISOString()
      };
      history.unshift(entry);
      const trimmed = history.slice(0, MAX_HISTORY_ITEMS);
      saveHistory(trimmed);
      renderHistory();
    } catch (e) {
      // Silent error
    }
  }

  // History: Render
  function renderHistory() {
    try {
      const history = loadHistory();
      historyList.innerHTML = "";

      if (!history.length) {
        historyEmpty.style.display = "block";
        return;
      }

      historyEmpty.style.display = "none";

      history.forEach((entry) => {
        const li = document.createElement("li");
        li.style.marginBottom = "6px";

        const title = document.createElement("div");
        title.className = "history-item-title";
        const text = entry.question.length > 80
          ? entry.question.slice(0, 80) + "..."
          : entry.question;
        title.textContent = text;

        const time = document.createElement("div");
        time.className = "history-item-time";
        const date = new Date(entry.timestamp);
        time.textContent = date.toLocaleString();

        li.appendChild(title);
        li.appendChild(time);
        historyList.appendChild(li);
      });
    } catch (e) {
      // Silent error
    }
  }

  // History: Clear
  if (clearHistoryBtn) {
    clearHistoryBtn.addEventListener("click", () => {
      try {
        localStorage.removeItem(HISTORY_KEY);
        renderHistory();
      } catch (e) {
        // Silent error
      }
    });
  }

  // Main ask handler
  if (button) {
    button.addEventListener("click", async () => {
      const q = textarea ? textarea.value.trim() : '';

      if (!q) {
        if (answerBox) answerBox.textContent = "Please describe your issue in detail.";
        return;
      }

      if (q.length > MAX_QUESTION_LENGTH) {
        if (answerBox) answerBox.textContent = `Question is too long. Maximum ${MAX_QUESTION_LENGTH} characters.`;
        return;
      }

      // Disable inputs
      button.disabled = true;
      if (clarifyButton) clarifyButton.disabled = true;
      if (textarea) textarea.disabled = true;
      if (photoInput) photoInput.disabled = true;

      if (statusText) statusText.textContent = "Analyzing your issue...";
      if (clarifyStatus) clarifyStatus.textContent = "";
      if (answerBox) answerBox.textContent = "";
      if (jobPostArea) jobPostArea.style.display = 'none';

      try {
        let imageBase64 = null;
        let imageType = null;

        const file = photoInput && photoInput.files ? photoInput.files[0] : null;
        if (file) {
          imageType = file.type;
          imageBase64 = await readImageAsBase64(file);
        }

        const reply = await askBackend(q, imageBase64, imageType);

        if (answerBox) answerBox.textContent = reply;
        if (statusText) statusText.textContent = "Analysis complete.";

        addToHistory(q, reply);

        if (jobPostArea) jobPostArea.style.display = 'block';

        // Save context for clarifications and job posting
        lastQuestion = q;
        lastAIAnswer = reply;
        lastImageBase64 = imageBase64;
        lastImageType = imageType;

      } catch (err) {
        if (answerBox) {
          answerBox.textContent = err.message || "Unable to process your request. Please try again.";
        }
        if (statusText) statusText.textContent = "";
        if (jobPostArea) jobPostArea.style.display = 'none';
      } finally {
        button.disabled = false;
        if (clarifyButton) clarifyButton.disabled = false;
        if (textarea) textarea.disabled = false;
        if (photoInput) photoInput.disabled = false;
      }
    });
  }

  // Clarify handler
  if (clarifyButton) {
    clarifyButton.addEventListener("click", async () => {
      const extra = clarifyBox ? clarifyBox.value.trim() : '';

      if (!lastQuestion) {
        if (clarifyStatus) clarifyStatus.textContent = "Please ask an initial question first.";
        return;
      }

      if (!extra) {
        if (clarifyStatus) clarifyStatus.textContent = "Please provide additional details.";
        return;
      }

      if (extra.length > MAX_QUESTION_LENGTH) {
        if (clarifyStatus) clarifyStatus.textContent = `Clarification is too long. Maximum ${MAX_QUESTION_LENGTH} characters.`;
        return;
      }

      // Disable inputs
      clarifyButton.disabled = true;
      if (button) button.disabled = true;
      if (clarifyBox) clarifyBox.disabled = true;

      if (clarifyStatus) clarifyStatus.textContent = "Updating analysis...";
      if (statusText) statusText.textContent = "";
      if (answerBox) answerBox.textContent = "";
      if (jobPostArea) jobPostArea.style.display = 'none';

      const combinedQuestion =
        `Original description from homeowner:\n` +
        lastQuestion +
        `\n\nNew details / clarifications from homeowner:\n` +
        extra +
        `\n\nPlease update and refine your previous guidance based on these new details. ` +
        `Keep the same structure (summary, severity, urgency, DIY checks, materials, safety, when to call a pro, script). ` +
        `If earlier advice is no longer correct, clearly correct it.`;

      try {
        const reply = await askBackend(combinedQuestion, lastImageBase64, lastImageType);

        if (answerBox) answerBox.textContent = reply;
        if (clarifyStatus) clarifyStatus.textContent = "Analysis updated.";

        addToHistory(combinedQuestion, reply);

        lastQuestion = combinedQuestion;
        lastAIAnswer = reply;
        if (clarifyBox) clarifyBox.value = "";
        if (jobPostArea) jobPostArea.style.display = 'block';

      } catch (err) {
        if (answerBox) {
          answerBox.textContent = err.message || "Unable to update analysis. Please try again.";
        }
        if (clarifyStatus) clarifyStatus.textContent = "";
        if (jobPostArea) jobPostArea.style.display = 'none';
      } finally {
        clarifyButton.disabled = false;
        if (button) button.disabled = false;
        if (clarifyBox) clarifyBox.disabled = false;
      }
    });
  }

  // Post job handler
  let lastAIAnswer = '';

  window.closeJobModal = function() {
    document.getElementById('jobSubmissionModal').style.display = 'none';
    document.getElementById('jobSubmissionForm').reset();
    document.getElementById('jobSubmissionStatus').textContent = '';
  };

  if (postJobBtn) {
    postJobBtn.addEventListener('click', () => {
      if (!lastQuestion || !lastAIAnswer) {
        alert("Please generate a project analysis first.");
        return;
      }

      // Get user profile data
      const userProfile = JSON.parse(localStorage.getItem('homeprohub_user') || '{}');

      // Pre-fill the form
      document.getElementById('jobDescription').value = lastQuestion + '\n\nAI Analysis:\n' + lastAIAnswer;
      document.getElementById('jobZip').value = userProfile.zipCode || '';
      document.getElementById('jobAddress').value = userProfile.address || '';

      // Try to extract budget from AI response (simple approach - look for dollar amounts)
      const dollarMatches = lastAIAnswer.match(/\$[\d,]+/g);
      if (dollarMatches && dollarMatches.length >= 2) {
        const amounts = dollarMatches.map(m => parseInt(m.replace(/[$,]/g, '')));
        document.getElementById('budgetLow').value = Math.min(...amounts);
        document.getElementById('budgetHigh').value = Math.max(...amounts);
      }

      // Show modal
      document.getElementById('jobSubmissionModal').style.display = 'flex';
    });
  }

  // Handle job submission form
  const jobForm = document.getElementById('jobSubmissionForm');
  if (jobForm) {
    jobForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = document.getElementById('submitJobBtn');
      const statusEl = document.getElementById('jobSubmissionStatus');

      const user = getUserData();
      if (!user) {
        statusEl.textContent = 'Authentication required';
        statusEl.style.color = '#ef4444';
        return;
      }

      const jobData = {
        title: document.getElementById('jobTitle').value.trim(),
        description: document.getElementById('jobDescription').value.trim(),
        address: document.getElementById('jobAddress').value.trim(),
        zipCode: document.getElementById('jobZip').value.trim(),
        urgency: document.getElementById('jobUrgency').value,
        budgetLow: parseInt(document.getElementById('budgetLow').value),
        budgetHigh: parseInt(document.getElementById('budgetHigh').value),
        homeownerEmail: user.username,
        originalQuestion: lastQuestion,
        aiAnalysis: lastAIAnswer,
        status: 'open',
        postedAt: new Date().toISOString()
      };

      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      statusEl.textContent = 'Submitting your job to contractors...';
      statusEl.style.color = '#6b7280';

      try {
        const response = await fetch('/api/submit-job', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${user.token}`
          },
          body: JSON.stringify(jobData)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to submit job');
        }

        const result = await response.json();

        statusEl.textContent = '‚úÖ Job posted successfully! Contractors can now view and bid on your project.';
        statusEl.style.color = '#10b981';

        setTimeout(() => {
          closeJobModal();
          // Optionally redirect to a "My Jobs" page
        }, 2000);

      } catch (err) {
        statusEl.textContent = 'Error: ' + (err.message || 'Failed to submit job');
        statusEl.style.color = '#ef4444';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Job Posting';
      }
    });
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', renderHistory);
  renderHistory();

})();
</script>