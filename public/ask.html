<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8" />
  <title>HomeProHub ‚Äì Home Issue Assistant</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .hero {
      max-width: 900px;
      margin: 48px auto 24px;
      padding: 0 24px;
      text-align: center;
    }
    .hero-kicker {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      margin-bottom: 8px;
    }
    .hero-title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.03em;
      margin-bottom: 10px;
      color: #111827;
    }
    .hero-subtitle {
      font-size: 14px;
      line-height: 1.6;
      color: #6b7280;
      max-width: 640px;
      margin: 0 auto;
    }

    .ask-layout {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2.4fr);
      gap: 20px;
    }
    @media (max-width: 860px) {
      .ask-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .small-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
    }

    .history-empty {
      font-size: 12px;
      color: #9ca3af;
    }
    .history-list {
      margin: 8px 0 0 18px;
      padding: 0;
      max-height: 180px;
      overflow-y: auto;
    }
    .history-item-title {
      font-size: 13px;
      color: #111827;
    }
    .history-item-time {
      font-size: 11px;
      color: #9ca3af;
    }
    .clear-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
      color: #6b7280;
      cursor: pointer;
    }
    .clear-btn:hover {
      border-color: #dc2626;
      color: #b91c1c;
    }

    .clarify-label {
      font-size: 12px;
      color: #4b5563;
      margin-top: 16px;
      margin-bottom: 4px;
    }
    .clarify-box {
      width: 100%;
      min-height: 70px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 13px;
      resize: vertical;
    }
  </style></head><body><header class="navbar">
  <div class="nav-inner">
    <div class="brand-area">
      <div class="brand-logo">HH</div>
      <div class="brand-name">HomeProHub</div>
    </div>
    <div class="nav-links">
      <a href="home.html">Dashboard</a>
      <a href="ask.html">Assistant</a>
      <div class="profile-area">
        <a href="user-profile.html" class="profile-link" id="profileLink">Profile</a>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
  </div></header><main>
  <section class="hero">
    <div class="hero-kicker">Home issue assistant</div>
    <h1 class="hero-title">Describe what‚Äôs going on at home.</h1>
    <p class="hero-subtitle">
      Type what you‚Äôre seeing, hearing, or smelling. Add a photo if you can.
      You‚Äôll get a clear summary, severity, urgency, DIY checks, materials you may need,
      safety warnings, and what to tell a contractor.
    </p>
  </section>

  <section style="max-width: 900px; margin: 0 auto 60px; padding: 0 24px;">
    <div class="card">
      <div class="ask-layout">
        <section>
          <label for="question" style="font-size:13px; color:#374151;">Describe the issue in detail</label>
          <textarea
            id="question"
            placeholder="Example: There is a brown stain on my living room ceiling under the upstairs bathroom. It seems to grow slowly after showers, slight musty smell, and the drywall feels a little soft to the touch..."
          ></textarea>

          <div class="small-hint">
            Be specific: location, when it happens, smells, sounds, age of the home,
            any recent work, and how long it‚Äôs been going on.
          </div>

          <label for="photoInput" class="small-hint" style="display:block; margin-top:12px;">
            Optional photo (helps the AI see stains, cracks, etc.):
          </label>
          <input type="file" id="photoInput" accept="image/*" />

          <div style="margin-top:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <button id="askBtn" class="btn-primary">üí¨ Ask HomeProHub AI</button>
            <div id="status" class="status"></div>
          </div>
        </section>

        <aside>
          <div class="history-box">
            <h3 style="margin-top:0; margin-bottom:6px; font-size:15px;">What you‚Äôll get back</h3>
            <ul style="margin: 0 0 0 18px; padding: 0; font-size:13px; color:#4b5563;">
              <li>Summary of what might be happening (plain language)</li>
              <li><strong>Severity</strong> (High / Medium / Low) and <strong>urgency</strong> (Fix now / Fix soon / Monitor)</li>
              <li>DIY-friendly checks you can safely try</li>
              <li>Materials & tools you may need for light DIY work, with example product types and brands</li>
              <li>Clear safety warnings & when to stop</li>
              <li>When to call a pro and what type</li>
              <li>A short script to read or send to a contractor</li>
            </ul>
          </div>
        </aside>
      </div>

      <div id="answer" class="answer-box" style="margin-top:20px;"></div>

      <div style="margin-top:16px;">
        <div class="clarify-label">
          Need to clarify or add something you forgot? Add more detail and get an updated answer:
        </div>
        <textarea
          id="clarify"
          class="clarify-box"
          placeholder="Example: The house was built in 2005, this only happens after long showers, and the stain looks slightly yellow around the edges..."
        ></textarea>
        <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button id="clarifyBtn" class="btn-muted">üîÅ Clarify & update answer</button>
          <div id="clarifyStatus" class="status"></div>
        </div>
      </div>
      
      <div id="jobPostArea" style="margin-top:25px; padding: 20px; border: 1px solid #c7d2fe; border-radius: 12px; background: #f0f7ff; text-align: center; display:none;">
        <h3 style="margin-top: 0; font-size: 18px; color: #2563eb;">Ready to Hire a Pro?</h3>
        <p style="font-size: 14px; color: #4b5563; max-width: 500px; margin: 0 auto 15px;">
          Convert the AI's diagnosis and suggested next steps into a structured job posting. This will instantly push the details out to qualified contractors in your local area (filtered by ZIP code) for them to review and bid.
        </p>
        <button id="postJobBtn" class="btn-primary" style="padding: 10px 20px;">‚úÖ Post This Project to the Contractor Board</button>
      </div>


      <div class="history-box" style="margin-top:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
          <div style="font-size:13px; font-weight:600; color:#111827;">Previous questions on this browser</div>
          <button class="clear-btn" id="clearHistoryBtn">Clear history</button>
        </div>
        <div id="historyEmpty" class="history-empty">
          No questions yet. Ask something to start a history.
        </div>
        <ul id="historyList" class="history-list"></ul>
      </div>
    </div>
  </section></main><script>
  const button = document.getElementById("askBtn");
  const textarea = document.getElementById("question");
  const statusText = document.getElementById("status");
  const answerBox = document.getElementById("answer");
  const photoInput = document.getElementById("photoInput");
  const historyList = document.getElementById("historyList");
  const historyEmpty = document.getElementById("historyEmpty");
  const clearHistoryBtn = document.getElementById("clearHistoryBtn");

  // --- NEW ELEMENT SELECTORS ---
  const clarifyButton = document.getElementById("clarifyBtn");
  const clarifyStatus = document.getElementById("clarifyStatus");
  const clarifyBox = document.getElementById("clarify");
  const jobPostArea = document.getElementById("jobPostArea");
  const postJobBtn = document.getElementById("postJobBtn");
  // -----------------------------

  const profileLinkEl = document.getElementById("profileLink");
  const HISTORY_KEY = "homeprohub_history_v1";

  // --- AUTH/NAV SCRIPT START ---
  function getUserData() {
    try {
      // Check for the role (set by role selection page) AND the session ID
      const role = localStorage.getItem("homeprohub_user_role");
      const sessionId = localStorage.getItem("homeprohub_session_id");

      if (role && sessionId) {
          return { role: role, name: localStorage.getItem("homeprohub_user_name") || "User" };
      }
      return null; 
    } catch (e) {
      return null;
    }
  }
// ... (rest of the script)

  const user = getUserData();
  if (user && user.name) {
    profileLinkEl.textContent = user.name.split(' ')[0];
  } else {
    window.location.href = "index.html"; 
  }

  function logout() {
    localStorage.removeItem("homeprohub_user");
    localStorage.removeItem("homeprohub_history_v1");
    window.location.href = "index.html";
  }
  // --- AUTH/NAV SCRIPT END ---


  function readImageAsBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const result = reader.result;
        const base64 = result.split(",")[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function askBackend(question, imageBase64, imageType) {
    const response = await fetch("http://localhost:3000/ask", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ question, imageBase64, imageType })
    });

    if (!response.ok) {
      const data = await response.json().catch(() => ({}));
      throw new Error(
        data.error || "Request failed with status " + response.status
      );
    }

    const data = await response.json();
    return data.answer;
  }

  // Store last context for refinements
  let lastQuestion = null;
  let lastImageBase64 = null;
  let lastImageType = null;


  function loadHistory() {
    try {
      const raw = localStorage.getItem(HISTORY_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return [];
      return parsed;
    } catch (e) {
      console.warn("Failed to read history:", e);
      return [];
    }
  }

  function saveHistory(history) {
    try {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    } catch (e) {
      console.error("Failed to save history:", e);
    }
  }

  function addToHistory(question, answer) {
    const history = loadHistory();
    const entry = { question, answer, timestamp: new Date().toISOString() };
    history.unshift(entry);
    const trimmed = history.slice(0, 15);
    saveHistory(trimmed);
    renderHistory();
  }

  function renderHistory() {
    const history = loadHistory();
    historyList.innerHTML = "";

    if (!history.length) {
      historyEmpty.style.display = "block";
      return;
    } else {
      historyEmpty.style.display = "none";
    }

    history.forEach((entry) => {
      const li = document.createElement("li");
      li.style.marginBottom = "6px";

      const title = document.createElement("div");
      title.className = "history-item-title";
      const text =
        entry.question.length > 80
          ? entry.question.slice(0, 80) + "..."
          : entry.question;
      title.textContent = "‚Äú" + text + "‚Äù";

      const time = document.createElement("div");
      time.className = "history-item-time";
      const date = new Date(entry.timestamp);
      time.textContent = date.toLocaleString();

      li.appendChild(title);
      li.appendChild(time);
      historyList.appendChild(li);
    });
  }

  clearHistoryBtn.addEventListener("click", () => {
    localStorage.removeItem(HISTORY_KEY);
    renderHistory();
  });

  button.addEventListener("click", async () => {
    const q = textarea.value.trim();

    if (!q) {
      answerBox.textContent = "Please type your question first.";
      return;
    }

    button.disabled = true;
    clarifyButton.disabled = true;
    statusText.textContent = "Thinking‚Ä¶";
    clarifyStatus.textContent = "";
    answerBox.textContent = "";
    jobPostArea.style.display = 'none'; // Hide if asking a new question

    try {
      let imageBase64 = null;
      let imageType = null;

      const file = photoInput.files[0];
      if (file) {
        imageType = file.type;
        imageBase64 = await readImageAsBase64(file);
      }

      const reply = await askBackend(q, imageBase64, imageType);
      answerBox.textContent = reply;
      statusText.textContent = "Done.";
      addToHistory(q, reply);

      // --- CRITICAL FIX: SHOW THE POST JOB BUTTON BLOCK HERE ---
      jobPostArea.style.display = 'block'; 
      // --------------------------------------------------------

      // Save context for clarifications
      lastQuestion = q;
      lastImageBase64 = imageBase64;
      lastImageType = imageType;
    } catch (err) {
      console.error(err);
      answerBox.textContent = "Something went wrong: " + err.message;
      statusText.textContent = "";
      jobPostArea.style.display = 'none'; // Hide if there was an error
    } finally {
      button.disabled = false;
      clarifyButton.disabled = false;
    }
  });

  clarifyButton.addEventListener("click", async () => {
    const extra = clarifyBox.value.trim();

    if (!lastQuestion) {
      clarifyStatus.textContent = "Ask a first question before refining.";
      return;
    }

    if (!extra) {
      clarifyStatus.textContent = "Add some new details or clarifications first.";
      return;
    }

    clarifyButton.disabled = true;
    button.disabled = true;
    clarifyStatus.textContent = "Updating with your new details‚Ä¶";
    statusText.textContent = "";
    answerBox.textContent = "";
    jobPostArea.style.display = 'none'; // Hide when refining

    const combinedQuestion =
      `Original description from homeowner:\n` +
      lastQuestion +
      `\n\nNew details / clarifications from homeowner:\n` +
      extra +
      `\n\nPlease update and refine your previous guidance based on these new details. ` +
      `Keep the same structure (summary, severity, urgency, DIY checks, materials, safety, when to call a pro, script). ` +
      `If earlier advice is no longer correct, clearly correct it.`;

    try {
      const reply = await askBackend(
        combinedQuestion,
        lastImageBase64,
        lastImageType
      );
      answerBox.textContent = reply;
      clarifyStatus.textContent = "Updated.";
      addToHistory(combinedQuestion, reply);
      lastQuestion = combinedQuestion;
      clarifyBox.value = "";
      jobPostArea.style.display = 'block'; // Show again after successful update
    } catch (err) {
      console.error(err);
      answerBox.textContent = "Something went wrong: " + err.message;
      clarifyStatus.textContent = "";
      jobPostArea.style.display = 'none'; 
    } finally {
      clarifyButton.disabled = false;
      button.disabled = false;
    }
  });

  postJobBtn.addEventListener('click', () => {
      if (lastQuestion) {
          // Instead of redirecting to the bid board, redirect to the paid contact CTA page
          alert("Project details saved! Directing you to contact options.");
          window.location.href = 'urgent-contact-cta.html'; 
      } else {
          alert("Please generate a project plan or diagnosis first.");
      }
  });


  document.addEventListener('DOMContentLoaded', renderHistory);
</script>